javascript:(function(){ if (window.__ixlHelperInjected) return; window.__ixlHelperInjected = true; var API_KEY = 'AIzaSyCQtxFQpH9hX_9USuv2dsDDYafZOrqvcMo'; var defaultSettings = { theme: "Midnight", model: "gemini-2.5-flash-lite", copyKey: "c", toggleKey: "Tab", prependMessage: "CRITICAL: Respond with ONLY the exact answer text. NOTHING else. No explanations, no context, no repeating the question, no listing options, no passage text.\n\nRules:\n- Multiple choice: ONLY the exact text of the correct option\n- Math: ONLY the number or expression\n- Yes/No: ONLY yes or no\n- Select all that apply: ONLY correct answers, one per line\n- Table questions: ONLY row: column selections\n- Fill in blank: ONLY the word or phrase\n\nYour ENTIRE response must be the answer and nothing else.", prependPresets: { "Expert Tutor (Default)": "CRITICAL: Respond with ONLY the exact answer text. NOTHING else. No explanations, no context, no repeating the question, no listing options, no passage text.\n\nRules:\n- Multiple choice: ONLY the exact text of the correct option\n- Math: ONLY the number or expression\n- Yes/No: ONLY yes or no\n- Select all that apply: ONLY correct answers, one per line\n- Table questions: ONLY row: column selections\n- Fill in blank: ONLY the word or phrase\n\nYour ENTIRE response must be the answer and nothing else.", "Simple & Direct": "Answer the question with ONLY the exact text of the correct choice. No explanations.", "Grammar Focus": "You are a grammar expert. Choose the grammatically correct option. For complete sentence questions, pick the sentence that follows proper grammar rules. For run-on questions, identify comma splices and fragments. Answer with only the exact text choice.", "Math Specialist": "STOP. READ CAREFULLY.\n\nFor COMPLEMENTARY angles: Find the angle that adds with the given angle to make 90°.\nFor SUPPLEMENTARY angles: Find the angle that adds with the given angle to make 180°.\nFor VERTICAL angles: Find the angle directly opposite when lines intersect.\n\nLook at the answer choices. Pick the ONE angle name that matches the geometric relationship.\n\nExample: If choices are A, B, C, D and you need complementary to AFB, check which angle forms 90° with AFB.\n\nGive ONLY the letter answer or angle name. Nothing else.", "Reading Comprehension": "Base your answer ONLY on the passage provided. Do not use outside knowledge. Find evidence in the text. For main idea questions, look for the central theme. For detail questions, find specific information. Answer with exact choice text.", "Science Expert": "Use scientific facts and principles. For physics: apply formulas correctly. For biology: use classification and processes. For chemistry: consider reactions and properties. Answer with exact choice text only.", "Test Taking Mode": "Read carefully. Eliminate wrong answers. Look for key words. Double-check your reasoning. Provide ONLY the exact answer text with same capitalization as shown.", "Geometry Expert": "You are solving angle problems. CRITICAL RULES:\n\n1. COMPLEMENTARY = angles that add to 90°\n2. SUPPLEMENTARY = angles that add to 180°\n3. VERTICAL = opposite angles when lines cross\n4. MEASUREMENT = read protractor carefully\n\nFor PROTRACTOR questions:\n- Look at where the angle rays meet the scale\n- Use the correct scale (inner/outer numbers)\n- Give the exact degree number\n\nDO NOT explain. Give ONLY the answer (angle name or degree number).", "Protractor Expert": "PROTRACTOR READING - CRITICAL RULES:\n\n?? MOST IXL PROTRACTORS SHOW ACUTE ANGLES (20°-80°)\n\n1. Find the protractor CENTER (small dot/circle)\n2. Identify the BASELINE ray (usually horizontal or at 0°)\n3. Find where the OTHER ray crosses the NUMBER SCALE\n4. Read the SMALLER number if you see two options\n5. Common angles: 30°, 35°, 45°, 60°, 75°\n\n? AVOID: 120°, 135°, 150° (these are usually wrong scale)\n? PREFER: Numbers between 20°-80°\n\nGive ONLY the number (like '35').", "Table Expert": "TABLE/CHECKLIST QUESTION EXPERT\n\nFor table questions with checkboxes/radio buttons:\n1. Read each row carefully\n2. Determine which column category each row belongs to\n3. List your answers clearly\n\nFormat your response as:\nRow 1: Column Name\nRow 2: Column Name\nRow 3: Column Name\n\nExample:\nThe king forced colonists to house soldiers: Military\nThe king cut off trade: Economic\nThe king denied trials: Judicial\n\nBe precise and concise.", "Custom": "" }, autoHighlight: false, autoSelect: false, autoSubmit: false, autoDetect: false, selectionDelay: 3, submitDelay: 5, fillInBlank: false, highlightColor: "#00aaff", highlightOpacity: 0.15, rainbowHighlight: false, pulseHighlight: true, underlineHighlight: false, outlineHighlight: false, multiAnswerHighlight: false, stealthHighlightMode: "off", stealthHighlightStrength: 35, autoCopy: false, copyMode: "standard", showFloatingButton: true, showQuickCopyButton: true, autoHideSideButtons: true, sideButtonTransparency: 0, gradientEnabled: false, backgroundTransparency: 0, panelTransparency: 0, animatedBackground: false, fontStyle: "system", fontWeight: "regular", hideWhileIdle: false, lockPosition: false, stealthMode: false, mirrorMode: false, mirrorMatchSite: true, notebookMode: false, dimMode: false, stealthFadeIntensity: 40, widgetMode: false, frozenOverlay: false, safeWindowMode: false, hideOutgoingMessages: false, showQuestionCounter: true, showRemainingCounter: true, themeScope: "full", btnPos: { top: "20px", left: "20px" }, panelPos: { top: "85px", left: "20px" }, customThemes: {}, removedThemes: {}, customPrepends: {}, removedPrepends: {}, themes: { Midnight: { bg: "#0a0a0a", surface: "#1a1a1a", elevated: "#2a2a2a", text: "#ffffff", subtext: "#b0b0b0", border: "#333333", accent: "#00d4ff", accentHover: "#33dfff", success: "#00ff88", error: "#ff4444", gradientFrom: "#0f172a", gradientTo: "#1f2937" }, Nord: { bg: "#2e3440", surface: "#3b4252", elevated: "#434c5e", text: "#d8dee9", subtext: "#e5e9f0", border: "#4c566a", accent: "#88c0d0", accentHover: "#8fbcbb", success: "#a3be8c", error: "#bf616a", gradientFrom: "#2e3440", gradientTo: "#4c566a" }, Latte: { bg: "#eff1f5", surface: "#e6e9ef", elevated: "#dce0e8", text: "#4c4f69", subtext: "#5c5f77", border: "#ccd0da", accent: "#1e66f5", accentHover: "#4082f7", success: "#40a02b", error: "#d20f39", gradientFrom: "#f2f4f8", gradientTo: "#e1e7f5" }, Ocean: { bg: "#0c1445", surface: "#1a237e", elevated: "#283593", text: "#e8eaf6", subtext: "#c5cae9", border: "#3949ab", accent: "#00bcd4", accentHover: "#26c6da", success: "#4caf50", error: "#f44336", gradientFrom: "#0c1445", gradientTo: "#1b2b7d" }, Forest: { bg: "#1b2e1b", surface: "#2e4a2e", elevated: "#3d5a3d", text: "#e8f5e8", subtext: "#c8e6c8", border: "#4caf50", accent: "#8bc34a", accentHover: "#9ccc65", success: "#4caf50", error: "#f44336", gradientFrom: "#1b2e1b", gradientTo: "#3b5d3b" }, Sunset: { bg: "#2d1b2e", surface: "#4a2c4a", elevated: "#5d3a5d", text: "#f8e8f8", subtext: "#e8c8e8", border: "#9c27b0", accent: "#e91e63", accentHover: "#f06292", success: "#4caf50", error: "#f44336", gradientFrom: "#33152f", gradientTo: "#552454" }, Cyber: { bg: "#0a0a0a", surface: "#1a1a1a", elevated: "#2a2a2a", text: "#00ff00", subtext: "#00cc00", border: "#333333", accent: "#00ffff", accentHover: "#33ffff", success: "#00ff00", error: "#ff0000", gradientFrom: "#050505", gradientTo: "#111111" }, Royal: { bg: "#1a0d2e", surface: "#2d1b4e", elevated: "#3d2a5d", text: "#f0e6ff", subtext: "#d9c7ff", border: "#6a4c93", accent: "#9c27b0", accentHover: "#ba68c8", success: "#4caf50", error: "#f44336", gradientFrom: "#1d1035", gradientTo: "#3a2166" } } }; const ACCESS_PROFILE = 'locked'; const LOCKED_ACCESS_CODES = { chaseboss: { label: 'chaseboss', limit: Infinity, apiKey: 'AIzaSyCrjsNv1gc8EQqPb9CJZrWG8r18TQSq4Fg' }, rachaelbajablast: { label: 'rachaelbajablast', limit: Infinity, apiKey: 'AIzaSyCGiHNZcUZobQga-zwLJP-ZMGBviQoqo5s' }, owneraiden: { label: 'owneraiden', limit: Infinity, apiKey: 'AIzaSyC7KWUqC4WQehmP2kHVDxRyRUr1wMBdNTY' }, grant: { label: 'grant', limit: Infinity, apiKey: 'AIzaSyCDpQyyjeCP4mFRldHgNnq7LnvMxlZN8dk' } }; const ACCESS_WINDOW_MS = 2 * 60 * 60 * 1000; const SITE_DEFINITIONS = [ { key: "ixl", title: "IXL Helper", matches: [/^(?:[a-z0-9-]+\.)*ixl\.com$/i], toolsTab: { id: "ixl-tools", label: "IXL Tools" }, features: { automation: true, autoDetect: true } }, { key: "blackboard", title: "Blackboard Helper", matches: [/^(?:[a-z0-9-]+\.)*blackboard\.com$/i], toolsTab: { id: "blackboard-tools", label: "Blackboard Tools" }, features: { automation: true, autoDetect: true } }, { key: "vocabulary", title: "Vocabulary Helper", matches: [/^(?:[a-z0-9-]+\.)*vocabulary\.com$/i], toolsTab: { id: "vocabulary-tools", label: "Vocabulary Tools" }, features: { automation: true, autoDetect: true } }, { key: "wayground", title: "Wayground Helper", matches: [/^(?:[a-z0-9-]+\.)*wayground\.com$/i], toolsTab: { id: "wayground-tools", label: "Wayground Tools" }, features: { automation: true, autoDetect: true } } ]; const DEFAULT_SITE = { key: "generic", title: "Universal Helper", toolsTab: null, features: { automation: false, autoDetect: false } }; const COMMON_SCOPE_SELECTORS = [ ".q-content", ".question-view", ".question-body", "section[data-question-id]", ".question-wrapper", ".question-container", ".practice-question", ".practice-area", ".practice-main", ".questionContent", ".question.typeP", ".question[data-template]", ".assessment-question", ".question", ".options-grid", "main" ]; const SITE_SCOPE_SELECTORS = { ixl: [ '.focused-practice-area', '.practice-area', '.practice-main', '.practice-question', '.practice-problem', '.question-wrapper' ], blackboard: ["bb-assessment-question", "bb-assessment-question form", ".assessment-question-container", ".multiple-answer-answers-container", ".multiple-answer-answers", "form[name=\"assessmentQuestionForm\"]", ".panel-content-full .assessment-question", "bb-assessment-attempt .assessment-question", "[data-question-id]", ".question-body", ".assessment-question"], vocabulary: [ ".question.typeP", ".questionContent", ".question", ".question-area" ], wayground: [ "[data-testid=\"question-container-text\"]", "#questionText", "[data-cy=\"text-container\"]", ".question-text-color", ".options-grid", '.options-grid [role="option"]', ".options-grid .option", "[data-cy^=\"option-\"]", ".question-card", "main .flex" ] }; function detectActiveSite() { var host = window.location.hostname.toLowerCase(); for (var i = 0; i < SITE_DEFINITIONS.length; i++) { var site = SITE_DEFINITIONS[i]; if (site.matches.some(function (rx) { return rx.test(host); })) { return site; } } return DEFAULT_SITE; } const ACTIVE_SITE = detectActiveSite(); function isLockedProfile() { return (ACCESS_PROFILE || '').toLowerCase() === 'locked'; } function resolveAccessCode(rawCode) { if (!rawCode) return null; var normalized = String(rawCode).trim().toLowerCase(); if (!normalized) return null; var entry = LOCKED_ACCESS_CODES[normalized]; if (!entry) return null; return { key: normalized, label: entry.label, limit: entry.limit, apiKey: entry.apiKey || null }; } function loadUsageState() { var fallback = { code: '', windowStart: 0, used: 0 }; if (!isLockedProfile()) return fallback; try { var raw = JSON.parse(localStorage.getItem('ixlHelperUsageProfiles') || '{}') || {}; var stored = raw[ACCESS_PROFILE] || {}; var code = typeof stored.code === 'string' ? stored.code : ''; var windowStart = typeof stored.windowStart === 'number' ? stored.windowStart : 0; var used = typeof stored.used === 'number' ? Math.max(0, Math.floor(stored.used)) : 0; return { code: code, windowStart: windowStart, used: used }; } catch (err) { return fallback; } } function saveUsageState(state) { if (!isLockedProfile()) return; var payload = { code: state && typeof state.code === 'string' ? state.code : '', windowStart: state && typeof state.windowStart === 'number' ? state.windowStart : Date.now(), used: state && typeof state.used === 'number' ? Math.max(0, Math.floor(state.used)) : 0 }; try { var raw = JSON.parse(localStorage.getItem('ixlHelperUsageProfiles') || '{}') || {}; raw[ACCESS_PROFILE] = payload; localStorage.setItem('ixlHelperUsageProfiles', JSON.stringify(raw)); } catch (err) {} } function loadQuestionStats() { try { var stored = JSON.parse(localStorage.getItem('ixlHelperQuestionStats') || '{}') || {}; var total = typeof stored.totalAnswered === 'number' && stored.totalAnswered >= 0 ? Math.floor(stored.totalAnswered) : 0; return { totalAnswered: total }; } catch (err) { return { totalAnswered: 0 }; } } function saveQuestionStats(stats) { var total = stats && typeof stats.totalAnswered === 'number' ? Math.max(0, Math.floor(stats.totalAnswered)) : 0; try { localStorage.setItem('ixlHelperQuestionStats', JSON.stringify({ totalAnswered: total })); } catch (err) {} } function formatDuration(ms) { if (!ms || ms <= 0) return '0m'; var totalSeconds = Math.ceil(ms / 1000); var hours = Math.floor(totalSeconds / 3600); var minutes = Math.floor((totalSeconds % 3600) / 60); var seconds = totalSeconds % 60; if (hours > 0 && minutes > 0) return hours + 'h ' + minutes + 'm'; if (hours > 0) return hours + 'h'; if (minutes > 0) return minutes + 'm'; return seconds + 's'; } var MIRROR_STYLES = { ixl: { bg: "#f5f7fb", text: "#1f2b4d", accent: "#0093d0" }, blackboard: { bg: "#1e1e1e", text: "#f4f4f4", accent: "#4f8cff" }, vocabulary: { bg: "#f8f1e3", text: "#2e2719", accent: "#7a5b2c" }, wayground: { bg: "#101826", text: "#f9fafb", accent: "#38bdf8" }, generic: { bg: "#f1f1f1", text: "#1f2933", accent: "#3a7afe" } }; function deepClone(value) { if (value === undefined) return undefined; return JSON.parse(JSON.stringify(value)); } function isDefaultTheme(name) { return Object.prototype.hasOwnProperty.call(defaultSettings.themes, name); } function isDefaultPreset(name) { return Object.prototype.hasOwnProperty.call(defaultSettings.prependPresets, name); } function buildThemeLibrary(settings) { var library = {}; var removed = settings.removedThemes || {}; Object.keys(defaultSettings.themes).forEach(function (name) { if (!removed[name]) library[name] = deepClone(defaultSettings.themes[name]); }); var custom = settings.customThemes || {}; Object.keys(custom).forEach(function (name) { if (!custom[name] || removed[name]) return; library[name] = deepClone(custom[name]); }); if (!Object.keys(library).length) { library.Midnight = deepClone(defaultSettings.themes.Midnight); if (settings.removedThemes) delete settings.removedThemes.Midnight; } return library; } function buildPrependLibrary(settings) { var library = {}; var removed = settings.removedPrepends || {}; Object.keys(defaultSettings.prependPresets).forEach(function (name) { if (!removed[name]) library[name] = defaultSettings.prependPresets[name]; }); var custom = settings.customPrepends || {}; Object.keys(custom).forEach(function (name) { if (custom[name] === null || custom[name] === undefined || removed[name]) return; library[name] = custom[name]; }); if (!Object.keys(library).length) { library.Custom = ""; if (settings.removedPrepends) delete settings.removedPrepends.Custom; } return library; } function refreshComputedSettings(settings) { settings.themes = buildThemeLibrary(settings); settings.prependPresets = buildPrependLibrary(settings); } function sanitizeSettingsForSave(settings) { var copy = deepClone(settings) || {}; delete copy.themes; delete copy.prependPresets; return copy; } function ensurePlainObject(value) { return value && typeof value === "object" ? deepClone(value) : {}; } function areObjectsEqual(a, b) { if (a === b) return true; if (!a || !b) return false; try { return JSON.stringify(a) === JSON.stringify(b); } catch (e) { return false; } } function clampTransparency(value, fallback) { var base = typeof fallback === "number" ? fallback : 0; if (value === undefined || value === null) return base; var parsed = parseFloat(value); if (isNaN(parsed)) return base; return Math.max(0, Math.min(100, Math.round(parsed))); } function clampFadeIntensity(value, fallback) { var base = typeof fallback === "number" ? fallback : defaultSettings.stealthFadeIntensity; if (value === undefined || value === null) return Math.max(0, Math.min(100, base)); var parsed = parseFloat(value); if (isNaN(parsed)) return Math.max(0, Math.min(100, base)); return Math.max(0, Math.min(100, Math.round(parsed))); } function convertHexToRgba(color, alpha) { var fallbackAlpha = typeof alpha === "number" ? alpha : 1; var normalizedAlpha = Math.max(0, Math.min(1, fallbackAlpha)); if (!color || typeof color !== "string") { return "rgba(0,0,0," + normalizedAlpha + ")"; } var ctx = convertHexToRgba._ctx; if (!ctx) { var canvas = document.createElement("canvas"); convertHexToRgba._ctx = canvas.getContext && canvas.getContext("2d"); ctx = convertHexToRgba._ctx; } var parsed = color.trim(); if (ctx) { try { ctx.fillStyle = "#000"; ctx.fillStyle = parsed; parsed = ctx.fillStyle || parsed; } catch (err) { parsed = parsed || "#000"; } } if (!parsed) { return "rgba(0,0,0," + normalizedAlpha + ")"; } if (parsed[0] === "#") { var value = parsed.slice(1); if (value.length === 3) { value = value[0] + value[0] + value[1] + value[1] + value[2] + value[2]; } if (value.length === 6) { var r = parseInt(value.slice(0, 2), 16); var g = parseInt(value.slice(2, 4), 16); var b = parseInt(value.slice(4, 6), 16); if (!isNaN(r) && !isNaN(g) && !isNaN(b)) { return "rgba(" + r + "," + g + "," + b + "," + normalizedAlpha + ")"; } } } var rgbMatch = parsed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if (rgbMatch) { var rVal = parseInt(rgbMatch[1], 10); var gVal = parseInt(rgbMatch[2], 10); var bVal = parseInt(rgbMatch[3], 10); if (!isNaN(rVal) && !isNaN(gVal) && !isNaN(bVal)) { return "rgba(" + rVal + "," + gVal + "," + bVal + "," + normalizedAlpha + ")"; } } return "rgba(0,0,0," + normalizedAlpha + ")"; } function getContrastColor(hex) { if (!hex || typeof hex !== "string") return "#06121e"; var value = hex.replace(/^#/, ""); if (value.length === 3) { value = value[0] + value[0] + value[1] + value[1] + value[2] + value[2]; } if (value.length !== 6) return "#06121e"; var r = parseInt(value.slice(0, 2), 16); var g = parseInt(value.slice(2, 4), 16); var b = parseInt(value.slice(4, 6), 16); if (isNaN(r) || isNaN(g) || isNaN(b)) return "#06121e"; var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.55 ? "#08111d" : "#ffffff"; } function computePanelSurfaces(theme, settings) { var normalizedBackground = clampTransparency( settings.backgroundTransparency, defaultSettings.backgroundTransparency ); var normalizedPanel = clampTransparency( settings.panelTransparency, defaultSettings.panelTransparency ); var backgroundOpacity = 1 - normalizedBackground / 100; var panelOpacity = 1 - normalizedPanel / 100; var gradientFrom = theme.gradientFrom || theme.bg || "#0a0a0a"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg || gradientFrom; var surface = theme.surface || theme.bg || gradientFrom; var elevated = theme.elevated || surface; var border = theme.border || gradientFrom; var gradientPanelBg = "linear-gradient(135deg, " + convertHexToRgba(gradientFrom, panelOpacity) + ", " + convertHexToRgba(gradientTo, panelOpacity) + ")"; return { values: { backgroundTransparency: normalizedBackground, panelTransparency: normalizedPanel, backgroundOpacity: backgroundOpacity, panelOpacity: panelOpacity }, panelBg: settings.gradientEnabled ? gradientPanelBg : convertHexToRgba(surface, panelOpacity), headerBg: convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.05)), footerBg: convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.1)), border: convertHexToRgba(border, Math.min(1, panelOpacity + 0.35)), solidBackground: convertHexToRgba(theme.bg || gradientFrom, backgroundOpacity), gradientBackground: "linear-gradient(135deg, " + convertHexToRgba(gradientFrom, backgroundOpacity) + ", " + convertHexToRgba(gradientTo, backgroundOpacity) + ")" }; } function resolveFontFamily(style) { switch ((style || "").toLowerCase()) { case "clean": return "'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"; case "rounded": return "'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"; default: return "system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"; } } function resolveFontImport(style) { switch ((style || "").toLowerCase()) { case "clean": return "@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');"; case "rounded": return "@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');"; default: return ""; } } function resolveFontWeights(weightSetting) { switch ((weightSetting || "").toLowerCase()) { case "light": return { body: "300", heading: "500", strong: "600" }; case "bold": return { body: "500", heading: "700", strong: "700" }; case "mixed": return { body: "300", heading: "700", strong: "600" }; default: return { body: "400", heading: "600", strong: "600" }; } } function updateHighlightAttributeFlags(settings) { if (!document || !document.body) return; var mode = settings.underlineHighlight ? "underline" : settings.outlineHighlight ? "outline" : "fill"; document.body.setAttribute("data-ixl-highlight-mode", mode); document.body.setAttribute("data-ixl-pulse", settings.pulseHighlight === false ? "off" : "on"); var stealthMode = (settings.stealthHighlightMode || "off").toString().toLowerCase(); document.body.setAttribute("data-ixl-stealth-highlight", stealthMode); } var ICONS = { CHAT:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>', SETTINGS:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>', CLOSE:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>', BACK:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>', SEND:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>', COPY:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>', ATTACH:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>', PENCIL:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>', TRASH:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>', PLUS:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>', DUPLICATE:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9"></path></svg>' }; function loadSettings() { var storedSettings = {}; try { storedSettings = JSON.parse(localStorage.getItem("ixlHelperSettings") || "{}") || {}; } catch (err) { storedSettings = {}; } var parsedHighlight = defaultSettings.highlightOpacity; if (storedSettings.highlightOpacity !== undefined) { var highlightNumber = parseFloat(storedSettings.highlightOpacity); if (!isNaN(highlightNumber)) { parsedHighlight = Math.max(0, Math.min(1, highlightNumber)); } } var derivedAutoHide = storedSettings.autoHideSideButtons; if (derivedAutoHide === undefined) { if (storedSettings.showFloatingButton === false || storedSettings.showQuickCopyButton === false) { derivedAutoHide = true; } } var sideTransparency = clampTransparency( storedSettings.sideButtonTransparency, defaultSettings.sideButtonTransparency ); var fadeIntensity = clampFadeIntensity( storedSettings.stealthFadeIntensity, defaultSettings.stealthFadeIntensity ); var settings = { model: storedSettings.model || defaultSettings.model, theme: storedSettings.theme || defaultSettings.theme, copyKey: storedSettings.copyKey || defaultSettings.copyKey, toggleKey: storedSettings.toggleKey || defaultSettings.toggleKey, prependMessage: storedSettings.prependMessage || defaultSettings.prependMessage, autoHighlight: storedSettings.autoHighlight !== undefined ? storedSettings.autoHighlight : defaultSettings.autoHighlight, autoSelect: storedSettings.autoSelect !== undefined ? storedSettings.autoSelect : defaultSettings.autoSelect, autoSubmit: storedSettings.autoSubmit !== undefined ? storedSettings.autoSubmit : defaultSettings.autoSubmit, autoDetect: storedSettings.autoDetect !== undefined ? storedSettings.autoDetect : defaultSettings.autoDetect, selectionDelay: storedSettings.selectionDelay !== undefined ? storedSettings.selectionDelay : defaultSettings.selectionDelay, submitDelay: storedSettings.submitDelay !== undefined ? storedSettings.submitDelay : defaultSettings.submitDelay, fillInBlank: storedSettings.fillInBlank !== undefined ? storedSettings.fillInBlank : defaultSettings.fillInBlank, highlightColor: storedSettings.highlightColor || defaultSettings.highlightColor, highlightOpacity: parsedHighlight, rainbowHighlight: storedSettings.rainbowHighlight !== undefined ? storedSettings.rainbowHighlight : defaultSettings.rainbowHighlight, pulseHighlight: storedSettings.pulseHighlight !== undefined ? !!storedSettings.pulseHighlight : defaultSettings.pulseHighlight, underlineHighlight: storedSettings.underlineHighlight !== undefined ? !!storedSettings.underlineHighlight : defaultSettings.underlineHighlight, outlineHighlight: storedSettings.outlineHighlight !== undefined ? !!storedSettings.outlineHighlight : defaultSettings.outlineHighlight, multiAnswerHighlight: storedSettings.multiAnswerHighlight !== undefined ? !!storedSettings.multiAnswerHighlight : defaultSettings.multiAnswerHighlight, stealthHighlightMode: storedSettings.stealthHighlightMode || defaultSettings.stealthHighlightMode, stealthHighlightStrength: clampTransparency( storedSettings.stealthHighlightStrength, defaultSettings.stealthHighlightStrength ), autoCopy: storedSettings.autoCopy !== undefined ? storedSettings.autoCopy : defaultSettings.autoCopy, copyMode: storedSettings.copyMode === "advanced" ? "advanced" : defaultSettings.copyMode, showFloatingButton: true, showQuickCopyButton: true, autoHideSideButtons: derivedAutoHide !== undefined ? !!derivedAutoHide : defaultSettings.autoHideSideButtons, sideButtonTransparency: sideTransparency, gradientEnabled: storedSettings.gradientEnabled !== undefined ? storedSettings.gradientEnabled : defaultSettings.gradientEnabled, animatedBackground: storedSettings.animatedBackground !== undefined ? !!storedSettings.animatedBackground : defaultSettings.animatedBackground, backgroundTransparency: clampTransparency( storedSettings.backgroundTransparency, defaultSettings.backgroundTransparency ), panelTransparency: clampTransparency( storedSettings.panelTransparency, defaultSettings.panelTransparency ), themeScope: storedSettings.themeScope || defaultSettings.themeScope, fontStyle: storedSettings.fontStyle || defaultSettings.fontStyle, fontWeight: storedSettings.fontWeight || defaultSettings.fontWeight, hideWhileIdle: storedSettings.hideWhileIdle !== undefined ? !!storedSettings.hideWhileIdle : defaultSettings.hideWhileIdle, lockPosition: storedSettings.lockPosition !== undefined ? !!storedSettings.lockPosition : defaultSettings.lockPosition, stealthMode: storedSettings.stealthMode !== undefined ? !!storedSettings.stealthMode : defaultSettings.stealthMode, mirrorMode: storedSettings.mirrorMode !== undefined ? !!storedSettings.mirrorMode : defaultSettings.mirrorMode, mirrorMatchSite: storedSettings.mirrorMatchSite !== undefined ? !!storedSettings.mirrorMatchSite : defaultSettings.mirrorMatchSite, notebookMode: storedSettings.notebookMode !== undefined ? !!storedSettings.notebookMode : defaultSettings.notebookMode, dimMode: storedSettings.dimMode !== undefined ? !!storedSettings.dimMode : defaultSettings.dimMode, stealthFadeIntensity: fadeIntensity, widgetMode: storedSettings.widgetMode !== undefined ? !!storedSettings.widgetMode : defaultSettings.widgetMode, frozenOverlay: storedSettings.frozenOverlay !== undefined ? !!storedSettings.frozenOverlay : defaultSettings.frozenOverlay, safeWindowMode: storedSettings.safeWindowMode !== undefined ? !!storedSettings.safeWindowMode : defaultSettings.safeWindowMode, hideOutgoingMessages: storedSettings.hideOutgoingMessages !== undefined ? !!storedSettings.hideOutgoingMessages : defaultSettings.hideOutgoingMessages, showQuestionCounter: storedSettings.showQuestionCounter !== undefined ? !!storedSettings.showQuestionCounter : defaultSettings.showQuestionCounter, showRemainingCounter: storedSettings.showRemainingCounter !== undefined ? !!storedSettings.showRemainingCounter : defaultSettings.showRemainingCounter, btnPos: deepClone(storedSettings.btnPos) || deepClone(defaultSettings.btnPos), panelPos: deepClone(storedSettings.panelPos) || deepClone(defaultSettings.panelPos), customThemes: ensurePlainObject(storedSettings.customThemes), removedThemes: ensurePlainObject(storedSettings.removedThemes), customPrepends: ensurePlainObject(storedSettings.customPrepends), removedPrepends: ensurePlainObject(storedSettings.removedPrepends) }; var siteFeatures = (ACTIVE_SITE && ACTIVE_SITE.features) || {}; if (siteFeatures.autoDetect && storedSettings.autoDetect === undefined) { settings.autoDetect = true; } if (siteFeatures.automation) { if (storedSettings.autoSelect === undefined) settings.autoSelect = true; if (storedSettings.autoSubmit === undefined) settings.autoSubmit = true; if (storedSettings.autoHighlight === undefined) settings.autoHighlight = true; if (storedSettings.autoCopy === undefined) settings.autoCopy = true; } if (storedSettings.themes && typeof storedSettings.themes === "object") { Object.keys(storedSettings.themes).forEach(function (name) { var value = storedSettings.themes[name]; if (!value || settings.removedThemes[name]) return; if (!isDefaultTheme(name) || !areObjectsEqual(defaultSettings.themes[name], value)) { settings.customThemes[name] = deepClone(value); } }); } if (storedSettings.prependPresets && typeof storedSettings.prependPresets === "object") { Object.keys(storedSettings.prependPresets).forEach(function (name) { var value = storedSettings.prependPresets[name]; if (value === undefined || value === null || settings.removedPrepends[name]) return; if (!isDefaultPreset(name) || defaultSettings.prependPresets[name] !== value) { settings.customPrepends[name] = value; } }); } refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { var firstTheme = Object.keys(settings.themes)[0]; settings.theme = firstTheme || defaultSettings.theme; } if (settings.themeScope !== "background") settings.themeScope = "full"; settings.gradientEnabled = !!settings.gradientEnabled; settings.selectionDelay = parseInt(settings.selectionDelay, 10); if (isNaN(settings.selectionDelay) || settings.selectionDelay < 0) { settings.selectionDelay = defaultSettings.selectionDelay; } settings.submitDelay = parseInt(settings.submitDelay, 10); if (isNaN(settings.submitDelay) || settings.submitDelay < 0) { settings.submitDelay = defaultSettings.submitDelay; } var opacity = parseFloat(settings.highlightOpacity); if (isNaN(opacity)) opacity = defaultSettings.highlightOpacity; settings.highlightOpacity = Math.max(0, Math.min(1, opacity)); var validFontStyles = { system: true, clean: true, rounded: true }; if (!validFontStyles[settings.fontStyle]) { settings.fontStyle = defaultSettings.fontStyle; } var validFontWeights = { regular: true, light: true, bold: true, mixed: true }; if (!validFontWeights[settings.fontWeight]) { settings.fontWeight = defaultSettings.fontWeight; } if (settings.underlineHighlight && settings.outlineHighlight) { settings.outlineHighlight = false; } if (!settings.btnPos || typeof settings.btnPos.top === "undefined") { settings.btnPos = deepClone(defaultSettings.btnPos); } if (!settings.panelPos || typeof settings.panelPos.top === "undefined") { settings.panelPos = deepClone(defaultSettings.panelPos); } if (!Object.keys(settings.prependPresets).length) { settings.prependPresets.Custom = ""; } if (!settings.prependMessage) { settings.prependMessage = defaultSettings.prependMessage; } return settings; } function saveSettings(settings) { try { var prepared = sanitizeSettingsForSave(settings); localStorage.setItem("ixlHelperSettings", JSON.stringify(prepared || {})); } catch (err) {} } function main() { var settings = loadSettings(); if (document.body) init(settings, ACTIVE_SITE); else window.addEventListener("DOMContentLoaded", function () { init(settings, ACTIVE_SITE); }); } function init(settings, site) { var host = document.createElement("div"); host.id = "ixl-helper-host"; host.style.zIndex = "2147483647"; host.style.position = "fixed"; host.style.top = "0"; host.style.left = "0"; host.style.width = "0"; host.style.height = "0"; try { host.setAttribute("data-access-profile", ACCESS_PROFILE || "standard"); } catch (err) {} document.body.appendChild(host); var shadow = host.attachShadow({ mode: "open" }); ensureGlobalHighlightStyles(settings); var UI = createUI(host, shadow, settings, site); applyTheme(UI, settings); var sendMessage = createSendMessageFunction(UI, settings, site); setupEventListeners(UI, settings, sendMessage, site); if (site.features.autoDetect) { initQuestionObserver(UI, settings, sendMessage, site); } } function createUI(host, shadow, settings, site) { var theme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var style = document.createElement("style"); style.textContent = getCSS(settings, theme); shadow.appendChild(style); var floatingBtn = document.createElement("button"); floatingBtn.className = "floating-btn"; floatingBtn.innerHTML = ICONS.CHAT; floatingBtn.title = 'Open ' + site.title; shadow.appendChild(floatingBtn); var quickCopyBtn = document.createElement("button"); quickCopyBtn.className = "quick-copy-btn"; quickCopyBtn.innerHTML = ICONS.COPY; quickCopyBtn.title = 'Copy question to ' + site.title; shadow.appendChild(quickCopyBtn); var stealthHandle = document.createElement("button"); stealthHandle.type = "button"; stealthHandle.className = "stealth-handle"; stealthHandle.setAttribute("aria-label", "Reveal helper"); stealthHandle.title = "Reveal helper"; shadow.appendChild(stealthHandle); var widgetStrip = document.createElement("button"); widgetStrip.type = "button"; widgetStrip.className = "widget-strip"; widgetStrip.innerHTML = '<span class="widget-icon">??</span><span class="widget-label">Helper Ready</span>'; widgetStrip.style.display = "none"; shadow.appendChild(widgetStrip); var panel = document.createElement("div"); panel.className = "panel"; panel.innerHTML = getPanelHTML(site); shadow.appendChild(panel); if (!isLockedProfile()) { Array.prototype.forEach.call(panel.querySelectorAll('.locked-only'), function (el) { el.style.display = 'none'; }); } var frozenOverlay = document.createElement("div"); frozenOverlay.className = "frozen-overlay"; frozenOverlay.style.display = "none"; shadow.appendChild(frozenOverlay); var settingsView = panel.querySelector(".settings-view"); if (settingsView) { var sections = Array.from(settingsView.querySelectorAll('.settings-section')); sections.forEach(function (section) { var category = section.getAttribute('data-category'); if (!site.features.automation && category === 'automation') { section.remove(); } }); if (site.key !== 'ixl') { var infoDetails = document.createElement('details'); infoDetails.className = 'settings-section'; infoDetails.setAttribute('data-category', 'site-info'); infoDetails.open = true; var summary = document.createElement('summary'); var title = site.key === 'blackboard' ? 'Blackboard Tools' : site.key === 'vocabulary' ? 'Vocabulary Tools' : 'Wayground Tools'; var caption = site.key === 'blackboard' ? 'Enhancements tuned for MASD Blackboard questions.' : site.key === 'vocabulary' ? 'Optimized reading flow with instant auto-send on Vocabulary.com.' : 'Optimized for Wayground answer grids.'; summary.innerHTML = '<div class="summary-text"><span class="summary-title">' + title + '</span><span class="summary-caption">' + caption + '</span></div><span class="summary-icon"></span>'; infoDetails.appendChild(summary); var content = document.createElement('div'); content.className = 'section-content info-section'; var card = document.createElement('div'); card.className = 'info-card'; var list = document.createElement('ul'); var points = site.key === 'blackboard' ? [ 'Multi-answer checkbox groups highlight accurately.', 'Answer parsing respects Blackboard rich text labels.', 'Auto-detect submits answers after a short confirmation delay.' ] : site.key === 'vocabulary' ? [ 'Highlights stay aligned with long reading passages.', 'Auto-detect sends the prompt to Gemini without manual taps.', 'Use multi-answer mode when Vocabulary asks for several choices.' ] : [ 'Wayground answer buttons are scanned and highlighted instantly.', 'Auto-select taps the correct option and triggers submit automatically.', 'Widget strip shows live status like “? answers done” while minimized.' ]; points.forEach(function (text) { var li = document.createElement('li'); li.textContent = text; list.appendChild(li); }); card.appendChild(list); content.appendChild(card); infoDetails.appendChild(content); var autosaveHint = settingsView.querySelector('.autosave-hint'); settingsView.insertBefore(infoDetails, autosaveHint || settingsView.lastChild); } } var fileInput = document.createElement("input"); fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.style.display = "none"; shadow.appendChild(fileInput); var modalHost = document.createElement("div"); modalHost.className = "modal-host"; shadow.appendChild(modalHost); var UI = { shadow: shadow, host: host, style: style, floatingBtn: floatingBtn, quickCopyBtn: quickCopyBtn, stealthHandle: stealthHandle, panel: panel, fileInput: fileInput, modalHost: modalHost, title: panel.querySelector(".panel-title"), closeBtn: panel.querySelector(".close-btn"), settingsBtn: panel.querySelector(".settings-btn"), copyBtn: panel.querySelector(".copy-btn"), settingsView: settingsView, autoSelectToggle: panel.querySelector("#auto-select-toggle"), autoSubmitToggle: panel.querySelector("#auto-submit-toggle"), autoHighlightToggle: panel.querySelector("#auto-highlight-toggle"), autoDetectToggle: panel.querySelector("#auto-detect-toggle"), prependMessageInput: panel.querySelector("#prepend-message-input"), selectionDelayInput: panel.querySelector("#selection-delay"), submitDelayInput: panel.querySelector("#submit-delay"), copyrightYear: panel.querySelector("#copyright-year"), messages: panel.querySelector(".chat-messages"), chatInput: panel.querySelector(".chat-input"), sendBtn: panel.querySelector(".send-btn"), attachBtn: panel.querySelector(".attach-btn"), screenshotBtn: panel.querySelector(".screenshot-btn"), imagePreview: panel.querySelector(".image-preview"), themeList: panel.querySelector("#theme-list"), modelSelect: panel.querySelector("#model-select"), fillInBlankToggle: panel.querySelector("#fill-in-blank-toggle"), highlightColorInput: panel.querySelector("#highlight-color"), highlightOpacityInput: panel.querySelector("#highlight-opacity"), rainbowHighlightToggle: panel.querySelector("#rainbow-highlight-toggle"), pulseEffectToggle: panel.querySelector("#pulse-effect-toggle"), underlineModeToggle: panel.querySelector("#underline-mode-toggle"), outlineModeToggle: panel.querySelector("#outline-mode-toggle"), multiHighlightToggle: panel.querySelector("#multi-highlight-toggle"), stealthHighlightModeSelect: panel.querySelector("#stealth-highlight-mode"), stealthHighlightStrengthInput: panel.querySelector("#stealth-highlight-strength"), stealthHighlightStrengthValue: panel.querySelector("#stealth-highlight-strength-value"), autoCopyToggle: panel.querySelector("#auto-copy-toggle"), copyModeInputs: Array.from(panel.querySelectorAll('input[name="copy-mode"]')), prependPresetSelect: panel.querySelector("#prepend-preset-select"), gradientToggle: panel.querySelector("#gradient-toggle"), animatedBackgroundToggle: panel.querySelector("#animated-background-toggle"), fontStyleSelect: panel.querySelector("#font-style-select"), fontWeightSelect: panel.querySelector("#font-weight-select"), backgroundTransparencyInput: panel.querySelector("#background-transparency"), panelTransparencyInput: panel.querySelector("#panel-transparency"), backgroundTransparencyValue: panel.querySelector("#background-transparency-value"), panelTransparencyValue: panel.querySelector("#panel-transparency-value"), autoHideButtonsToggle: panel.querySelector("#auto-hide-side-buttons"), hideWhileIdleToggle: panel.querySelector("#hide-while-idle-toggle"), lockPositionToggle: panel.querySelector("#lock-position-toggle"), stealthModeToggle: panel.querySelector("#stealth-mode-toggle"), mirrorModeToggle: panel.querySelector("#mirror-mode-toggle"), mirrorMatchToggle: panel.querySelector("#mirror-match-toggle"), notebookModeToggle: panel.querySelector("#notebook-mode-toggle"), dimModeToggle: panel.querySelector("#dim-mode-toggle"), dimIntensityInput: panel.querySelector("#stealth-fade-intensity"), dimIntensityValue: panel.querySelector("#stealth-fade-intensity-value"), widgetModeToggle: panel.querySelector("#widget-mode-toggle"), frozenOverlayToggle: panel.querySelector("#frozen-overlay-toggle"), safeWindowToggle: panel.querySelector("#safe-window-toggle"), sideButtonTransparencyInput: panel.querySelector("#side-button-transparency"), sideButtonTransparencyValue: panel.querySelector("#side-button-transparency-value"), themeScopeInputs: Array.from(panel.querySelectorAll('input[name="theme-scope"]')), prependNameInput: panel.querySelector("#prepend-name-input"), prependSaveBtn: panel.querySelector("#prepend-save-btn"), prependUpdateBtn: panel.querySelector("#prepend-update-btn"), prependDuplicateBtn: panel.querySelector("#prepend-duplicate-btn"), prependDeleteBtn: panel.querySelector("#prepend-delete-btn"), widgetStrip: widgetStrip, widgetLabel: widgetStrip.querySelector(".widget-label"), frozenOverlay: frozenOverlay, site: site, hideOutgoingToggle: panel.querySelector("#hide-outgoing-toggle"), questionCountDisplay: panel.querySelector("#questions-answered-counter"), remainingCountDisplay: panel.querySelector("#questions-remaining-counter"), showQuestionCounterToggle: panel.querySelector("#show-question-counter-toggle"), showRemainingCounterToggle: panel.querySelector("#show-remaining-counter-toggle"), accessCodeInput: panel.querySelector("#access-code-input"), applyCodeBtn: panel.querySelector("#apply-code-btn"), accessCodeStatus: panel.querySelector("#access-code-status") }; UI.settings = settings; UI.updateTransparencyDisplays = function () { if (UI.backgroundTransparencyInput) { UI.backgroundTransparencyInput.value = settings.backgroundTransparency; } if (UI.panelTransparencyInput) { UI.panelTransparencyInput.value = settings.panelTransparency; } if (UI.backgroundTransparencyValue) { UI.backgroundTransparencyValue.textContent = settings.backgroundTransparency + "%"; } if (UI.panelTransparencyValue) { UI.panelTransparencyValue.textContent = settings.panelTransparency + "%"; } if (UI.sideButtonTransparencyInput) { UI.sideButtonTransparencyInput.value = settings.sideButtonTransparency; } if (UI.sideButtonTransparencyValue) { UI.sideButtonTransparencyValue.textContent = settings.sideButtonTransparency + "%"; } }; UI.updateFadeIntensityDisplay = function () { if (UI.dimIntensityInput) { UI.dimIntensityInput.value = settings.stealthFadeIntensity; } if (UI.dimIntensityValue) { UI.dimIntensityValue.textContent = settings.stealthFadeIntensity + "%"; } }; UI.updateStealthHighlightDisplay = function () { if (UI.stealthHighlightStrengthInput) { UI.stealthHighlightStrengthInput.value = clampTransparency( settings.stealthHighlightStrength, defaultSettings.stealthHighlightStrength ); } if (UI.stealthHighlightStrengthValue) { var strength = clampTransparency( settings.stealthHighlightStrength, defaultSettings.stealthHighlightStrength ); UI.stealthHighlightStrengthValue.textContent = strength + "%"; } }; UI.setUsageStatus = function (text, tone) { if (!UI.accessCodeStatus) return; UI.accessCodeStatus.textContent = text || ''; UI.accessCodeStatus.classList.remove('positive', 'negative', 'warning'); if (tone) UI.accessCodeStatus.classList.add(tone); }; UI.updateAccessStatus = function () { if (!UI.host) return; if (!isLockedProfile()) { UI.host.setAttribute('data-access-status', 'ready'); return; } var status; if (!UI.state || !UI.state.accessAuthorized) status = 'locked'; else if (isFinite(UI.state.questionLimit) && UI.state.questionsUsed >= UI.state.questionLimit) status = 'limited'; else status = 'ready'; UI.host.setAttribute('data-access-status', status); }; UI.updateUsageStatus = function () { if (!isLockedProfile()) { UI.setUsageStatus(''); return; } if (!UI.state || !UI.state.accessAuthorized) { UI.setUsageStatus('Enter an unlock code to enable sending.', 'warning'); return; } var limit = UI.state.questionLimit; var used = UI.state.questionsUsed || 0; if (!isFinite(limit)) { var label = UI.state.currentCode ? UI.state.currentCode : 'unlimited code'; UI.setUsageStatus('Unlocked with ' + label + ' • unlimited access', 'positive'); return; } var remaining = Math.max(0, limit - used); var windowStart = UI.state.usageWindowStart || 0; var resetMs = windowStart ? Math.max(0, ACCESS_WINDOW_MS - (Date.now() - windowStart)) : 0; var message = 'Unlocked (' + limit + ' per 2h) • ' + remaining + ' left'; if (resetMs > 0 && remaining < limit) { message += ' • resets in ' + formatDuration(resetMs); } UI.setUsageStatus(message, remaining > 0 ? 'positive' : 'warning'); }; UI.updateUsageCounters = function () { var doneValue = isLockedProfile() ? (UI.state && UI.state.questionsUsed) || 0 : (UI.state && UI.state.answersCompleted) || 0; if (UI.questionCountDisplay) { if (settings.showQuestionCounter !== false) { UI.questionCountDisplay.textContent = doneValue + ' done'; UI.questionCountDisplay.classList.add('active'); } else { UI.questionCountDisplay.classList.remove('active'); } } if (UI.remainingCountDisplay) { if (settings.showRemainingCounter !== false) { var remainingText; if (isLockedProfile()) { if (!UI.state) remainingText = '—'; else if (!isFinite(UI.state.questionLimit)) remainingText = '8 left'; else { var remaining = Math.max(0, (UI.state.questionLimit || 0) - (UI.state.questionsUsed || 0)); remainingText = remaining + ' left'; } } else { remainingText = '8 left'; } UI.remainingCountDisplay.textContent = remainingText; UI.remainingCountDisplay.classList.add('active'); } else { UI.remainingCountDisplay.classList.remove('active'); } } UI.updateAccessStatus(); }; UI.attachedImageBase64 = null; UI.attachedImageMime = null; floatingBtn.style.top = settings.btnPos.top; floatingBtn.style.left = settings.btnPos.left; quickCopyBtn.style.top = "calc(" + settings.btnPos.top + " + 60px)"; quickCopyBtn.style.left = settings.btnPos.left; stealthHandle.style.top = settings.btnPos.top; stealthHandle.style.left = settings.btnPos.left; panel.style.top = settings.panelPos.top; panel.style.left = settings.panelPos.left; if (settings.panelPos.left === "50%") panel.style.transform = "translate(-50%, -50%) scale(0.95)"; else panel.style.transform = "scale(0.95)"; try { host.style.setProperty("--stealth-dim-percent", String(clampFadeIntensity(settings.stealthFadeIntensity))); } catch (err) {} makeDraggable(floatingBtn, "btnPos", settings, null, [quickCopyBtn, stealthHandle]); makeDraggable(panel, "panelPos", settings, panel.querySelector(".panel-header")); return UI; } function createSendMessageFunction(UI, settings, site) { function sendMessageWithRetries(payload, loadingMessage, retries) { retries = typeof retries === "number" ? retries : 1; function attempt(retryCount) { var geminiPayload = { contents: [{ parts: [] }] }; if (payload.message) geminiPayload.contents[0].parts.push({ text: payload.message }); if (payload.image) { geminiPayload.contents[0].parts.push({ inlineData: { mimeType: payload.imageMime || "image/png", data: payload.image } }); } fetch("https://generativelanguage.googleapis.com/v1beta/models/" + (settings.model || "gemini-2.5-flash-lite") + ":generateContent?key=" + API_KEY, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(geminiPayload) }) .then(function (response) { if (response.status === 429) { var retryAfter = parseInt(response.headers.get("retry-after") || "5", 10); throw { status: 429, retryAfter: Math.max(2, retryAfter) }; } if (response.status >= 400) throw new Error("HTTP error " + response.status); return response.json(); }) .then(function (data) { var responseText = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || "Error: No response from Gemini"; if (loadingMessage) loadingMessage.querySelector("p").textContent = responseText; showToast(UI, "Answer: " + responseText, "success"); if (settings.autoHighlight) highlightAnswer(UI, responseText, settings); var canAutomate = site.features.automation; var fillSuccess = canAutomate ? fillInTheBlank(UI, responseText, settings) : false; if (canAutomate && settings.autoSelect && !fillSuccess) { var selectionSuccess = selectAnswer(UI, responseText); if (selectionSuccess && settings.autoSubmit) { var delaySeconds = settings.submitDelay || 5; setTimeout(function () { submitAnswer(UI); }, delaySeconds * 1000); } } if (canAutomate && settings.autoSubmit && !settings.autoSelect) { var delayOnly = settings.submitDelay || 5; setTimeout(function () { submitAnswer(UI); }, delayOnly * 1000); } UI.state = UI.state || {}; UI.state.answersCompleted = (UI.state.answersCompleted || 0) + 1; UI.state.totalAnswered = UI.state.answersCompleted; UI.state.questionStats = UI.state.questionStats || { totalAnswered: 0 }; UI.state.questionStats.totalAnswered = UI.state.answersCompleted; saveQuestionStats(UI.state.questionStats); if (isLockedProfile()) { if (typeof UI.ensureUsageWindowFresh === 'function') UI.ensureUsageWindowFresh(); if (!UI.state.questionsUsed) UI.state.questionsUsed = 0; if (isFinite(UI.state.questionLimit)) { UI.state.questionsUsed = Math.min(UI.state.questionLimit, UI.state.questionsUsed + 1); } else { UI.state.questionsUsed = (UI.state.questionsUsed || 0) + 1; } saveUsageState({ code: UI.state.currentCode, windowStart: UI.state.usageWindowStart, used: UI.state.questionsUsed }); } else { UI.state.questionsUsed = (UI.state.questionsUsed || 0) + 1; } if (typeof UI.updateUsageCounters === 'function') UI.updateUsageCounters(); if (typeof UI.updateUsageStatus === 'function') UI.updateUsageStatus(); if (typeof UI.updateWidgetStrip === 'function') UI.updateWidgetStrip(); }) .catch(function (error) { if (error && error.status === 429 && retryCount < 3) { var waitMs = (error.retryAfter || 3) * 1000 * (retryCount + 1); if (loadingMessage) loadingMessage.querySelector("p").textContent = "Rate limited, retrying in " + Math.ceil(waitMs / 1000) + "s..."; setTimeout(function () { attempt(retryCount + 1); }, waitMs); } else if (retryCount < retries) { if (loadingMessage) loadingMessage.querySelector("p").textContent = "AI is slow, retrying... (" + (retryCount + 1) + ")"; setTimeout(function () { attempt(retryCount + 1); }, Math.max(600, 1000 * (retryCount + 1))); } else { var errorMsg = "Error: " + (error.message || "AI failed to respond."); if (loadingMessage) loadingMessage.querySelector("p").textContent = errorMsg; showToast(UI, errorMsg, "error"); } }); } attempt(0); } return function (text, image, isQuickCopy) { isQuickCopy = isQuickCopy || false; var messageText = typeof text === "string" ? text : UI.chatInput.value.trim(); var imageBase64 = null; var imageMime = null; if (image && typeof image === "object") { imageBase64 = image.base64 || null; imageMime = image.mime || null; } else if (typeof image === "string") { imageBase64 = image; } else { imageBase64 = UI.attachedImageBase64 || null; imageMime = UI.attachedImageMime || null; } if (imageBase64 && !imageMime) imageMime = "image/png"; if (!messageText && !imageBase64) return; if (isLockedProfile()) { if (typeof UI.ensureUsageWindowFresh === 'function') UI.ensureUsageWindowFresh(); if (typeof UI.updateUsageCounters === 'function') UI.updateUsageCounters(); if (typeof UI.updateUsageStatus === 'function') UI.updateUsageStatus(); if (!UI.state || !UI.state.accessAuthorized) { UI.setUsageStatus('Enter an unlock code to enable sending.', 'warning'); UI.updateAccessStatus(); showToast(UI, 'Unlock code required before sending.', 'error'); return; } if (isFinite(UI.state.questionLimit)) { var remainingQuota = UI.state.questionLimit - (UI.state.questionsUsed || 0); if (remainingQuota <= 0) { var waitMs = UI.state.usageWindowStart ? Math.max(0, ACCESS_WINDOW_MS - (Date.now() - UI.state.usageWindowStart)) : 0; UI.setUsageStatus('Limit reached. Wait for reset.', 'warning'); UI.updateAccessStatus(); showToast(UI, 'Question limit reached. Available again in ' + (waitMs > 0 ? formatDuration(waitMs) : 'a moment') + '.', 'warning'); return; } } } var loadingMessage = null; if (!isQuickCopy) { var dataUrl = imageBase64 ? "data:" + imageMime + ";base64," + imageBase64 : null; appendMessage(UI, "user", messageText, dataUrl); if (typeof text !== "string") UI.chatInput.value = ""; if (UI.clearImagePreview) UI.clearImagePreview(); scrollMessagesToBottom(UI); loadingMessage = appendMessage(UI, "bot", "? ? ?"); } else { showToast(UI, "Getting answer...", "info"); scrollMessagesToBottom(UI); } sendMessageWithRetries({ message: messageText, image: imageBase64, imageMime: imageMime }, loadingMessage); }; } function setupEventListeners(UI, settings, sendMessage, site) { if (UI.modelSelect) { UI.modelSelect.value = settings.model || "gemini-2.5-flash-lite"; UI.modelSelect.addEventListener("change", function () { settings.model = UI.modelSelect.value; saveSettings(settings); }); } refreshComputedSettings(settings); UI.sendMessage = sendMessage; var attachedImageBase64 = null; var attachedImageMime = null; UI.copyrightYear.textContent = new Date().getFullYear(); UI.state = UI.state || {}; UI.state.stealthRevealed = settings.stealthMode ? false : true; UI.state.idleTimer = null; UI.state.questionStats = loadQuestionStats(); UI.state.answersCompleted = typeof UI.state.questionStats.totalAnswered === 'number' ? UI.state.questionStats.totalAnswered : UI.state.answersCompleted || 0; UI.state.totalAnswered = UI.state.answersCompleted; UI.state.widgetCollapsed = settings.widgetMode ? true : false; UI.state.safeWindowPaused = false; UI.state.notebookRevealed = false; if (isLockedProfile()) { var storedUsage = loadUsageState(); var codeInfo = resolveAccessCode(storedUsage.code); if (codeInfo) { UI.state.accessAuthorized = true; UI.state.currentCode = codeInfo.key; UI.state.questionLimit = codeInfo.limit; UI.state.questionsUsed = Math.max(0, storedUsage.used || 0); UI.state.usageWindowStart = storedUsage.windowStart || Date.now(); if (codeInfo.apiKey) { API_KEY = codeInfo.apiKey; } } else { UI.state.accessAuthorized = false; UI.state.currentCode = ''; UI.state.questionLimit = 0; UI.state.questionsUsed = 0; UI.state.usageWindowStart = Date.now(); saveUsageState({ code: '', windowStart: 0, used: 0 }); } } else { UI.state.accessAuthorized = true; UI.state.currentCode = ''; UI.state.questionLimit = Infinity; UI.state.questionsUsed = UI.state.answersCompleted || 0; UI.state.usageWindowStart = Date.now(); } function ensureUsageWindowFresh(options) { if (!isLockedProfile()) return false; if (!UI.state || !UI.state.accessAuthorized) return false; if (!isFinite(UI.state.questionLimit)) return false; var now = Date.now(); if (!UI.state.usageWindowStart) { UI.state.usageWindowStart = now; saveUsageState({ code: UI.state.currentCode, windowStart: UI.state.usageWindowStart, used: UI.state.questionsUsed || 0 }); return true; } if (now - UI.state.usageWindowStart >= ACCESS_WINDOW_MS) { UI.state.usageWindowStart = now; UI.state.questionsUsed = 0; saveUsageState({ code: UI.state.currentCode, windowStart: UI.state.usageWindowStart, used: 0 }); if (options && options.notify) { showToast(UI, 'Question window reset. ' + UI.state.questionLimit + ' available.', 'info'); } return true; } return false; } UI.ensureUsageWindowFresh = ensureUsageWindowFresh; ensureUsageWindowFresh(); function syncStealthHandle() { if (!UI.stealthHandle) return; var pos = settings.btnPos || defaultSettings.btnPos; if (pos) { if (typeof pos.top === "string") UI.stealthHandle.style.top = pos.top; if (typeof pos.left === "string") UI.stealthHandle.style.left = pos.left; } var hidden = settings.stealthMode && !UI.state.stealthRevealed; UI.stealthHandle.style.display = hidden ? "" : "none"; UI.stealthHandle.setAttribute("aria-hidden", hidden ? "false" : "true"); } function updateStealthVisibility() { if (!settings.stealthMode) { UI.host.removeAttribute("data-stealth"); UI.state.stealthRevealed = true; syncStealthHandle(); return; } var state = UI.state.stealthRevealed ? "revealed" : "hidden"; UI.host.setAttribute("data-stealth", state); syncStealthHandle(); } function setStealthRevealed(value) { if (!settings.stealthMode) { UI.host.removeAttribute("data-stealth"); UI.state.stealthRevealed = true; updateSideButtonVisibility(); syncStealthHandle(); return; } UI.state.stealthRevealed = !!value; updateStealthVisibility(); updateSideButtonVisibility(); applyStealthAppearance(); } function clearIdleTimer() { if (UI.state.idleTimer) { clearTimeout(UI.state.idleTimer); UI.state.idleTimer = null; } } function scheduleIdleHide() { if (!settings.hideWhileIdle) return; clearIdleTimer(); UI.state.idleTimer = setTimeout(function () { if (!settings.hideWhileIdle) return; UI.host.setAttribute("data-idle-state", "hidden"); updateSideButtonVisibility(); }, 20000); } function recordActivity() { if (!settings.hideWhileIdle) return; UI.host.setAttribute("data-idle-state", "active"); updateSideButtonVisibility(); scheduleIdleHide(); } updateStealthVisibility(); function resolveMirrorTitle() { if (site.key === "blackboard") return "Course Info"; if (site.key === "vocabulary") return "Vocabulary List"; if (site.key === "wayground") return "Wayground Helper"; return "Score Summary"; } function resolveNotebookTitle() { return "Study Notes – Chapter Review"; } function resolvePanelTitle() { if (!UI.title) return ""; if (UI.panel.classList.contains("settings-mode")) return "Settings"; if (settings.notebookMode && !UI.state.notebookRevealed) return resolveNotebookTitle(); if (settings.mirrorMode) return resolveMirrorTitle(); return UI.site.title; } function updatePanelTitle() { if (!UI.title) return; UI.title.textContent = resolvePanelTitle(); } function clearFrozenOverlay() { if (!UI.frozenOverlay) return; UI.frozenOverlay.innerHTML = ""; UI.frozenOverlay.style.display = "none"; } function refreshFrozenOverlay() { if (!UI.frozenOverlay) return; if (!settings.frozenOverlay || !UI.panel.classList.contains("open")) { clearFrozenOverlay(); return; } try { var panelRect = UI.panel.getBoundingClientRect(); UI.frozenOverlay.style.position = "fixed"; UI.frozenOverlay.style.top = panelRect.top + "px"; UI.frozenOverlay.style.left = panelRect.left + "px"; UI.frozenOverlay.style.width = panelRect.width + "px"; UI.frozenOverlay.style.height = panelRect.height + "px"; var clone = UI.panel.cloneNode(true); clone.classList.add("frozen-panel-clone"); UI.frozenOverlay.innerHTML = ""; UI.frozenOverlay.appendChild(clone); UI.frozenOverlay.style.display = "block"; } catch (err) { clearFrozenOverlay(); } } function updateWidgetStrip() { if (!UI.widgetStrip) return; if (!settings.widgetMode) { UI.widgetStrip.style.display = "none"; UI.widgetStrip.setAttribute("aria-expanded", "false"); UI.widgetStrip.setAttribute("aria-hidden", "true"); UI.host.removeAttribute("data-widget-mode"); return; } if (settings.stealthMode && !UI.state.stealthRevealed) { UI.widgetStrip.style.display = "none"; UI.widgetStrip.setAttribute("aria-expanded", "false"); UI.widgetStrip.setAttribute("aria-hidden", "true"); UI.host.removeAttribute("data-widget-mode"); return; } var isOpen = UI.panel.classList.contains("open"); UI.widgetStrip.style.display = "flex"; UI.widgetStrip.classList.toggle("expanded", isOpen); UI.widgetStrip.setAttribute("aria-expanded", isOpen ? "true" : "false"); UI.widgetStrip.setAttribute("aria-hidden", "false"); var parts = []; if (settings.showQuestionCounter !== false) { var widgetDone = isLockedProfile() ? (UI.state.questionsUsed || 0) : (UI.state.answersCompleted || 0); parts.push("? " + widgetDone + " Done"); } else if (UI.state.answersCompleted > 0) { parts.push("? " + UI.state.answersCompleted + " Answers Done"); } if (settings.showRemainingCounter !== false) { var remainingText; if (isLockedProfile()) { if (!isFinite(UI.state.questionLimit)) remainingText = "8 Left"; else { var widgetRemaining = Math.max(0, (UI.state.questionLimit || 0) - (UI.state.questionsUsed || 0)); remainingText = widgetRemaining + " Left"; } } else { remainingText = "8 Left"; } parts.push("? " + remainingText); } var delay = settings.submitDelay || defaultSettings.submitDelay; parts.push("?? Auto Delay " + delay + " s"); if (UI.widgetLabel) UI.widgetLabel.textContent = parts.join(" • "); UI.host.setAttribute("data-widget-mode", isOpen ? "expanded" : "collapsed"); } function applyStealthAppearance() { var host = UI.host; if (!host) return; var mirrorActive = settings.mirrorMode && !UI.state.notebookRevealed; if (mirrorActive) { host.setAttribute("data-mirror-mode", site.key || "generic"); if (settings.mirrorMatchSite !== false) { host.setAttribute("data-mirror-match", "on"); var mirrorKey = MIRROR_STYLES[site.key] ? site.key : "generic"; var palette = MIRROR_STYLES[mirrorKey] || MIRROR_STYLES.generic; if (palette) { try { host.style.setProperty("--mirror-bg", palette.bg); host.style.setProperty("--mirror-text", palette.text); host.style.setProperty("--mirror-accent", palette.accent); } catch (err) {} } } else { host.removeAttribute("data-mirror-match"); try { host.style.removeProperty("--mirror-bg"); host.style.removeProperty("--mirror-text"); host.style.removeProperty("--mirror-accent"); } catch (error) {} } } else { host.removeAttribute("data-mirror-mode"); host.removeAttribute("data-mirror-match"); try { host.style.removeProperty("--mirror-bg"); host.style.removeProperty("--mirror-text"); host.style.removeProperty("--mirror-accent"); } catch (cleanupError) {} } if (settings.notebookMode && !UI.state.notebookRevealed) host.setAttribute("data-notebook-mode", "on"); else host.removeAttribute("data-notebook-mode"); if (settings.dimMode) host.setAttribute("data-dim-mode", "on"); else host.removeAttribute("data-dim-mode"); var fadeValue = clampFadeIntensity(settings.stealthFadeIntensity, defaultSettings.stealthFadeIntensity); try { host.style.setProperty("--stealth-dim-percent", String(fadeValue)); } catch (err) {} if (!settings.dimMode) { try { host.style.removeProperty("--stealth-dim-percent"); } catch (e) {} } if (settings.widgetMode) { host.setAttribute("data-widget-mode", UI.panel.classList.contains("open") ? "expanded" : "collapsed"); } else { host.removeAttribute("data-widget-mode"); } if (settings.frozenOverlay && UI.panel.classList.contains("open")) { host.setAttribute("data-frozen-overlay", "on"); refreshFrozenOverlay(); } else { host.removeAttribute("data-frozen-overlay"); clearFrozenOverlay(); } if (settings.safeWindowMode) { host.setAttribute("data-safe-window", UI.panel.classList.contains("open") ? "open" : "hidden"); } else { host.removeAttribute("data-safe-window"); } syncStealthHandle(); updatePanelTitle(); updateWidgetStrip(); } UI.updateWidgetStrip = updateWidgetStrip; UI.applyStealthAppearance = applyStealthAppearance; UI.updatePanelTitle = updatePanelTitle; var saveTimer = null; function queueSave(options) { options = options || {}; if (saveTimer) clearTimeout(saveTimer); var delay = typeof options.delay === "number" ? options.delay : 250; saveTimer = setTimeout(function () { saveTimer = null; if (options.refresh !== false) { refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { var fallbackTheme = Object.keys(settings.themes)[0]; if (fallbackTheme) settings.theme = fallbackTheme; } } saveSettings(settings); }, delay); } function setPanelOpen(forceOpen, options) { options = options || {}; var shouldFocus = options.focus !== false; var transform = UI.panel.style.left === "50%" ? "translate(-50%, -50%)" : ""; if (forceOpen) { if (settings.stealthMode && !UI.state.stealthRevealed) { setStealthRevealed(true); } UI.panel.classList.add("open"); UI.panel.style.transform = transform ? transform + " scale(1)" : "scale(1)"; UI.state.widgetCollapsed = false; UI.state.safeWindowPaused = false; scrollMessagesToBottom(UI); if (shouldFocus && UI.chatInput && !UI.panel.classList.contains("settings-mode")) { try { UI.chatInput.focus(); } catch (e) {} } recordActivity(); } else { UI.panel.classList.remove("open"); UI.panel.style.transform = transform ? transform + " scale(0.95)" : "scale(0.95)"; if (settings.stealthMode && options.keepRevealed !== true) { setStealthRevealed(false); } UI.state.widgetCollapsed = true; if (settings.notebookMode) { UI.state.notebookRevealed = false; } if (settings.safeWindowMode) { var wasPaused = UI.state.safeWindowPaused; UI.state.safeWindowPaused = true; if (!wasPaused) { showToast(UI, "Automation paused until you reopen the safe window.", "info"); } } } updateSideButtonVisibility(); applyStealthAppearance(); refreshFrozenOverlay(); } function togglePanel() { setPanelOpen(!UI.panel.classList.contains("open")); } function ensureChatView(options) { var shouldFocus = !options || options.focus !== false; if (UI.panel.classList.contains("settings-mode")) { UI.panel.classList.remove("settings-mode"); UI.settingsBtn.innerHTML = ICONS.SETTINGS; updatePanelTitle(); } scrollMessagesToBottom(UI); if (shouldFocus && UI.chatInput) { try { UI.chatInput.focus(); } catch (e) {} } } UI.clearImagePreview = function () { attachedImageBase64 = null; attachedImageMime = null; UI.attachedImageBase64 = null; UI.attachedImageMime = null; UI.imagePreview.innerHTML = ""; UI.imagePreview.style.display = "none"; try { UI.fileInput.value = ""; } catch (err) {} }; function updateSideButtonVisibility() { var hideForPanel = settings.autoHideSideButtons !== false && UI.panel.classList.contains("open"); var idleHidden = settings.hideWhileIdle && UI.host.getAttribute("data-idle-state") === "hidden"; var stealthHidden = settings.stealthMode && !UI.state.stealthRevealed; var widgetActive = settings.widgetMode; var safeWindowHidden = settings.safeWindowMode && !UI.panel.classList.contains("open"); var allowSideButtons = !widgetActive && !safeWindowHidden; var showFloating = allowSideButtons && !hideForPanel && !idleHidden && !stealthHidden && settings.showFloatingButton !== false; var showQuickCopy = allowSideButtons && !hideForPanel && !idleHidden && !stealthHidden && settings.showQuickCopyButton !== false; if (stealthHidden) { UI.panel.classList.remove("open"); } if (UI.floatingBtn) { UI.floatingBtn.style.display = showFloating ? "" : "none"; } if (UI.quickCopyBtn) { UI.quickCopyBtn.style.display = showQuickCopy ? "" : "none"; } updateWidgetStrip(); syncStealthHandle(); } updateSideButtonVisibility(); if (settings.hideWhileIdle) { UI.host.setAttribute("data-idle-state", UI.host.getAttribute("data-idle-state") || "active"); recordActivity(); } ["mousemove", "keydown", "pointerdown", "touchstart", "scroll"].forEach(function (eventName) { document.addEventListener(eventName, recordActivity, { passive: true }); if (UI.shadow && UI.shadow.addEventListener) { UI.shadow.addEventListener(eventName, recordActivity, { passive: true }); } }); function shouldFocusAfterCopy() { return (settings.copyMode || "standard") !== "advanced"; } function refreshBaseStyles() { if (!UI.style) return; var currentTheme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; UI.style.textContent = getCSS(settings, currentTheme); } function syncHighlightModeControls() { if (UI.underlineModeToggle) UI.underlineModeToggle.checked = !!settings.underlineHighlight; if (UI.outlineModeToggle) UI.outlineModeToggle.checked = !!settings.outlineHighlight; } var shouldAutoSendCopy = site && ["ixl", "blackboard", "vocabulary", "wayground"].indexOf(site.key) !== -1; function handleImageFile(file) { if (!file || !file.type || !file.type.startsWith("image/")) return; var reader = new FileReader(); reader.onload = function (e) { var dataUrl = e.target.result; attachedImageBase64 = dataUrl.split(",")[1]; attachedImageMime = file.type || "image/png"; UI.attachedImageBase64 = attachedImageBase64; UI.attachedImageMime = attachedImageMime; UI.imagePreview.innerHTML = '<img src="' + dataUrl + '" alt="Attachment preview" /><button aria-label="Remove image">&times;</button>'; UI.imagePreview.style.display = "flex"; var removeBtn = UI.imagePreview.querySelector("button"); if (removeBtn) removeBtn.onclick = UI.clearImagePreview; try { UI.fileInput.value = ""; } catch (err) {} }; reader.readAsDataURL(file); } function getSortedThemeNames() { return Object.keys(settings.themes || {}).sort(function (a, b) { return a.localeCompare(b); }); } function getPresetNames() { return Object.keys(settings.prependPresets || {}).sort(function (a, b) { if (a === "Custom") return -1; if (b === "Custom") return 1; return a.localeCompare(b); }); } function findPresetNameByMessage(message) { if (!message) return ""; var normalized = String(message).trim(); var match = ""; Object.keys(settings.prependPresets || {}).some(function (name) { var preset = settings.prependPresets[name]; if (String(preset || "").trim() === normalized) { match = name; return true; } return false; }); return match; } function renderThemeList(targetName) { refreshComputedSettings(settings); if (!UI.themeList) return; var names = getSortedThemeNames(); if (!names.length) { names = [settings.theme || defaultSettings.theme]; } var active = targetName && settings.themes[targetName] ? targetName : settings.theme; if (!settings.themes[active] && names.length) { active = names[0]; settings.theme = active; } UI.themeList.innerHTML = ""; names.forEach(function (name) { var theme = settings.themes[name]; if (!theme) return; var card = document.createElement("div"); card.className = "theme-card" + (name === settings.theme ? " active" : ""); card.dataset.themeName = name; var mainButton = document.createElement("button"); mainButton.type = "button"; mainButton.className = "theme-card-main"; mainButton.dataset.themeAction = "select"; mainButton.dataset.themeName = name; var chip = document.createElement("span"); chip.className = "theme-chip"; var gradientFrom = theme.gradientFrom || theme.bg || "#000000"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || gradientFrom; chip.style.background = "linear-gradient(135deg, " + gradientFrom + ", " + gradientTo + ")"; chip.style.borderColor = theme.border || gradientFrom; mainButton.appendChild(chip); var nameSpan = document.createElement("span"); nameSpan.className = "theme-card-name"; nameSpan.textContent = name; mainButton.appendChild(nameSpan); card.appendChild(mainButton); var actions = document.createElement("div"); actions.className = "theme-card-actions"; var editBtn = document.createElement("button"); editBtn.type = "button"; editBtn.className = "icon-btn"; editBtn.title = "Edit theme"; editBtn.dataset.themeAction = "edit"; editBtn.dataset.themeName = name; editBtn.innerHTML = ICONS.PENCIL; actions.appendChild(editBtn); var duplicateBtn = document.createElement("button"); duplicateBtn.type = "button"; duplicateBtn.className = "icon-btn"; duplicateBtn.title = "Duplicate theme"; duplicateBtn.dataset.themeAction = "duplicate"; duplicateBtn.dataset.themeName = name; duplicateBtn.innerHTML = ICONS.DUPLICATE; actions.appendChild(duplicateBtn); var deleteBtn = document.createElement("button"); deleteBtn.type = "button"; deleteBtn.className = "icon-btn danger"; deleteBtn.title = "Delete theme"; deleteBtn.dataset.themeAction = "delete"; deleteBtn.dataset.themeName = name; deleteBtn.innerHTML = ICONS.TRASH; actions.appendChild(deleteBtn); card.appendChild(actions); UI.themeList.appendChild(card); }); var createBtn = document.createElement("button"); createBtn.type = "button"; createBtn.className = "theme-card create"; createBtn.dataset.themeAction = "create"; createBtn.innerHTML = ICONS.PLUS + '<span>Create new theme</span>'; UI.themeList.appendChild(createBtn); } function getThemeScopeValue() { var value = "full"; (UI.themeScopeInputs || []).forEach(function (input) { if (input && input.checked) value = input.value; }); return value === "background" ? "background" : "full"; } function syncThemeScopeUI(value) { var resolved = value === "background" ? "background" : "full"; (UI.themeScopeInputs || []).forEach(function (input) { if (!input) return; input.checked = input.value === resolved; }); } function populatePrependSelect(targetName) { refreshComputedSettings(settings); var names = getPresetNames(); if (!names.length) names = ["Custom"]; var options = names.map(function (name) { return '<option value="' + name + '">' + name + '</option>'; }).join(""); UI.prependPresetSelect.innerHTML = options; var baseMessage = UI.prependMessageInput.value || settings.prependMessage; var resolved = targetName && settings.prependPresets[targetName] !== undefined ? targetName : findPresetNameByMessage(baseMessage); if (!resolved && names.indexOf("Custom") !== -1) resolved = "Custom"; if (!resolved) resolved = names[0]; UI.prependPresetSelect.value = resolved; if (resolved === "Custom") UI.prependNameInput.value = ""; else UI.prependNameInput.value = resolved || ""; } function createModal(title) { var overlay = document.createElement("div"); overlay.className = "modal-overlay"; var modal = document.createElement("div"); modal.className = "modal"; overlay.appendChild(modal); var closeBtn = document.createElement("button"); closeBtn.type = "button"; closeBtn.className = "modal-close"; closeBtn.innerHTML = '&times;'; modal.appendChild(closeBtn); if (title) { var heading = document.createElement("h2"); heading.textContent = title; modal.appendChild(heading); } var content = document.createElement("div"); content.className = "modal-content"; modal.appendChild(content); UI.modalHost.appendChild(overlay); function close() { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); } closeBtn.addEventListener("click", close); overlay.addEventListener("click", function (event) { if (event.target === overlay) close(); }); return { overlay: overlay, modal: modal, content: content, close: close }; } function openThemeEditor(existingName) { var isEdit = !!existingName; var activeTheme = settings.themes[existingName] || settings.themes[settings.theme] || defaultSettings.themes.Midnight; var themeData = deepClone(activeTheme) || deepClone(defaultSettings.themes.Midnight); if (!themeData.gradientFrom) themeData.gradientFrom = themeData.bg || "#000000"; if (!themeData.gradientTo) themeData.gradientTo = themeData.elevated || themeData.surface || themeData.bg || "#000000"; var modal = createModal(isEdit ? "Edit Theme" : "Create Theme"); var form = document.createElement("form"); form.className = "theme-form"; var nameGroup = document.createElement("div"); nameGroup.className = "form-group"; var nameLabel = document.createElement("label"); nameLabel.textContent = "Theme Name"; var nameInput = document.createElement("input"); nameInput.type = "text"; nameInput.id = "theme-name-input"; nameInput.placeholder = "Theme name"; nameInput.value = existingName || ""; nameGroup.appendChild(nameLabel); nameGroup.appendChild(nameInput); form.appendChild(nameGroup); var controlsRow = document.createElement("div"); controlsRow.className = "field-grid"; var gradientField = document.createElement("div"); gradientField.className = "field-group"; var gradientLabel = document.createElement("span"); gradientLabel.className = "field-label"; gradientLabel.textContent = "Use gradient background"; gradientField.appendChild(gradientLabel); var gradientToggle = document.createElement("label"); gradientToggle.className = "toggle-switch"; var gradientInput = document.createElement("input"); gradientInput.type = "checkbox"; gradientInput.checked = settings.gradientEnabled; var gradientSlider = document.createElement("span"); gradientSlider.className = "slider"; gradientSlider.appendChild(document.createElement("span")).className = "dot"; gradientToggle.appendChild(gradientInput); gradientToggle.appendChild(gradientSlider); gradientField.appendChild(gradientToggle); controlsRow.appendChild(gradientField); var scopeField = document.createElement("div"); scopeField.className = "field-group"; var scopeLabel = document.createElement("span"); scopeLabel.className = "field-label"; scopeLabel.textContent = "Apply theme to"; scopeField.appendChild(scopeLabel); var scopeControl = document.createElement("div"); scopeControl.className = "segmented-control"; var scopeFullInput = document.createElement("input"); scopeFullInput.type = "radio"; scopeFullInput.name = "builder-theme-scope"; scopeFullInput.value = "full"; scopeFullInput.id = "builder-scope-full"; var scopeFullLabel = document.createElement("label"); scopeFullLabel.htmlFor = scopeFullInput.id; scopeFullLabel.textContent = "Entire UI"; var scopeBgInput = document.createElement("input"); scopeBgInput.type = "radio"; scopeBgInput.name = "builder-theme-scope"; scopeBgInput.value = "background"; scopeBgInput.id = "builder-scope-background"; var scopeBgLabel = document.createElement("label"); scopeBgLabel.htmlFor = scopeBgInput.id; scopeBgLabel.textContent = "Background only"; scopeControl.appendChild(scopeFullInput); scopeControl.appendChild(scopeFullLabel); scopeControl.appendChild(scopeBgInput); scopeControl.appendChild(scopeBgLabel); scopeField.appendChild(scopeControl); controlsRow.appendChild(scopeField); form.appendChild(controlsRow); var preview = document.createElement("div"); preview.className = "theme-preview"; var previewShell = document.createElement("div"); previewShell.className = "preview-shell"; var previewTop = document.createElement("div"); previewTop.className = "preview-topbar"; previewTop.textContent = "Theme preview"; var previewBody = document.createElement("div"); previewBody.className = "preview-body"; var botBubble = document.createElement("div"); botBubble.className = "bubble bot"; botBubble.textContent = "Answer highlight"; var userBubble = document.createElement("div"); userBubble.className = "bubble user"; userBubble.textContent = "You copied the question"; previewBody.appendChild(botBubble); previewBody.appendChild(userBubble); previewShell.appendChild(previewTop); previewShell.appendChild(previewBody); preview.appendChild(previewShell); form.appendChild(preview); var fields = [ { key: "bg", label: "Background" }, { key: "surface", label: "Surface" }, { key: "elevated", label: "Elevated" }, { key: "text", label: "Text" }, { key: "subtext", label: "Subtext" }, { key: "border", label: "Border" }, { key: "accent", label: "Accent" }, { key: "accentHover", label: "Accent Hover" }, { key: "success", label: "Success" }, { key: "error", label: "Error" }, { key: "gradientFrom", label: "Gradient Start" }, { key: "gradientTo", label: "Gradient End" } ]; var grid = document.createElement("div"); grid.className = "modal-grid"; fields.forEach(function (field) { var wrapper = document.createElement("label"); wrapper.className = "modal-field"; var span = document.createElement("span"); span.textContent = field.label; wrapper.appendChild(span); var input = document.createElement("input"); input.type = "color"; var value = themeData[field.key]; if (!value) value = defaultSettings.themes.Midnight[field.key] || themeData.bg || "#000000"; input.value = value; input.dataset.key = field.key; wrapper.appendChild(input); grid.appendChild(wrapper); }); form.appendChild(grid); var actions = document.createElement("div"); actions.className = "modal-actions"; var submitBtn = document.createElement("button"); submitBtn.type = "submit"; submitBtn.className = "btn primary"; submitBtn.textContent = isEdit ? "Save Theme" : "Create Theme"; var cancelBtn = document.createElement("button"); cancelBtn.type = "button"; cancelBtn.className = "btn secondary"; cancelBtn.textContent = "Cancel"; actions.appendChild(submitBtn); actions.appendChild(cancelBtn); form.appendChild(actions); modal.content.appendChild(form); cancelBtn.addEventListener("click", modal.close); function getBuilderScope() { return scopeBgInput.checked ? "background" : "full"; } function updatePreview() { var gradientActive = gradientInput.checked; var scopeValue = getBuilderScope(); var gradientValue = "linear-gradient(135deg, " + themeData.gradientFrom + ", " + themeData.gradientTo + ")"; var surface = themeData.surface || themeData.bg || "#0a0a0a"; var elevated = themeData.elevated || surface; var panelOpacity = 1 - clampTransparency(settings.panelTransparency, defaultSettings.panelTransparency) / 100; var backgroundOpacity = 1 - clampTransparency( settings.backgroundTransparency, defaultSettings.backgroundTransparency ) / 100; var panelBackground = gradientActive ? "linear-gradient(135deg, " + convertHexToRgba(themeData.gradientFrom, panelOpacity) + ", " + convertHexToRgba(themeData.gradientTo, panelOpacity) + ")" : convertHexToRgba(surface, panelOpacity); previewShell.style.background = panelBackground; previewShell.style.borderColor = convertHexToRgba(themeData.border || surface, Math.min(1, panelOpacity + 0.35)); preview.setAttribute('data-scope', scopeValue); previewTop.style.background = scopeValue === "background" ? convertHexToRgba(themeData.bg || surface, Math.min(1, backgroundOpacity + 0.12)) : convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.05)); previewTop.style.color = themeData.text || "#ffffff"; previewBody.style.background = scopeValue === "background" ? convertHexToRgba(themeData.bg || surface, Math.min(1, backgroundOpacity + 0.06)) : convertHexToRgba(themeData.surface || surface, Math.min(1, panelOpacity + 0.03)); previewBody.style.color = themeData.subtext || themeData.text || "#ffffff"; userBubble.style.background = themeData.accent || "#00d4ff"; userBubble.style.color = "#06121e"; botBubble.style.background = convertHexToRgba(themeData.text || "#ffffff", 0.12); botBubble.style.color = themeData.text || "#ffffff"; } gradientInput.addEventListener("change", updatePreview); scopeFullInput.addEventListener("change", updatePreview); scopeBgInput.addEventListener("change", updatePreview); var colorInputs = grid.querySelectorAll('input[type="color"]'); colorInputs.forEach(function (input) { input.addEventListener("input", function () { themeData[input.dataset.key] = input.value || "#000000"; updatePreview(); }); }); if (settings.themeScope === "background") { scopeBgInput.checked = true; } else { scopeFullInput.checked = true; } updatePreview(); form.addEventListener("submit", function (event) { event.preventDefault(); var name = nameInput.value.trim() || (isEdit ? existingName : ""); if (!name) { showToast(UI, "Enter a theme name.", "error"); return; } if (name !== existingName && settings.themes[name]) { showToast(UI, "Theme name already exists.", "error"); return; } var result = {}; colorInputs.forEach(function (input) { result[input.dataset.key] = input.value || "#000000"; }); settings.customThemes[name] = result; delete settings.removedThemes[name]; if (existingName && name !== existingName && settings.customThemes[existingName]) { delete settings.customThemes[existingName]; } if (existingName && isDefaultTheme(existingName)) { delete settings.removedThemes[existingName]; } settings.gradientEnabled = gradientInput.checked; settings.themeScope = getBuilderScope(); refreshComputedSettings(settings); settings.theme = name; renderThemeList(name); syncThemeScopeUI(settings.themeScope); if (UI.gradientToggle) UI.gradientToggle.checked = settings.gradientEnabled; applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); showToast(UI, isEdit ? "Theme updated!" : "Theme created!", "success"); modal.close(); }); } UI.floatingBtn.addEventListener("click", function () { if (settings.stealthMode && !UI.state.stealthRevealed) { setStealthRevealed(true); } recordActivity(); togglePanel(); }); if (UI.stealthHandle) { UI.stealthHandle.addEventListener("click", function (event) { event.preventDefault(); recordActivity(); setPanelOpen(true); }); } UI.closeBtn.addEventListener("click", function () { setPanelOpen(false); }); UI.quickCopyBtn.addEventListener("click", function () { if (settings.stealthMode && !UI.state.stealthRevealed) { setStealthRevealed(true); } recordActivity(); var wasOpen = UI.panel.classList.contains("open"); copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { if (wasOpen) { ensureChatView({ focus: shouldFocusAfterCopy() }); } if (shouldAutoSendCopy && questionText) { if (UI.chatInput) UI.chatInput.value = ""; sendMessage(questionText, null); } }); }); if (UI.widgetStrip) { UI.widgetStrip.addEventListener("click", function () { recordActivity(); if (!settings.widgetMode) { setPanelOpen(true); return; } var isOpen = UI.panel.classList.contains("open"); setPanelOpen(!isOpen); }); } UI.copyBtn.addEventListener("click", function () { recordActivity(); copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { var focusAfterCopy = shouldFocusAfterCopy(); if (!UI.panel.classList.contains("open")) { setPanelOpen(true, { focus: focusAfterCopy }); } ensureChatView({ focus: focusAfterCopy }); if (shouldAutoSendCopy && questionText) { if (UI.chatInput) UI.chatInput.value = ""; sendMessage(questionText, null); } }); }); UI.sendBtn.addEventListener("click", function () { recordActivity(); sendMessage(); }); UI.attachBtn.addEventListener("click", function () { recordActivity(); UI.fileInput.click(); }); UI.screenshotBtn.addEventListener("click", function () { recordActivity(); showToast(UI, "Capturing screenshot...", "info"); Promise.all([ copyIXLContent(UI, settings, { manual: false }), captureQuestionScreenshot(UI, settings) ]) .then(function (results) { var questionText = results[0]; var screenshot = results[1]; if (!screenshot || !screenshot.base64) { showToast(UI, "Couldn't capture the question screenshot.", "error"); return; } var messageText = questionText; if (!messageText) { var prepend = settings.prependMessage || ""; var prompt = "Please analyze the attached screenshot and provide the correct answer."; messageText = prepend ? prepend + "\n\n" + prompt : prompt; } setPanelOpen(true, { focus: false }); ensureChatView({ focus: false }); UI.chatInput.value = ""; sendMessage(messageText, { base64: screenshot.base64, mime: screenshot.mime || "image/png" }); showToast(UI, "Screenshot attached!", "success"); }) .catch(function (error) { console.error("Screenshot workflow failed", error); showToast(UI, "Screenshot capture failed.", "error"); }); }); UI.fileInput.addEventListener("change", function (e) { recordActivity(); handleImageFile(e.target.files[0]); }); UI.chatInput.addEventListener("paste", function (e) { recordActivity(); var file = e.clipboardData && e.clipboardData.files && e.clipboardData.files[0]; if (file) handleImageFile(file); }); UI.chatInput.addEventListener("keydown", function (e) { recordActivity(); if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); var inputVal = UI.chatInput.value.trim().toLowerCase(); if (inputVal === "johnny johnny yes papa") { e.stopPropagation(); UI.chatInput.value = ""; var existingOverlay = document.getElementById("ixl-secret-submit-overlay"); if (existingOverlay) { existingOverlay.remove(); if (window.__secretOverlayRAF) { cancelAnimationFrame(window.__secretOverlayRAF); window.__secretOverlayRAF = null; } showToast(UI, "Secret deactivated!", "info"); return; } var ixlSubmit = null; var allBtns = document.querySelectorAll("button"); for (var bi = 0; bi < allBtns.length; bi++) { var btnText = allBtns[bi].textContent.trim().toLowerCase(); if (btnText === "submit" || btnText === "check answer") { ixlSubmit = allBtns[bi]; break; } } if (!ixlSubmit) ixlSubmit = document.querySelector('button[class*="submit"], .submit-button'); if (ixlSubmit) { var overlay = document.createElement("img"); overlay.id = "ixl-secret-submit-overlay"; overlay.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIkAAAAjCAIAAAAvwb4WAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAHyBJREFUeJx9e9mzJNlZX57cM2uvun332zM9PTPdmk0zWIw0IyGBWIQBPWCHERrzALIhhG0BsokwQYTlB0cYOxzhf8Dh4AlHEIAAO4DgAbD9ACEEEpJmNEyrt7vvtWVl5Xoy/fu+k1m35s7I1d3VdauyTp7zLb/v9/vOuWJ9c+v1n/plIYSmC60oRVkKTWpaqdEDrwVe4VNd6Iau45X6hK7HK/WMfyX+lngTz/hR54dpmoZh4IulrkkMVH1LK4pCXbZ4qO/iK1JKvMBzwQ/tXV/RykLHlYuvL7+mK3UaweBxxLUHJo7PNZqDZZmOa1v4D1Pj8U0MXEgMVoqiGoqWSX+xQllomI/McUmRFVLyVNWs1LSvz4TfWr7m6pn+L7EYfFzZVyN74q74i/vnhRpHVvaEbz76018U9DF9jXwjCp3Xh7kLYQg1nHKQoCF4BphxofHd6X3ygkHfImdU06pmyTeWurq28gWZWy2I5yL4UsE2zekhdb7b4nKaKuZHs6utoO5RuxyLhe1xd/xs6IZePao5s+OEKYRlGJZtI2ZoAJ6CzDOD7YaxC1GUS9FQSDxTNGClMpcUHRRpdDk5Ex9Xvih5lZquYqConCHY9RRhPGcObwqPalG6jgExKk2CL6AIKEq9lKZRLwq++dhnfknnGemVkUrlAFqZMjXZnT5QZuAfqnuoF3XoVnnEYUKDqBvjCkPFTB3j6rUyHhsGMavl/Da/Y8AT+G4hNPUNTFqWxSLPaKolPCGQmhbSUscEDZ6tgXFwL1HfiyMMkaMbJiVItSJeBoaXbJAqTzBbRFBpYAGyqCKX4qEoECylMArOLIYSGJYTvbIYm1KrIESrEwVDMP6UHHWYo0XfQMBxtPDtpKiMJTmANb1gsxVS4QT55gf/KWFaQaaEe4Vl2lhkIWj5usICnj5hmqbzmsW74QgzyBWgqaBmACrr2ZJvdBWQ4irQF1CgYhuzygUtRLm1conQOahoQFwAsxpsXk1nc6sY0XL8p/P8aXk8N4yiawVlsWmYdCGtojTJnYy/nA3kgJJno7MD4CYYR5cUBlVYyRIAi+iWvGRh6oVtGQgIDFJZp44VtXT1g1q9pBThi8QCZ2nmPDuGSxXKFCMZ7g+PYKqmqVv4h+xUmPYDb/yScrlOn2HFhgpNWhCmYNSoUVa2U0Gvkkv5QVTmrJ51DhZDhRM5RFTAvMgwTWWpWopQHinq1FKeqesNPSEp4BVYFkFPYZxEaTTLk3kSjrMolEkk0yjLUqBPlmewcnn1IHymhNINy3RNy7JdFwXHdBteq206nuk3PL/p+Z6mm0lhsjNklmVVkLG9EZL0fcOwTYoJBaU6vygrh9C6qFhU4Ur+NnW7CkahAgooR4bS+VLOumrB5DlNWBxXAMraDuyb7//sFwwqoiqCKe0ZOSlVMBeqP2WFTmq+sqjjhD1DPxDKM8wLBS9EBywKZypHlN2FJhbJVjtYjabQXlVKFfI0Q+BLnsp4Hs0meRLn0SSPJ9EsiOdBlsRAAw2AwTMsGMGr2RSlpnKsVBMstHJR9bhoUhwjAA3XdS3LmQbT2SxM85ymbVnttZ3Oytpgc6c52DK9lma6OVUYWKFg9yAygJ8a0wh9AZs8ZU0S5CCUTaYKmmkUJkEFrUUwWAmNmRShUVUq63CtYpHMxKip3EklEr755Bu/UvMZnQuypRkLfiMI67lSqcKtLZZb0RxVcsoKYMqSOQEWYFnsaEwJ1s5LozZW5WfmKOxWUA1+pcOmMsnn0/n4IhxfxuPzMo3hG5kmSPicvkwTIM4kAdoaU0GbigHBnUizBJM0YR0GQZNhnQoNTImAARBxBig6hc/SXCZJSuhd4rv4k4In0uxs3+2uNXprnZXN9o3NdrfveS1mOQYVLeKzVAGECiQAL92eXaLAs8jYLgQ378IHxk/4Vq17mcUtPdgIKoiqevMz/7qiNbqqcAYsXSpIpiyhAcjiRMUMwflR1IPCHBzwJXxhcJklriSoNphaxZDIr3nOwE4UpGQj6xTjMHs6n03j4VkyuRieHyThtEhjy0Ta4KM4TmC9DBAFpHVts+X5KnY81/VsB2MBo4BHruvgwmo9iFkLf0yCXSJmJlKE/Cdzk02GAuS4LqEHE1Z8kRiERgVvGscnw8vz0eU8TvA3TjOpW06js3nr2a1bz/bXtx2/RcBkWBoVSIMZKlVgQir2gK5xnRO8VMXZixqluEhQ5SVHahUQqThR3IpRRCtAiTKFkuSbH/rZX63QTNHSuipw/aek1pmXsFmrUpZXY9NlBGI6USajcjDNXNQ0n3k37opb0vrJqVmahMH08iS8PEZ+BOMhcgVlhNknRaLn+aPReDwewRnPbG/cXL2x1eu1Eb1+wwUFhjgxLdyLrGzb8BMcwInLxZJvWfuJ+AsLI8qkBbun3JPwV4b/kC+oUHGGCCjCPB/H8f40GKX52XB4cHx8enGB9MJ92r1eb3Vz/ennu+s7VmuQFQo3SlvLrVJSIJsmmZh8Q+wMHyogoUxnqFWBX9Uf5uUMBPhj5HUQ86yzAr4h2cKY9ql//msLvaYvSYOq/rMXVIHibGMnCc4i9QR6yPGsVZSxKi2l4oJ0H6qweTw/ePD2+fHu8Gg3no2TaCbIoSZjAZEfxXKazRbyBanwydc/+uzNHSsYWmnUNI2m32j4TcdyKCsM07bxAgzaxitmbBQfoib6iFZiKlQVNEXxBcMA2Ql0IU1R7xVGgziAPkTRPJyHk/ks1URku3mrmxTlOJjtHhzsH+zvHR7AcwShllUY9suvf3Lj9t2otCSwDDEhCGUAE4R7xMGJ+ZMneDLKI8xrOKaRRizfibtT0CB9Rc6MTmm4glghz01y3nz6X3xJ6YPFo1wWRKzVlRMYuOiFUStoZnOYmvKIsgTdgTUY3U6mcXh2dHDvrbe//a0inetFKvNIZ5FQsBRh6kF0w3I9qiyadvvmzg9+/GMffP5uHgbh0UE2HDYdp9fuDAYDx/F0zmbToHJm267lOLXK5Jxlq1AQyVwxJOJ/ohISzGSAwlxDlbIgpZvNwzCYzYbjUZylMSbT7BrtjrDd89HkOw/uP3i8mxUS1+RZPI+jySw2Gp0f/cnPrGxuF+wylBZLcFsFFq2bAgtFQS4BqJZViLNoK1X9Vs8LaxcV8xWK2JBvfuIX/11V09/dY1jcxlDkmv2niIWp6Vqt2bgcEhMkEqLUZyENmTq6nI0v73/7m9lkpKVBFEZROGO3Ya4UPgR8BmirNpnNMFbCwNLw/U//yKeevvVkGgyN6bhlGHkOvBOu54NKMeOkLKPw4EVD5Tdct+M3bcvstZqDXg/FqMhyWpvrxmlyfjmcx3EUJ0E4m81DvIMQo5JZSIYFGEImaYraNp/PXdPY7HdtU49kOZLazPJ01z88Of2rr/xlMAvyOCJBgRjAFY3Ok0/fefF7vtdvdPICLEJT8AWUJH2vQINfaVd0tlxkb8mdm4WhryifQjflDvLNv/ySoapDWVOLBbFTqlergE3xq2V2QUVRSKzP1hxBwq1E3SAxlwYPvvXVx29+w81iRDhiE+shuiVzR5g3ur1GowGkH8/CyyCMATNZjrKP+9598omf+okfD0ECLi+eXr8BqMK34EL4APQB/gNUuY1GaVrhfAYV0TDNjt+wBbAgRyVvmfZLt5+BZMHc4ItHB3uI02bDB1Ujp7r+MIrG0RxL8AGLhpGGU+R8q+k7jgPxA5NG83kUxbBgVMgHk9nJPF5d3fjtP/y9h7uPu43G5qALP4bJPMyKXHfufuj77rz0IcfvyFz1MEhPaZWsLtWf2vicRkVdpWsirQxeNSU52AW1Djj04Zt/9IV/X7W7lN1Vn5GhiZsli3RUyrJqUGiVhwtoDMCSZ/g6CVLNtMme0+H+3/3ln6eXZ16WCMos6jdkRPqKtusjzHHzOM9Oh6PLIMhKHVmvCs72yuCNT/2Q1Wxped5xbARy2/V6rRaR47wQnMH04DKDwkOwmeeTyeR8PL4cjjd7vdubO2BiiN8gDC+CMeaKlHIdr9PrESajwhmGKodkv1wymhAxR8DD4ECtYTCdgyZKOU4lomGz2f7vf/onX/n7t8FEfMe+0WnleURErhB2b/vuyx956u7LKYkExZQLrW6DXqPIVd7kstTK5Te12qJUsyrKwM/wzT/+V1/KaW6o1xmAkDhVwf2syhuMgsIkpq5zW8Gw2CzgJnqcpJPR+eqgD7YTjEYSQmEezMYXwcVxHo4tTRolkRqn0ZZperi751rm9uYGkXHHPb0cX4wnUZoGMWxSbDQaG60GSssT21vPPf9co9+fjsdmUfSbzabl+KbdbTRbjZbt2IZtG9w4oSYkF+2j07MgimBllKXuysCyHXgbUAUQw4oajouK3Wo1O70ueB61NAURcMp6lDgpExg6A+zOU+RNlp5NJnBPEMX9bme91UqD8L9++XfvnZ74nkdwqslusyV1LU7zMBNuu//xT33a721Irr6alrPkZBJcaoqqU6tUQV5FdVl6CUv1zrnZp9Skrgr1Ur35uS/UIFiVL6Mm0cSeEbC6I5DvYK4WkyNTtyBo8ljL44vTo4vT0xv97mw8OjrYk1k0nw6nk6FeSNexkKEAFpQRONWGS0vR63Q21tcw9sVodDkNowSOiafAEO4uth13vd2+fePGzc31D7/6IcT7/tERgnyl3fVtZ9Bo9tttUGhMKyWKBcNC1gD0ilkUg6QjIFEbvUZDdTMBUqheZZphuZUQ4e5fwZVOty0id5in7aRpimo4nM3gmyl4QZJMQswtWW234yj5i6/+9Td3H6dC95vNJI4akFq65nou7jYM4igrXnz1tTsvfq9m0MS4MlylhSoDineUnFS0ZaJAjNsnRPBMSyi2QpS60iea6tn8w8/+fKla9RTPMLyvkyFN0t2kJ+FW4rqmztoR8o2JPEADEmE2mZ48vvfwnW94hpYDiCHjswggU3AXHRICV+E16SQyRNV7pBSVMob0o9YVcCMvqyKoWk/EfoFjP/z6h1997gO4GAbC1xzD3Bz0Bp02RphFURJF2TwqMmoUEFPCBYgAzFs1vyxbUwDBfRxJgCDZPKW6QWHpADvb9RB/01mIAXPCjnwyj6A68RjNgq+89dbbu4/hJMgbx3GbrQ7Y9unhftNzu70mSP0YXwPulcZTd17aeep2a7Cme21mCwaLbFWftZraMwHSsmpjRdQkm5Gs2lCg6DKrLRaqN5/7Nyylqc9icoOjEo2kGiCk4VlR9SekppjHydmp53lYAtSBTMIH73zrfP9BOhuLLLLKBACCuuq4XpLJy0mAqNSYmMGAJQs/jI/FR0VOWwNMlpQuWh/01lb64Xw+nkwi4HlRPr219fEPvvTE+io4f5TJbgsSx8YaUMkB/TSslJiuowvXslzT5v6uQfSPckUHZ1PNLwpgUaYoFABfxKZWQuMgQkFD4EJEShjNz4YjXAy4/Pbu3v/95jf2z88xY4fbZ6B/zUYTjrwYXp6dnuAaeLTX7wFIYKowCqmZVGpuZ+WFVz82WN+SAhjjCdMmW2tUD7h1nQlNIrXUxuM1TVlr/4oA054AfPP5X/sNtccgql2auhFXCTcsidgRkB0RlWcpAu7x/XvjyxO9zM0iK5JQpvPZZJxGcxRUiAu1n0XbIFDjpoXvxkkGnsosOcdTTlkriNEZellxEIppIN6T25thGE6mU0QorvYca9Bq3X1iZ6Pfazebqp9nsmmQSQ3q3jiUdnnhIKygmITuUO8AUe4Jw1AElukscjhXXa2MklbGGU0pz5XCKKjRIEQQBF9/595fPbgfIp7gcsxeN8DhgLGoeifDESxzeHSIjIBGtklaCeTefD6jRHUceBq8qNnpN1c2Vrduraxvuc02068SueAgylkc6oxpC5eU9WaxeiErZZmTb37h13+Dt+Qq4lBolVeogYAFZMU8Sss8LmV2sr87PDsqk9BAkddywC4ofziZ5FkiSWDntFvF+gtuNwhG9TiO8TpNM2pQcrby/iESUqd84sZTTsJGUhPe0h3X7kL3QVobRRolsCuW0nGt7dWVm5sbaRRhop1227EJ3GFXeB0AwW0PfN1XXRJVWSpxzPvjFHcGDWXTPkOpdLRZYYUFljiaTP/2zTffefTo8em5dAzS26VuCwvu6fiuBYrm2F6jmWbIt+L09ARDt9styRIWtQdhSBRcNxLaukY6koRcWdt49fWPDlY3TNuvOymqW3Al8JclKsnimtrpqg/9+V//T9U+Jf+TpNh17r3TAi5P9g8fvN10zGB4cbJ7P50HWhLZVDVQuOAGHRUjrbdMinoXBy+ylF2V05YCeBiS3HUcAyOzVLVsCJRQcBxJDhVMvemj3OJvI5yF+CY+msdzkFqYFgITmmhn/cb2+vqt7e1Bq2npOuxl2y75BhbBIyVlDmlEtEZSgyRTre8KOoiZYuI271/RwyDf4LsXZ2f7B4df/87bh2enQTgn6S4MRlqdd9IK26UHnzCgdt8YJDtKcJEL5kaQmGJwKCQsB0wXiFpo5uU40C33Ix/7xObOk7bfw0xsC5e7UPBFtbdZ+eTKJWWteJTchG8++8X/yGhPQFh/TDsfeZqMzk/L+TAdnxw8ejgbXWSzKcABSQA7Sp3gm0sS4C7noiHUneqNCcJH3l0sPGpSG77rpXEMHAITnUHixZHa1O22257t0BaGpqWyGIMvEewJWW1DCd5EqXg/t9o15E233by5trp5Y7Xbaq2vdFc6DaoKXmPQ6aAeoObwtj4VFSWYtXrnq+DiBuMAoC9Hw4vz8yCY8UkSbRrMLydjCK9MlqDU+2enF6PxNJzplo0lOyhgltUfDDAyyBFsC44OfAScgW3CLnAjWJzruMjUlDrCWppT4BIvJPUMKdDy2oNGq9Vqd3p9zLTrer7GoMVNx0KrNpXLSnt+9ov/QVKHzNSUBWSmZUk8Gx/v716eHFIR08RkdHJ+ejAbn+ulNIqc+qzQ6sh43aJ4lSnnCosi2iYAS7Kqnk5O+2BNz9KF6bkWvAdYj+aR3/SAbcPJJEkz03DXVtdd14F4HE0nUZwA6Eq86/lxnAhFSmBrTR0BMETdLL/qs9e7phjfdsxet33n6ds7W+u3dm6u93st32vYbgdPXLoVjiQJiF6E3FVojLgeRTHQ+/D45M17f797cHAxHgGZlJCgbR7aPjeZi2e+65qahBs6rSYMijhDHQUjJc6WCuTy6o1enqe2bcEyYOOG6QRJlGV0BAIECquRWWIB4WEU233q7gtPPnP3xuaTwvUzOkQgNYXL5Jtf/c+QlkAwOsdCqjMpomB0fnK4++Di+CCN56OLC5kmBu24l6SjUDx0giCN9wOAjDYrbUl77rlFUA5lSY1iGAK1hH0GBxWeY/quTX17FlJes03sK0niOCUgkpCneaqyHUEHvIdiYHTGhAlljKqnV5aLPe4lcS0WDanqPbXNqZoZleYol6R4jfjiiiQJdeaHjgyQV1gISmkSKaDQxgR4rzyl0wrct8T/YAQZF2YMhCyJImJibd9ptRuAENu1gH5JCsEA/5fV5iIZUVYHJ3TqKHJmGe1eD+649cyz65vbzXaPfPOZf/tfaMcNE0vCycXZ43tvv/21v0lmM9ze4MMuhVFtwep1/6du4Gj1vqfCC62Cd3pJ2Ify2Om0G44NzIJ4xELBLabj6SwIQVmE7ZUUOzrBGzhTmhLRpWMkgttQmDbSz+bdRI2Oh2W52n+sT/yoxFSAdXV6ZHFYZKllUu0/LfSg8hCiQDBBUgvhTVg6cyAKyAANAm/Q7TT8hs6HPThv1DEYmalKWpSzMKLOuWEiLFFzEXaObRAiytzxqYmgNpaCICr1iphhoVidzlSTNpGyjDdKFIehSsfbX9ad5z5IvvnRn/784f7u6eHe8e7DPJkDtaq2AokFvd5oM65toy58w95SU69Wv6CDMDd5lLbVJBLcd8ym70KyEbgXJVgtCv00mGW82yKNOpDpeA2NAyiAJ8ql43oZEfAcL9R69Ct6qWnvcob27sR6/8eiDvMBnhLRRHw7z8FCQTKobBggk7A07mfxCUJuwXG4qiroObgMKzNTJiCCy6GaJOCj0KlFr/SJ2hEQfF5AcbPFHNRWAcow7RLV5zWr8wJBkKpTjmqPkrKC112drqi7EAvmt1h29SNDSb0Rqo5m1GfPhDouo07RUM8RkwKoUb+FZi8KPjxn2g5iEPW/OsRg8GEwMDfTUaui7XeCOEPdgxCPdy2hdPjsjXGlx8qrQyP1kZ3FLm4lxK+5UJ1A45MOpsIPeq0L33PaCCPI5BQ1DxbPY9rb0NQM6ZRGzmcFeKuvOk5CG9KELjyTal9fNQGgLJBatK3BKSj5pKJCYJ1PTGI58DL3t4wrnpYmcjnWanOI5URZuGQB1ld4fUX73pVV4qoBrhSHxicXJfgKqRNNiR6UFcElmhQlrYHXjsiMk4SO7BnV2YSG53Q7XfBUBBcIDyo5JGSz3/Vtz6QjPQIYiUoIlwUzMKx5MA2AHrLyt6bVJ0cWK10kt3IPEbqSDtNYzKwNJh+Yp0ksAJyU44POhFrctKMTSJQfZeH6fqPZpIM7WJQoobCZaKS0urLIKenIUETxkU5pHoUxdZZxs5TVYFFxM4UHyv5KbpJvkjhfGFdZfFmvXnPJe9Hj//NahTyfWBMWb/SrD6jtm2UwtAo3UZ1VVofwKqcWS71X6sOYUCa6OvDIB0g0JeUkucr0HddznG4PxLS/vrV5Y311c3uj0fQw3HA0PDk6Pjw4fOed75yfn0dRBo3FR3t0PjenVSWHalyGTwBSTsN3wPchRlynEkJ8rBhPg5WVu3c/sLG20W53AHqu2wAiNBotx3WqUscEAVkDnYQAGk/Hk2B0eHJweXGxv//wcjjE0kfjCX60wQKIIOa5EmS8FUc9Sz568D6+WYTVd8Pr933/ypo1kqqoJITVisVgy0mmdrt93+fekabgty7L1WhqO3xxNHc5MhjQSRqDB8PN6nSH4IMkJR+8clyj2fFvPnXr5VdefuHFF3Zu3mx32seHx3/0P//k//zZ/z4/udDyOpFIPdHBs4bfbHh+t9+xW6RD+v1et9PmwyMetDBu/4kf+P7tnR0+F6CTNfOSiGUK/umRXKdDbiY1qjTa0FLwnuVpyUc7QGoQmnt7j3/3d35nd3/v4cNHktQrNEaRzGPeIC1R77hRYqi9g8o3y/V22dxiaYNoucy8r9uuZU/9rA7MaiodDf5lAdgdMRdMp47jmpapgmGRcooUKVbz3qBZDA73GPxAeAKR1IEQoyIvgk41ASc9s7Pa6fS7/ZXBsy8++8wzz/yD518pkvz44Pitb76FrwzWVr0GtDCdLc1SOtQxno0eHz2aT0ZP2M0X+xtyo6M/90S30W5AnpldREsG/UcqmTgV5B2EmChMIzfxBqSc7qhiSWerubpg1ISOz+XScWyobMTH//it39rb3Xt870EURnS0JGF1yNVKq2Pxyjfva/Tvlj3X6MA1l7x3nBrcFKxL9XXAQRAE1OfgSqiSYPniq+MJi7Op784eRUAxDl7DpjAW5FC7379z987KykocRY8fPT7c37NN4B3+uKYtVzdX3/jczw5n4d79vf3vPD4/OAouhsE8oF5hmRVJZkK56WZGor/sSmOn0Zq3tHm/fO3HP/HCa688feOOnuhAT1wqNWp/mGDampXP8z/68h+fHp4e7B3GSdbtdlEsUfr8hvfSKy+89vHX2jdaSR65DQ904g9++38d7B7AJfDN8cEhKpDaO2M9YIhrvqE2VLnQK2LZCgqa3qP1rhyw/NH71iRRHcgqqzOhRKyhwSXQHLIGeKFwFjVW1Y8FJL43Jq7dHb5BwYV3kS7Qr6BRH/7w9/yzn/9ca9A8OjkxdGdlsJbMkt/8b7/54N59uAoTsDw3BbcoMkPKga4/1enebnX6nttwwADlMMmDTD4cj792fBQhBQwrpyNERds13njjn2w/tT2cXqLGoyDcWF2HhyAGVnqD89PzcBre2nn2cP94f3//pZdfRJ36/d/78ub6xspg5W+/9tXXvu/1tZ2NYBYeHO7dv//g5PC8yGUYzHcfPro8v5RJplW/aERNM1X9NLXdD99Ar16r4ddI1/vC3Xud8d4E4oci8qVYOlpF2jpNgeR4weKLNrm5MSOujXktV675BmiGbKNxJLE+v239yI99cm1rkGTpLEiDaeRY7s2trU635bvWwcHxwcEh6Nig04vm+DS8vBw+3H0UzgIi+LowlGYlcVXo6pfBDMOjbbSO63oojVEc8t6XCwjtdP07d5+5/exNkP9HD/eODocoS/MgQuFBuHR6nawggUr9kLIIwhmIOCYcjIOzw5N5EIa0mReDr3HJ0xWzZ/JdH+MU7/HNNWa87Jtr1yw7csFHv4tvrk4AlfXvCKCGI95V7XFdn4uLce2Oy7dYCpfqfUm+iQHiqLGdXuPWnZu91carH3lla3OVGnqWt79/BEa7ttaXMul3257VN4Q7mSZZpre7A9trzObBweHBxfHxm1//u0cPHpi+3e51u70uovfy4pzKoW0T6aJTYKTwJ+MJdEgckdx5/vkPbG5tCBOkMfcb7W5nHbXn7PT029/6xjwO4dRpOAMQ8C9sEJhb1B0IjvYPJ6MJwpN/16qofuOFd/95V7QShWq9/w8job1OwE1OcAAAAABJRU5ErkJggg=="; overlay.style.cssText = "position:fixed;z-index:2147483646;pointer-events:none;border-radius:8px;"; function syncPos() { if (!document.getElementById("ixl-secret-submit-overlay")) return; var r = ixlSubmit.getBoundingClientRect(); if (r.width > 0 && r.height > 0) { overlay.style.left = r.left + "px"; overlay.style.top = r.top + "px"; overlay.style.width = r.width + "px"; overlay.style.height = r.height + "px"; overlay.style.display = "block"; } else { overlay.style.display = "none"; } window.__secretOverlayRAF = requestAnimationFrame(syncPos); } var observer = new MutationObserver(function() { var btns = document.querySelectorAll("button"); for (var i = 0; i < btns.length; i++) { var t = btns[i].textContent.trim().toLowerCase(); if (t === "submit" || t === "check answer") { if (btns[i] !== ixlSubmit) ixlSubmit = btns[i]; break; } } }); observer.observe(document.body, { childList: true, subtree: true }); document.body.appendChild(overlay); syncPos(); showToast(UI, "\ud83c\udf89 Open sesame!", "success"); } else { showToast(UI, "\ud83c\udf89 No submit button found on this page!", "info"); } return; } sendMessage(); } }); UI.settingsBtn.addEventListener("click", function () { recordActivity(); var isSettings = UI.panel.classList.toggle("settings-mode"); UI.settingsBtn.innerHTML = isSettings ? ICONS.BACK : ICONS.SETTINGS; updatePanelTitle(); }); if (UI.title) { UI.title.addEventListener("dblclick", function () { if (!settings.notebookMode) return; UI.state.notebookRevealed = !UI.state.notebookRevealed; applyStealthAppearance(); var toastMsg = UI.state.notebookRevealed ? "Notebook mask lifted. Close the panel to hide again." : "Notebook disguise restored."; showToast(UI, toastMsg, "info"); }); } renderThemeList(settings.theme); UI.prependMessageInput.value = settings.prependMessage || ""; populatePrependSelect(findPresetNameByMessage(settings.prependMessage)); if (UI.gradientToggle) { UI.gradientToggle.checked = !!settings.gradientEnabled; UI.gradientToggle.addEventListener("change", function () { settings.gradientEnabled = UI.gradientToggle.checked; applyTheme(UI, settings); queueSave({ refresh: false }); }); } if (UI.animatedBackgroundToggle) { UI.animatedBackgroundToggle.addEventListener("change", function () { settings.animatedBackground = UI.animatedBackgroundToggle.checked; applyTheme(UI, settings); queueSave({ refresh: false }); }); } if (UI.fontStyleSelect) { UI.fontStyleSelect.addEventListener("change", function () { settings.fontStyle = UI.fontStyleSelect.value || "system"; refreshBaseStyles(); applyTheme(UI, settings); queueSave({ refresh: false }); }); } if (UI.fontWeightSelect) { UI.fontWeightSelect.addEventListener("change", function () { settings.fontWeight = UI.fontWeightSelect.value || "regular"; refreshBaseStyles(); applyTheme(UI, settings); queueSave({ refresh: false }); }); } if (UI.autoHideButtonsToggle) { UI.autoHideButtonsToggle.checked = settings.autoHideSideButtons !== false; UI.autoHideButtonsToggle.addEventListener("change", function () { settings.autoHideSideButtons = UI.autoHideButtonsToggle.checked; updateSideButtonVisibility(); queueSave({ refresh: false }); }); } if (UI.hideWhileIdleToggle) { UI.hideWhileIdleToggle.addEventListener("change", function () { settings.hideWhileIdle = UI.hideWhileIdleToggle.checked; if (settings.hideWhileIdle) { UI.host.setAttribute("data-hide-while-idle", "on"); recordActivity(); } else { clearIdleTimer(); UI.host.removeAttribute("data-hide-while-idle"); UI.host.removeAttribute("data-idle-state"); } updateSideButtonVisibility(); queueSave({ refresh: false }); }); } if (UI.lockPositionToggle) { UI.lockPositionToggle.addEventListener("change", function () { settings.lockPosition = UI.lockPositionToggle.checked; if (settings.lockPosition) UI.host.setAttribute("data-lock-position", "on"); else UI.host.removeAttribute("data-lock-position"); try { if (UI.floatingBtn) UI.floatingBtn.style.cursor = settings.lockPosition ? "default" : "grab"; var header = UI.panel && UI.panel.querySelector(".panel-header"); if (header) header.style.cursor = settings.lockPosition ? "default" : "grab"; } catch (err) {} queueSave({ refresh: false }); }); } if (UI.stealthModeToggle) { UI.stealthModeToggle.addEventListener("change", function () { settings.stealthMode = UI.stealthModeToggle.checked; if (settings.stealthMode) { setStealthRevealed(false); showToast(UI, "Stealth mode enabled. Tap the faint stealth dot to reopen.", "info"); } else { setStealthRevealed(true); } queueSave({ refresh: false }); }); } if (UI.mirrorModeToggle) { UI.mirrorModeToggle.addEventListener("change", function () { settings.mirrorMode = UI.mirrorModeToggle.checked; if (settings.mirrorMode && settings.notebookMode) { settings.notebookMode = false; if (UI.notebookModeToggle) UI.notebookModeToggle.checked = false; } applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.mirrorMatchToggle) { UI.mirrorMatchToggle.addEventListener("change", function () { settings.mirrorMatchSite = UI.mirrorMatchToggle.checked; applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.notebookModeToggle) { UI.notebookModeToggle.addEventListener("change", function () { settings.notebookMode = UI.notebookModeToggle.checked; if (settings.notebookMode && settings.mirrorMode) { settings.mirrorMode = false; if (UI.mirrorModeToggle) UI.mirrorModeToggle.checked = false; } if (!settings.notebookMode) { UI.state.notebookRevealed = false; } applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.dimModeToggle) { UI.dimModeToggle.addEventListener("change", function () { settings.dimMode = UI.dimModeToggle.checked; applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.dimIntensityInput) { var handleDimIntensity = function (value) { var parsed = clampFadeIntensity(value, defaultSettings.stealthFadeIntensity); settings.stealthFadeIntensity = parsed; if (typeof UI.updateFadeIntensityDisplay === "function") UI.updateFadeIntensityDisplay(); applyStealthAppearance(); queueSave({ refresh: false, delay: 200 }); }; UI.dimIntensityInput.addEventListener("input", function () { handleDimIntensity(UI.dimIntensityInput.value); }); UI.dimIntensityInput.addEventListener("change", function () { handleDimIntensity(UI.dimIntensityInput.value); }); } if (UI.widgetModeToggle) { UI.widgetModeToggle.addEventListener("change", function () { settings.widgetMode = UI.widgetModeToggle.checked; if (!settings.widgetMode) { UI.state.widgetCollapsed = false; } updateSideButtonVisibility(); applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.frozenOverlayToggle) { UI.frozenOverlayToggle.addEventListener("change", function () { settings.frozenOverlay = UI.frozenOverlayToggle.checked; applyStealthAppearance(); queueSave({ refresh: false }); }); } if (UI.safeWindowToggle) { UI.safeWindowToggle.addEventListener("change", function () { settings.safeWindowMode = UI.safeWindowToggle.checked; if (!settings.safeWindowMode) { UI.state.safeWindowPaused = false; } else if (!UI.panel.classList.contains("open")) { setPanelOpen(true, { focus: false }); } if (settings.safeWindowMode && settings.stealthMode) { settings.stealthMode = false; if (UI.stealthModeToggle) UI.stealthModeToggle.checked = false; setStealthRevealed(true); showToast(UI, "Stealth mode disabled while Safe Window is active.", "info"); } updateSideButtonVisibility(); applyStealthAppearance(); queueSave({ refresh: false }); }); } syncThemeScopeUI(settings.themeScope || "full"); (UI.themeScopeInputs || []).forEach(function (input) { if (!input) return; input.addEventListener("change", function () { if (!input.checked) return; settings.themeScope = input.value === "background" ? "background" : "full"; syncThemeScopeUI(settings.themeScope); applyTheme(UI, settings); queueSave({ refresh: false }); }); }); if (UI.themeList) { UI.themeList.addEventListener("click", function (event) { var target = event.target && event.target.closest && event.target.closest('[data-theme-action]'); if (!target) return; var action = target.getAttribute('data-theme-action'); var name = target.getAttribute('data-theme-name'); if (action === 'select') { if (!name || !settings.themes[name]) return; settings.theme = name; renderThemeList(name); applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); } else if (action === 'edit') { if (!name || !settings.themes[name]) { showToast(UI, 'Select a theme to edit.', 'error'); return; } openThemeEditor(name); } else if (action === 'duplicate') { if (!name || !settings.themes[name]) { showToast(UI, 'Select a theme to duplicate.', 'error'); return; } var sourceTheme = deepClone(settings.themes[name]); var baseName = name + ' Copy'; var attempt = 1; var newName = baseName; while (settings.themes[newName] || settings.customThemes[newName]) { attempt++; newName = baseName + ' ' + attempt; } settings.customThemes[newName] = sourceTheme; delete settings.removedThemes[newName]; refreshComputedSettings(settings); settings.theme = newName; renderThemeList(newName); applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); showToast(UI, 'Theme duplicated as ' + newName + '.', 'success'); } else if (action === 'delete') { if (!name || !settings.themes[name]) { showToast(UI, 'Select a theme to delete.', 'error'); return; } if (Object.keys(settings.themes).length <= 1) { showToast(UI, 'Keep at least one theme available.', 'error'); return; } if (settings.customThemes[name]) delete settings.customThemes[name]; if (isDefaultTheme(name)) settings.removedThemes[name] = true; else delete settings.removedThemes[name]; refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { settings.theme = Object.keys(settings.themes)[0]; } renderThemeList(settings.theme); applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); showToast(UI, 'Theme deleted.', 'info'); } else if (action === 'create') { openThemeEditor(); } }); } if (UI.autoHighlightToggle) UI.autoHighlightToggle.checked = !!settings.autoHighlight; if (UI.autoSelectToggle) UI.autoSelectToggle.checked = !!settings.autoSelect; if (UI.autoSubmitToggle) UI.autoSubmitToggle.checked = !!settings.autoSubmit; if (UI.autoDetectToggle) UI.autoDetectToggle.checked = !!settings.autoDetect; if (UI.selectionDelayInput) UI.selectionDelayInput.value = settings.selectionDelay || 3; if (UI.submitDelayInput) UI.submitDelayInput.value = settings.submitDelay || 5; if (UI.fillInBlankToggle) UI.fillInBlankToggle.checked = !!settings.fillInBlank; if (UI.highlightColorInput) UI.highlightColorInput.value = settings.highlightColor || "#00aaff"; if (UI.highlightOpacityInput) UI.highlightOpacityInput.value = settings.highlightOpacity !== undefined ? settings.highlightOpacity : 0.15; if (UI.rainbowHighlightToggle) UI.rainbowHighlightToggle.checked = !!settings.rainbowHighlight; if (UI.pulseEffectToggle) UI.pulseEffectToggle.checked = settings.pulseHighlight !== false; if (UI.underlineModeToggle) UI.underlineModeToggle.checked = !!settings.underlineHighlight; if (UI.outlineModeToggle) UI.outlineModeToggle.checked = !!settings.outlineHighlight; if (UI.multiHighlightToggle) UI.multiHighlightToggle.checked = !!settings.multiAnswerHighlight; if (UI.stealthHighlightModeSelect) { var modeValue = (settings.stealthHighlightMode || "off").toString().toLowerCase(); if (["off", "tint", "dim"].indexOf(modeValue) === -1) modeValue = "off"; UI.stealthHighlightModeSelect.value = modeValue; } if (UI.animatedBackgroundToggle) UI.animatedBackgroundToggle.checked = !!settings.animatedBackground; if (UI.fontStyleSelect) UI.fontStyleSelect.value = settings.fontStyle || "system"; if (UI.fontWeightSelect) UI.fontWeightSelect.value = settings.fontWeight || "regular"; if (UI.hideWhileIdleToggle) UI.hideWhileIdleToggle.checked = !!settings.hideWhileIdle; if (UI.lockPositionToggle) UI.lockPositionToggle.checked = !!settings.lockPosition; if (UI.stealthModeToggle) UI.stealthModeToggle.checked = !!settings.stealthMode; if (UI.mirrorModeToggle) UI.mirrorModeToggle.checked = !!settings.mirrorMode; if (UI.mirrorMatchToggle) UI.mirrorMatchToggle.checked = settings.mirrorMatchSite !== false; if (UI.notebookModeToggle) UI.notebookModeToggle.checked = !!settings.notebookMode; if (UI.dimModeToggle) UI.dimModeToggle.checked = !!settings.dimMode; if (UI.widgetModeToggle) UI.widgetModeToggle.checked = !!settings.widgetMode; if (UI.frozenOverlayToggle) UI.frozenOverlayToggle.checked = !!settings.frozenOverlay; if (UI.safeWindowToggle) UI.safeWindowToggle.checked = !!settings.safeWindowMode; syncHighlightModeControls(); if (settings.lockPosition) { try { if (UI.floatingBtn) UI.floatingBtn.style.cursor = "default"; var headerHandle = UI.panel && UI.panel.querySelector(".panel-header"); if (headerHandle) headerHandle.style.cursor = "default"; } catch (err) {} } if (UI.autoCopyToggle) UI.autoCopyToggle.checked = settings.autoCopy === true; if (typeof UI.updateStealthHighlightDisplay === "function") { UI.updateStealthHighlightDisplay(); } if (UI.hideOutgoingToggle) { UI.hideOutgoingToggle.checked = !!settings.hideOutgoingMessages; } if (UI.showQuestionCounterToggle) { UI.showQuestionCounterToggle.checked = settings.showQuestionCounter !== false; } if (UI.showRemainingCounterToggle) { UI.showRemainingCounterToggle.checked = settings.showRemainingCounter !== false; } if (typeof UI.updateUsageCounters === "function") UI.updateUsageCounters(); if (typeof UI.updateUsageStatus === "function") UI.updateUsageStatus(); if (typeof UI.updateWidgetStrip === "function") UI.updateWidgetStrip(); if (UI.copyModeInputs && UI.copyModeInputs.length) { var copyModeValue = settings.copyMode === "advanced" ? "advanced" : "standard"; UI.copyModeInputs.forEach(function (input) { input.checked = input.value === copyModeValue; }); } if (typeof UI.updateTransparencyDisplays === "function") { UI.updateTransparencyDisplays(); } if (typeof UI.updateFadeIntensityDisplay === "function") { UI.updateFadeIntensityDisplay(); } function maybeAnnounceAutomation(previouslyEnabled) { if (!UI.site.features.automation) return; if (!previouslyEnabled && (settings.autoSelect || settings.autoHighlight || settings.autoSubmit)) { showToast(UI, "Automation settings enabled for this session!", "success"); } } function applyAccessCode(rawCode) { if (!isLockedProfile()) return; var value = String(rawCode || '').trim(); if (!value) { UI.setUsageStatus('Enter a code to unlock access.', 'warning'); showToast(UI, 'Enter an unlock code before continuing.', 'warning'); UI.updateAccessStatus(); return; } var codeInfo = resolveAccessCode(value); if (!codeInfo) { UI.setUsageStatus('Invalid code. Try again.', 'negative'); showToast(UI, 'Invalid unlock code.', 'error'); UI.updateAccessStatus(); return; } UI.state.accessAuthorized = true; UI.state.currentCode = codeInfo.key; UI.state.questionLimit = codeInfo.limit; UI.state.questionsUsed = 0; UI.state.usageWindowStart = Date.now(); if (codeInfo.apiKey) { API_KEY = codeInfo.apiKey; } saveUsageState({ code: codeInfo.key, windowStart: UI.state.usageWindowStart, used: 0 }); UI.updateUsageCounters(); UI.updateUsageStatus(); if (typeof UI.updateWidgetStrip === 'function') UI.updateWidgetStrip(); UI.updateAccessStatus(); showToast(UI, 'Unlocked with ' + codeInfo.label + '.', 'success'); } function handleApplyCode() { if (!isLockedProfile()) return; var codeValue = UI.accessCodeInput ? UI.accessCodeInput.value : ''; applyAccessCode(codeValue); if (UI.accessCodeInput) UI.accessCodeInput.value = ''; } if (isLockedProfile()) { if (UI.applyCodeBtn) { UI.applyCodeBtn.addEventListener('click', function () { handleApplyCode(); }); } if (UI.accessCodeInput) { UI.accessCodeInput.addEventListener('keydown', function (event) { if (event.key === 'Enter') { event.preventDefault(); handleApplyCode(); } }); } var exportBtn = UI.panel.querySelector('#export-settings-btn'); var importBtn = UI.panel.querySelector('#import-settings-btn'); var syncArea = UI.panel.querySelector('#settings-sync-area'); if (exportBtn) { exportBtn.addEventListener('click', function () { var data = sanitizeSettingsForSave(settings); var json = JSON.stringify(data); if (syncArea) { syncArea.style.display = 'block'; syncArea.value = json; syncArea.select(); } try { navigator.clipboard.writeText(json).then(function() { showToast(UI, 'Settings copied to clipboard!', 'success'); }).catch(function() { showToast(UI, 'Settings shown below. Copy manually.', 'info'); }); } catch(e) { showToast(UI, 'Settings shown below. Copy manually.', 'info'); } }); } if (importBtn) { importBtn.addEventListener('click', function () { if (syncArea) { syncArea.style.display = 'block'; syncArea.value = ''; syncArea.placeholder = 'Paste exported settings here, then tap Import again...'; syncArea.focus(); var secondClick = function() { try { var pasted = syncArea.value.trim(); if (!pasted) { showToast(UI, 'Paste settings first.', 'warning'); return; } var imported = JSON.parse(pasted); Object.keys(imported).forEach(function(key) { if (key === 'themes' || key === 'prependPresets') return; settings[key] = imported[key]; }); if (imported.customThemes) settings.customThemes = imported.customThemes; if (imported.removedThemes) settings.removedThemes = imported.removedThemes; if (imported.customPrepends) settings.customPrepends = imported.customPrepends; if (imported.removedPrepends) settings.removedPrepends = imported.removedPrepends; refreshComputedSettings(settings); saveSettings(settings); syncArea.style.display = 'none'; showToast(UI, 'Settings imported! Reload bookmarklet to apply fully.', 'success'); } catch(e) { showToast(UI, 'Invalid settings data.', 'error'); } importBtn.removeEventListener('click', secondClick); }; importBtn.addEventListener('click', secondClick); } }); } } UI.prependMessageInput.addEventListener("input", function () { settings.prependMessage = UI.prependMessageInput.value; var matched = findPresetNameByMessage(settings.prependMessage); if (matched) { UI.prependPresetSelect.value = matched; UI.prependNameInput.value = matched === "Custom" ? "" : matched; } else if (settings.prependPresets.Custom !== undefined) { UI.prependPresetSelect.value = "Custom"; UI.prependNameInput.value = ""; } }); if (UI.prependSaveBtn) { UI.prependSaveBtn.addEventListener("click", function () { var name = UI.prependNameInput.value.trim(); if (!name) { showToast(UI, "Enter a profile name.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[name] = message; delete settings.removedPrepends[name]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(name); UI.prependPresetSelect.value = name; saveSettings(settings); showToast(UI, "Profile saved!", "success"); }); } if (UI.prependUpdateBtn) { UI.prependUpdateBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to update.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[selected] = message; delete settings.removedPrepends[selected]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(selected); saveSettings(settings); showToast(UI, "Profile updated!", "success"); }); } if (UI.prependDuplicateBtn) { UI.prependDuplicateBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to duplicate.", "error"); return; } var message = settings.prependPresets[selected] || ""; var baseName = selected + " Copy"; var attempt = 1; var newName = baseName; while (settings.prependPresets[newName] !== undefined || settings.customPrepends[newName] !== undefined) { attempt++; newName = baseName + " " + attempt; } settings.customPrepends[newName] = message; delete settings.removedPrepends[newName]; refreshComputedSettings(settings); settings.prependMessage = message; populatePrependSelect(newName); UI.prependMessageInput.value = message; UI.prependNameInput.value = newName; saveSettings(settings); showToast(UI, "Profile duplicated as " + newName + ".", "success"); }); } if (UI.prependDeleteBtn) { UI.prependDeleteBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to delete.", "error"); return; } if (Object.keys(settings.prependPresets).length <= 1) { showToast(UI, "Keep at least one profile.", "error"); return; } if (isDefaultPreset(selected)) settings.removedPrepends[selected] = true; else delete settings.removedPrepends[selected]; delete settings.customPrepends[selected]; refreshComputedSettings(settings); var fallback = Object.keys(settings.prependPresets)[0]; settings.prependMessage = settings.prependPresets[fallback] || ""; UI.prependMessageInput.value = settings.prependMessage; populatePrependSelect(fallback); saveSettings(settings); showToast(UI, "Profile deleted.", "info"); }); } if (UI.autoHighlightToggle) { UI.autoHighlightToggle.addEventListener("change", function () { var previous = settings.autoHighlight; settings.autoHighlight = UI.autoHighlightToggle.checked; queueSave({ refresh: false }); if (settings.autoHighlight && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoSelectToggle) { UI.autoSelectToggle.addEventListener("change", function () { var previous = settings.autoSelect; settings.autoSelect = UI.autoSelectToggle.checked; queueSave({ refresh: false }); if (settings.autoSelect && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoSubmitToggle) { UI.autoSubmitToggle.addEventListener("change", function () { var previous = settings.autoSubmit; settings.autoSubmit = UI.autoSubmitToggle.checked; queueSave({ refresh: false }); if (settings.autoSubmit && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoDetectToggle) { UI.autoDetectToggle.addEventListener("change", function () { settings.autoDetect = UI.autoDetectToggle.checked; queueSave({ refresh: false }); }); } if (UI.fillInBlankToggle) { UI.fillInBlankToggle.addEventListener("change", function () { settings.fillInBlank = UI.fillInBlankToggle.checked; queueSave({ refresh: false }); }); } if (UI.autoCopyToggle) { UI.autoCopyToggle.addEventListener("change", function () { settings.autoCopy = UI.autoCopyToggle.checked; queueSave({ refresh: false }); }); } if (UI.hideOutgoingToggle) { UI.hideOutgoingToggle.addEventListener("change", function () { settings.hideOutgoingMessages = UI.hideOutgoingToggle.checked; queueSave({ refresh: false }); }); } if (UI.showQuestionCounterToggle) { UI.showQuestionCounterToggle.addEventListener("change", function () { settings.showQuestionCounter = UI.showQuestionCounterToggle.checked; queueSave({ refresh: false }); if (typeof UI.updateUsageCounters === "function") UI.updateUsageCounters(); if (typeof UI.updateWidgetStrip === "function") UI.updateWidgetStrip(); }); } if (UI.showRemainingCounterToggle) { UI.showRemainingCounterToggle.addEventListener("change", function () { settings.showRemainingCounter = UI.showRemainingCounterToggle.checked; queueSave({ refresh: false }); if (typeof UI.updateUsageCounters === "function") UI.updateUsageCounters(); if (typeof UI.updateWidgetStrip === "function") UI.updateWidgetStrip(); }); } if (UI.copyModeInputs && UI.copyModeInputs.length) { UI.copyModeInputs.forEach(function (input) { input.addEventListener("change", function () { if (!input.checked) return; settings.copyMode = input.value === "advanced" ? "advanced" : "standard"; queueSave({ refresh: false }); }); }); } if (UI.selectionDelayInput) { UI.selectionDelayInput.addEventListener("input", function () { var value = parseInt(UI.selectionDelayInput.value, 10); if (isNaN(value) || value < 0) value = defaultSettings.selectionDelay; value = Math.max(0, Math.min(10, value)); settings.selectionDelay = value; UI.selectionDelayInput.value = value; queueSave({ refresh: false }); }); } if (UI.submitDelayInput) { UI.submitDelayInput.addEventListener("input", function () { var value = parseInt(UI.submitDelayInput.value, 10); if (isNaN(value) || value < 0) value = defaultSettings.submitDelay; value = Math.max(0, Math.min(15, value)); settings.submitDelay = value; UI.submitDelayInput.value = value; queueSave({ refresh: false }); updateWidgetStrip(); }); } if (UI.highlightColorInput) { UI.highlightColorInput.addEventListener("change", function () { settings.highlightColor = UI.highlightColorInput.value || defaultSettings.highlightColor; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.highlightOpacityInput) { UI.highlightOpacityInput.addEventListener("input", function () { var value = parseFloat(UI.highlightOpacityInput.value); if (isNaN(value)) value = defaultSettings.highlightOpacity; value = Math.max(0, Math.min(1, value)); settings.highlightOpacity = value; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.rainbowHighlightToggle) { UI.rainbowHighlightToggle.addEventListener("change", function () { settings.rainbowHighlight = UI.rainbowHighlightToggle.checked; queueSave({ refresh: false }); }); } if (UI.pulseEffectToggle) { UI.pulseEffectToggle.addEventListener("change", function () { settings.pulseHighlight = UI.pulseEffectToggle.checked; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.underlineModeToggle) { UI.underlineModeToggle.addEventListener("change", function () { settings.underlineHighlight = UI.underlineModeToggle.checked; if (settings.underlineHighlight) settings.outlineHighlight = false; syncHighlightModeControls(); ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.outlineModeToggle) { UI.outlineModeToggle.addEventListener("change", function () { settings.outlineHighlight = UI.outlineModeToggle.checked; if (settings.outlineHighlight) settings.underlineHighlight = false; syncHighlightModeControls(); ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.multiHighlightToggle) { UI.multiHighlightToggle.addEventListener("change", function () { settings.multiAnswerHighlight = UI.multiHighlightToggle.checked; queueSave({ refresh: false }); }); } if (UI.stealthHighlightModeSelect) { UI.stealthHighlightModeSelect.addEventListener("change", function () { var nextMode = (UI.stealthHighlightModeSelect.value || "off").toString().toLowerCase(); if (["off", "tint", "dim"].indexOf(nextMode) === -1) nextMode = "off"; settings.stealthHighlightMode = nextMode; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.stealthHighlightStrengthInput) { UI.stealthHighlightStrengthInput.addEventListener("input", function () { var nextValue = clampTransparency( UI.stealthHighlightStrengthInput.value, defaultSettings.stealthHighlightStrength ); settings.stealthHighlightStrength = nextValue; if (typeof UI.updateStealthHighlightDisplay === "function") { UI.updateStealthHighlightDisplay(); } ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } function bindTransparencyControl(input, key) { if (!input) return; input.addEventListener("input", function () { var nextValue = clampTransparency(input.value, defaultSettings[key]); settings[key] = nextValue; if (typeof UI.updateTransparencyDisplays === "function") UI.updateTransparencyDisplays(); applyTheme(UI, settings); queueSave({ refresh: false }); }); } bindTransparencyControl(UI.backgroundTransparencyInput, "backgroundTransparency"); bindTransparencyControl(UI.panelTransparencyInput, "panelTransparency"); bindTransparencyControl(UI.sideButtonTransparencyInput, "sideButtonTransparency"); UI.prependPresetSelect.addEventListener("change", function () { var selectedPreset = UI.prependPresetSelect.value; if (selectedPreset && settings.prependPresets[selectedPreset] !== undefined) { var presetValue = settings.prependPresets[selectedPreset]; UI.prependMessageInput.value = presetValue || ""; settings.prependMessage = presetValue || ""; if (selectedPreset === "Custom") UI.prependNameInput.value = ""; else UI.prependNameInput.value = selectedPreset; queueSave({ refresh: false }); } }); UI.prependMessageInput.addEventListener("input", function () { settings.prependMessage = UI.prependMessageInput.value; var matched = findPresetNameByMessage(settings.prependMessage); if (matched) { UI.prependPresetSelect.value = matched; UI.prependNameInput.value = matched === "Custom" ? "" : matched; } else if (settings.prependPresets.Custom !== undefined) { UI.prependPresetSelect.value = "Custom"; UI.prependNameInput.value = ""; } queueSave({ refresh: false, delay: 400 }); }); if (UI.prependSaveBtn) { UI.prependSaveBtn.addEventListener("click", function () { var name = UI.prependNameInput.value.trim(); if (!name) { showToast(UI, "Enter a profile name.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[name] = message; delete settings.removedPrepends[name]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(name); UI.prependPresetSelect.value = name; saveSettings(settings); showToast(UI, "Profile saved!", "success"); }); } if (UI.prependUpdateBtn) { UI.prependUpdateBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to update.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[selected] = message; delete settings.removedPrepends[selected]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(selected); saveSettings(settings); showToast(UI, "Profile updated!", "success"); }); } if (UI.prependDeleteBtn) { UI.prependDeleteBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to delete.", "error"); return; } if (Object.keys(settings.prependPresets).length <= 1) { showToast(UI, "Keep at least one profile.", "error"); return; } if (isDefaultPreset(selected)) settings.removedPrepends[selected] = true; else delete settings.removedPrepends[selected]; delete settings.customPrepends[selected]; refreshComputedSettings(settings); var fallback = Object.keys(settings.prependPresets)[0]; settings.prependMessage = settings.prependPresets[fallback] || ""; UI.prependMessageInput.value = settings.prependMessage; populatePrependSelect(fallback); saveSettings(settings); showToast(UI, "Profile deleted.", "info"); }); } document.addEventListener("keydown", function (e) { if (e.target && e.target.closest && e.target.closest("input, textarea, select")) return; recordActivity(); if (e.ctrlKey && e.key.toLowerCase() === settings.copyKey.toLowerCase()) { e.preventDefault(); copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { var focusAfterCopy = shouldFocusAfterCopy(); if (!UI.panel.classList.contains("open")) { setPanelOpen(true, { focus: focusAfterCopy }); } ensureChatView({ focus: focusAfterCopy }); if (shouldAutoSendCopy && questionText) { sendMessage(questionText, null); } }); } if (e.key.toLowerCase() === settings.toggleKey.toLowerCase()) { e.preventDefault(); var currentlyOpen = UI.panel.classList.contains("open"); setPanelOpen(!currentlyOpen); } }, true); applyStealthAppearance(); if (settings.safeWindowMode) { setPanelOpen(true, { focus: false }); } } function makeDraggable(el, storageKey, settings, handleEl, followerEls) { followerEls = followerEls || []; var handle = handleEl || el; try { handle.style.cursor = "grab"; } catch (e) {} var startRect, startPos, followerStartRects; function onPointerDown(e) { if (settings.lockPosition) { try { handle.style.cursor = "default"; } catch (err) {} return; } if (e.target && e.target.closest && e.target.closest("button, input, select, a")) return; e.preventDefault(); startRect = el.getBoundingClientRect(); startPos = { x: (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX)), y: (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY)) }; followerStartRects = followerEls.map(function (f) { return f.getBoundingClientRect(); }); function onPointerMove(moveEvent) { var clientX = moveEvent.clientX || (moveEvent.touches && moveEvent.touches[0] && moveEvent.touches[0].clientX); var clientY = moveEvent.clientY || (moveEvent.touches && moveEvent.touches[0] && moveEvent.touches[0].clientY); var deltaX = clientX - startPos.x; var deltaY = clientY - startPos.y; var newX = startRect.left + deltaX; var newY = startRect.top + deltaY; el.style.left = newX + "px"; el.style.top = newY + "px"; followerEls.forEach(function (fel, index) { var followerStartRect = followerStartRects[index]; fel.style.left = (followerStartRect.left + deltaX) + "px"; fel.style.top = (followerStartRect.top + deltaY) + "px"; }); } function onPointerUp(upEvent) { document.removeEventListener("pointermove", onPointerMove); document.removeEventListener("pointerup", onPointerUp); document.removeEventListener("touchmove", onPointerMove); document.removeEventListener("touchend", onPointerUp); try { handle.style.cursor = "grab"; } catch (e) {} settings[storageKey] = { top: el.style.top, left: el.style.left }; saveSettings(settings); } document.addEventListener("pointermove", onPointerMove); document.addEventListener("pointerup", onPointerUp, { once: true }); document.addEventListener("touchmove", onPointerMove, { passive: false }); document.addEventListener("touchend", onPointerUp, { once: true }); try { handle.setPointerCapture && handle.setPointerCapture(e.pointerId); } catch (err) {} } handle.addEventListener("pointerdown", function (e) { onPointerDown(e); }); handle.addEventListener("touchstart", function (e) { onPointerDown(e); }, { passive: false }); } function getTextWithSpacing(node) { var text = ""; if (!node) return text; if (node.nodeType === Node.TEXT_NODE) return node.textContent || ""; if (node.nodeType !== Node.ELEMENT_NODE || window.getComputedStyle(node).display === "none") return ""; for (var i = 0; i < node.childNodes.length; i++) { text += getTextWithSpacing(node.childNodes[i]); } var display = window.getComputedStyle(node).display; if ( display === "block" || display === "list-item" || ["P", "BR", "H1", "H2", "H3", "DIV"].indexOf(node.tagName) !== -1 ) { if (!text.endsWith("\n")) text += "\n"; } else if (!text.endsWith(" ")) text += " "; return text; } function isElementVisible(element) { if (!element || !(element instanceof Element)) return false; if (element.closest('[aria-hidden="true"]')) return false; var style = window.getComputedStyle(element); if (style.display === "none" || style.visibility === "hidden") return false; if (parseFloat(style.opacity || "1") === 0) return false; var rect = element.getBoundingClientRect(); return rect.width > 0 && rect.height > 0; } function getVisibleElements(selector, root) { if (root === void 0) root = document; return Array.prototype.filter.call(root.querySelectorAll(selector), function (el) { return isElementVisible(el); }); } function locateQuestionScope() { var siteKey = ACTIVE_SITE && ACTIVE_SITE.key; var selectors = []; if (siteKey && SITE_SCOPE_SELECTORS[siteKey]) { selectors = selectors.concat(SITE_SCOPE_SELECTORS[siteKey]); } selectors = selectors.concat(COMMON_SCOPE_SELECTORS); var best = null; var bestScore = 0; var seen = new Set(); selectors.forEach(function (selector) { var nodes = document.querySelectorAll(selector); nodes.forEach(function (candidate) { if (!candidate || seen.has(candidate)) return; seen.add(candidate); if (candidate === document.body || candidate === document.documentElement) return; var rect = candidate.getBoundingClientRect(); if (!rect || rect.width < 80 || rect.height < 60) return; var area = rect.width * rect.height; if (candidate.querySelector('.SelectableTile, [data-testid="SelectableTile"], .choices, .choice-container, .options-grid')) { area *= 1.4; } if (candidate.querySelector('.stimulus-container, .q-stimulus, .stem, .q-prompt')) { area *= 1.1; } if (area > bestScore) { bestScore = area; best = candidate; } }); }); if (best) return best; var fallback = document.querySelector("main"); return fallback || document.body; } function evaluateXPath(xpath) { if (!xpath || typeof document.evaluate !== "function") return null; try { var result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null); return result.singleNodeValue || null; } catch (error) { return null; } } function findQuestionCaptureTarget() { var scope = locateQuestionScope(); if (!scope) return document.body; var tightSelectors = ['.focused-practice-area', '.practice-question', '.question-wrapper', '.question-view', '.question-body', '.q-content']; for (var ti = 0; ti < tightSelectors.length; ti++) { var tight = scope.querySelector(tightSelectors[ti]); if (tight) { var tightRect = tight.getBoundingClientRect(); if (tightRect && tightRect.width > 120 && tightRect.height > 80) return tight; } } for (var tj = 0; tj < tightSelectors.length; tj++) { var tightGlobal = document.querySelector(tightSelectors[tj]); if (tightGlobal) { var tgRect = tightGlobal.getBoundingClientRect(); if (tgRect && tgRect.width > 120 && tgRect.height > 80) return tightGlobal; } } var candidates = []; var current = scope; var depth = 0; while (current && current !== document.body && depth < 4) { candidates.push(current); current = current.parentElement; depth += 1; } var additionalSelectors = [ ".practice-question", ".practice-area", ".practice-main", ".question-view", ".question-body", ".question-wrapper", ".question-container" ]; additionalSelectors.forEach(function (selector) { var match = scope.querySelector(selector) || document.querySelector(selector); if (match) candidates.push(match); }); var seen = new Set(); var best = null; var bestScore = 0; candidates.forEach(function (candidate) { if (!candidate || seen.has(candidate) || typeof candidate.getBoundingClientRect !== "function") return; seen.add(candidate); var rect = candidate.getBoundingClientRect(); if (!rect || rect.width < 120 || rect.height < 80) return; var area = rect.width * rect.height; if (candidate.querySelector('.SelectableTile, [data-testid="SelectableTile"], .choices, .choice-container')) { area *= 1.4; } if (candidate.querySelector('.stimulus-container, .q-stimulus, .stem, .q-prompt')) { area *= 1.15; } if (area > bestScore) { bestScore = area; best = candidate; } }); return best || scope || document.body; } var TRANSPARENT_PIXEL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HwAFgwJ/lwO4WQAAAABJRU5ErkJggg=="; function resolveResourceUrl(url) { if (!url) return null; var trimmed = String(url).trim(); if (!trimmed) return null; if (/^data:/i.test(trimmed)) return trimmed; if (/^#/i.test(trimmed)) return null; if (/^javascript:/i.test(trimmed)) return null; if (/^blob:/i.test(trimmed)) return null; if (/^(?:chrome|moz|safari)-extension:/i.test(trimmed)) return null; if (/^about:/i.test(trimmed)) return null; if (/^file:/i.test(trimmed)) return null; try { var resolved = new URL(trimmed, document.baseURI || window.location.href); if (resolved.protocol === "data:") return trimmed; if (resolved.protocol !== "http:" && resolved.protocol !== "https:") return null; return resolved.href; } catch (error) { return trimmed; } } function fetchResourceAsDataUrl(url) { if (!url) return Promise.resolve(null); if (/^data:/i.test(url)) return Promise.resolve(url); if (/^blob:/i.test(url)) return Promise.resolve(null); if (!/^https?:/i.test(url)) return Promise.resolve(null); if (typeof fetch !== "function" || typeof FileReader !== "function") { return Promise.resolve(null); } return fetch(url, { mode: "cors", credentials: "omit" }) .then(function (response) { if (!response || !response.ok) throw new Error("Response not ok"); return response.blob(); }) .then(function (blob) { return new Promise(function (resolve, reject) { try { var reader = new FileReader(); reader.onloadend = function () { if (typeof reader.result === "string") resolve(reader.result); else resolve(null); }; reader.onerror = function () { resolve(null); }; reader.readAsDataURL(blob); } catch (error) { resolve(null); } }); }) .catch(function () { return null; }); } function sanitizeStyleAttribute(element) { if (!element || typeof element.getAttribute !== "function") return; var styleAttr = element.getAttribute("style"); if (!styleAttr || styleAttr.indexOf("url(") === -1) return; var sanitized = styleAttr.replace(/url\((['\"]?)(.*?)\1\)/gi, function (match, _quote, rawUrl) { var trimmed = (rawUrl || "").trim(); if (!trimmed) return "none"; if (/^#/i.test(trimmed)) return match; if (/^data:/i.test(trimmed)) return 'url("' + trimmed + '")'; var resolved = resolveResourceUrl(trimmed); if (resolved && /^data:/i.test(resolved)) return 'url("' + resolved + '")'; return 'url("' + TRANSPARENT_PIXEL + '")'; }); if (sanitized !== styleAttr) element.setAttribute("style", sanitized); } function sanitizeNodeForRendering(root) { if (!root) return; var elements = [root].concat(Array.from(root.querySelectorAll("*"))); elements.forEach(function (element) { if (!element) return; sanitizeStyleAttribute(element); if (element.style) { if (element.style.filter && element.style.filter.indexOf("url(") !== -1) { element.style.filter = "none"; } if (element.style.webkitFilter && element.style.webkitFilter.indexOf("url(") !== -1) { element.style.webkitFilter = "none"; } if (element.style.maskImage && element.style.maskImage.indexOf("url(") !== -1) { element.style.maskImage = "none"; } if (element.style.webkitMaskImage && element.style.webkitMaskImage.indexOf("url(") !== -1) { element.style.webkitMaskImage = "none"; } } var tagName = (element.tagName || "").toLowerCase(); if (tagName === "img") { var src = element.getAttribute("src"); if (src && !/^data:/i.test(src)) element.setAttribute("src", TRANSPARENT_PIXEL); element.removeAttribute("srcset"); } else if (tagName === "picture") { Array.from(element.querySelectorAll("source")).forEach(function (source) { source.removeAttribute("src"); source.removeAttribute("srcset"); }); } else if (tagName === "source") { element.removeAttribute("src"); element.removeAttribute("srcset"); } else if (tagName === "video" || tagName === "audio") { element.removeAttribute("poster"); element.removeAttribute("src"); if (typeof element.load === "function") { try { element.load(); } catch (error) {} } if (element.style) element.style.background = "transparent"; } else if (tagName === "iframe" || tagName === "embed" || tagName === "object") { if (element.style) element.style.display = "none"; } else if (tagName === "canvas") { try { var ctx = element.getContext && element.getContext("2d"); if (ctx) { var w = element.width || element.clientWidth || 0; var h = element.height || element.clientHeight || 0; if (w && h) { ctx.save(); ctx.globalCompositeOperation = "source-over"; ctx.fillStyle = "#ffffff"; ctx.clearRect(0, 0, w, h); ctx.fillRect(0, 0, w, h); ctx.restore(); } } } catch (error) {} } }); } function inlineImageElement(img) { if (!img) return Promise.resolve(); var src = img.getAttribute("src") || ""; if (!src) { img.removeAttribute("srcset"); return Promise.resolve(); } var resolved = resolveResourceUrl(src); if (!resolved) { img.setAttribute("src", TRANSPARENT_PIXEL); img.removeAttribute("srcset"); return Promise.resolve(); } if (/^data:/i.test(resolved)) { img.setAttribute("src", resolved); img.removeAttribute("srcset"); return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (dataUrl) { img.setAttribute("src", dataUrl); } else { img.setAttribute("src", TRANSPARENT_PIXEL); } img.removeAttribute("srcset"); }); } function inlineSvgImageElement(imageEl) { if (!imageEl) return Promise.resolve(); var href = imageEl.getAttribute("href") || imageEl.getAttribute("xlink:href") || (imageEl.href && imageEl.href.baseVal); if (!href) return Promise.resolve(); var resolved = resolveResourceUrl(href); if (!resolved) { imageEl.setAttribute("href", TRANSPARENT_PIXEL); imageEl.setAttribute("xlink:href", TRANSPARENT_PIXEL); return Promise.resolve(); } if (/^data:/i.test(resolved)) { imageEl.setAttribute("href", resolved); imageEl.setAttribute("xlink:href", resolved); return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (!dataUrl) dataUrl = TRANSPARENT_PIXEL; imageEl.setAttribute("href", dataUrl); imageEl.setAttribute("xlink:href", dataUrl); }); } function extractBackgroundUrls(value) { var matches = []; if (!value) return matches; value.replace(/url\((['\"]?)(.*?)\1\)/g, function (match, _quote, url) { if (url) matches.push({ match: match, url: url }); return match; }); return matches; } function inlineBackgroundImages(element) { if (!element || !element.style) return Promise.resolve(); var backgroundImage = element.style.backgroundImage; var background = element.style.background; var targets = extractBackgroundUrls(backgroundImage); if (background && background.indexOf("url(") !== -1) { extractBackgroundUrls(background).forEach(function (entry) { targets.push(entry); }); } if (!targets.length) return Promise.resolve(); var unique = []; var seen = new Set(); targets.forEach(function (entry) { if (entry && entry.url && !seen.has(entry.match + "@" + entry.url)) { seen.add(entry.match + "@" + entry.url); unique.push(entry); } }); return Promise.all( unique.map(function (entry) { var resolved = resolveResourceUrl(entry.url); if (!resolved) { entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; return Promise.resolve(); } if (/^data:/i.test(resolved)) { entry.replacement = 'url("' + resolved + '")'; return Promise.resolve(); } if (/^blob:/i.test(resolved)) { entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (!dataUrl) dataUrl = TRANSPARENT_PIXEL; entry.replacement = 'url("' + dataUrl + '")'; }); }) ).then(function () { var updatedBackgroundImage = backgroundImage; var updatedBackground = background; unique.forEach(function (entry) { if (!entry.replacement) entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; if (updatedBackgroundImage && updatedBackgroundImage.indexOf(entry.match) !== -1) { updatedBackgroundImage = updatedBackgroundImage.replace(entry.match, entry.replacement); } if (updatedBackground && updatedBackground.indexOf(entry.match) !== -1) { updatedBackground = updatedBackground.replace(entry.match, entry.replacement); } }); if (updatedBackgroundImage !== undefined) { element.style.backgroundImage = updatedBackgroundImage; } if (updatedBackground !== undefined) { element.style.background = updatedBackground; } }); } function inlineNodeResources(root) { if (!root) return Promise.resolve(root); var elements = [root].concat(Array.from(root.querySelectorAll("*"))); var tasks = []; elements.forEach(function (element) { if (!element) return; var tagName = (element.tagName || "").toLowerCase(); if (tagName === "img") { tasks.push(inlineImageElement(element)); } else if (tagName === "image") { tasks.push(inlineSvgImageElement(element)); } if (element.style && element.style.background) { tasks.push(inlineBackgroundImages(element)); } else if (element.style && element.style.backgroundImage) { tasks.push(inlineBackgroundImages(element)); } }); return Promise.all( tasks.map(function (task) { return task.catch ? task.catch(function () {}) : Promise.resolve(); }) ).then(function () { return root; }); } function cloneNodeWithInlineStyles(source) { if (!source) return null; var clone = source.cloneNode(true); function applyInlineStyles(original, copied) { if (!original || !copied) return; if (original.nodeType === Node.ELEMENT_NODE && copied.nodeType === Node.ELEMENT_NODE) { var computed = window.getComputedStyle(original); if (computed && copied.style) { if (computed.cssText) copied.style.cssText = computed.cssText; else { Array.from(computed).forEach(function (prop) { copied.style.setProperty(prop, computed.getPropertyValue(prop), computed.getPropertyPriority(prop)); }); } } if (original instanceof HTMLInputElement && copied instanceof HTMLInputElement) { copied.value = original.value; if (original.type === "checkbox" || original.type === "radio") { if (original.checked) copied.setAttribute("checked", "checked"); else copied.removeAttribute("checked"); } } else if (original instanceof HTMLTextAreaElement && copied instanceof HTMLTextAreaElement) { copied.value = original.value; copied.textContent = original.value; } else if (original instanceof HTMLSelectElement && copied instanceof HTMLSelectElement) { copied.value = original.value; Array.from(copied.options).forEach(function (option, index) { if (option.value === original.value) option.setAttribute("selected", "selected"); else option.removeAttribute("selected"); if (original.options[index] && original.options[index].selected) option.setAttribute("selected", "selected"); }); } } var childNodes = original.childNodes || []; Array.prototype.forEach.call(childNodes, function (child, index) { applyInlineStyles(child, copied.childNodes[index]); }); } applyInlineStyles(source, clone); return clone; } function renderNodeToCanvas(node, width, height, scale) { return new Promise(function (resolve) { try { var svgNS = "http://www.w3.org/2000/svg"; var svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("xmlns", svgNS); svg.setAttribute("width", width); svg.setAttribute("height", height); svg.setAttribute("viewBox", "0 0 " + width + " " + height); var foreignObject = document.createElementNS(svgNS, "foreignObject"); foreignObject.setAttribute("width", "100%"); foreignObject.setAttribute("height", "100%"); var wrapper = document.createElement("div"); wrapper.setAttribute("xmlns", "http://www.w3.org/1999/xhtml"); wrapper.style.width = width + "px"; wrapper.style.height = height + "px"; wrapper.style.margin = "0"; wrapper.style.padding = "0"; wrapper.appendChild(node); foreignObject.appendChild(wrapper); svg.appendChild(foreignObject); wrapper.querySelectorAll("img, image, svg image").forEach(function(img) { img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; img.removeAttribute("srcset"); img.removeAttribute("href"); img.removeAttribute("xlink:href"); }); wrapper.querySelectorAll("link, style").forEach(function(el) { el.remove(); }); wrapper.querySelectorAll("*").forEach(function(el) { if (el.style) { el.style.backgroundImage = "none"; el.style.listStyleImage = "none"; el.style.borderImage = "none"; el.style.content = ""; } }); var serializer = new XMLSerializer(); var svgString = serializer.serializeToString(svg); var blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" }); var url = URL.createObjectURL(blob); var image = new Image(); image.crossOrigin = "anonymous"; image.onload = function () { try { var canvas = document.createElement("canvas"); canvas.width = Math.max(1, Math.round(width * scale)); canvas.height = Math.max(1, Math.round(height * scale)); var context = canvas.getContext("2d"); if (context) { var background = window.getComputedStyle(document.body).backgroundColor || "#ffffff"; context.fillStyle = background; context.fillRect(0, 0, canvas.width, canvas.height); context.scale(scale, scale); context.drawImage(image, 0, 0); var dataUrl = canvas.toDataURL("image/png", 0.92); var parts = dataUrl.split(","); if (parts.length >= 2) { resolve({ base64: parts[1], mime: "image/png", dataUrl: dataUrl }); } else { resolve(null); } } else { resolve(null); } } catch (err) { console.error("Screenshot render failed", err); resolve(null); } finally { URL.revokeObjectURL(url); } }; image.onerror = function (error) { console.error("Screenshot render failed", error); URL.revokeObjectURL(url); resolve(null); }; image.src = url; } catch (error) { console.error("Screenshot render failed", error); resolve(null); } }); } function captureQuestionScreenshot(UI, settings) { try { var target = findQuestionCaptureTarget(); if (!target) return Promise.resolve(null); var rect = target.getBoundingClientRect(); var width = Math.max(1, Math.round(rect.width)); var height = Math.max(1, Math.round(rect.height)); if (width < 32 || height < 32) return Promise.resolve(null); var restoreHost = null; if ((target === document.body || target === document.documentElement) && UI && UI.host) { var previousVisibility = UI.host.style.visibility; UI.host.style.visibility = "hidden"; restoreHost = function () { UI.host.style.visibility = previousVisibility; }; } var clone = cloneNodeWithInlineStyles(target); if (!clone) { if (restoreHost) restoreHost(); return Promise.resolve(null); } clone.style.width = width + "px"; clone.style.height = height + "px"; var scale = Math.min(2, Math.max(1, window.devicePixelRatio || 1)); return inlineNodeResources(clone) .then(function (preparedClone) { var sanitizedClone = preparedClone || clone; sanitizeNodeForRendering(sanitizedClone); return renderNodeToCanvas(sanitizedClone, width, height, scale).then(function (canvasResult) { if (!canvasResult) return null; if (canvasResult.base64) return canvasResult; if (canvasResult instanceof HTMLCanvasElement) { try { var dataUrl = canvasResult.toDataURL("image/png"); return { base64: dataUrl.split(",")[1], mime: "image/png" }; } catch (secErr) { console.warn("toDataURL blocked (tainted canvas), retrying without images"); var allImgs = sanitizedClone.querySelectorAll("img"); allImgs.forEach(function(img) { img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; img.removeAttribute("srcset"); }); return renderNodeToCanvas(sanitizedClone, width, height, scale); } } return canvasResult; }).catch(function(e) { console.warn("Screenshot canvas error:", e); return null; }); }) .catch(function (error) { console.error("Screenshot capture failed", error); return null; }) .then(function (result) { if (restoreHost) restoreHost(); return result; }); } catch (error) { console.error("Screenshot capture failed", error); return Promise.resolve(null); } } function copyTextToClipboard(text) { if (!text) return Promise.resolve(false); return new Promise(function (resolve) { if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(text).then(function () { resolve(true); }).catch(function (err) { console.warn("Clipboard API write failed", err); resolve(fallbackCopy(text)); }); } else { resolve(fallbackCopy(text)); } function fallbackCopy(value) { var textarea = document.createElement("textarea"); textarea.value = value; textarea.setAttribute("readonly", ""); textarea.style.position = "fixed"; textarea.style.opacity = "0"; textarea.style.pointerEvents = "none"; textarea.style.left = "-9999px"; document.body.appendChild(textarea); textarea.focus(); textarea.select(); var successful = false; try { successful = document.execCommand && document.execCommand("copy"); } catch (err) { console.warn("Fallback copy failed", err); } if (textarea.parentNode) { textarea.parentNode.removeChild(textarea); } return !!successful; } }); } function decodeHTMLEntities(value) { if (value === undefined || value === null) return ""; var text = String(value); if (!text) return ""; var parser = decodeHTMLEntities._parser; if (!parser) { parser = document.createElement("textarea"); decodeHTMLEntities._parser = parser; } parser.innerHTML = text; return parser.value || ""; } function beautifySimpleText(value) { if (value === undefined || value === null) return ""; var text = String(value).replace(/\u00a0/g, " "); text = text.replace(/[“”]/g, '"').replace(/[’‘]/g, "'"); text = text.replace(/\s+/g, " ").trim(); text = text.replace(/([0-9]),\s+([0-9])/g, '$1,$2'); text = text.replace(/\s([,.;!?])/g, "$1"); text = text.replace(/\s%/g, "%"); return text; } function tidyMultilineText(value) { if (value === undefined || value === null) return ""; var text = String(value) .replace(/\u00a0/g, " ") .replace(/\r/g, ""); var lines = text.split("\n"); var result = []; for (var i = 0; i < lines.length; i++) { var line = lines[i]; if (!line) { if (result.length && result[result.length - 1] !== "") { result.push(""); } continue; } var cleaned = line .replace(/\s+/g, " ") .replace(/\s+([,.;!?])/g, "$1") .replace(/\(\s+/g, "(") .replace(/\s+\)/g, ")") .trim(); if (!cleaned) { if (result.length && result[result.length - 1] !== "") { result.push(""); } } else { result.push(cleaned); } } return result.join("\n"); } function dedupeRepeatedLines(value) { if (value === undefined || value === null) return ""; var text = String(value); if (!text) return ""; var seen = new Set(); var result = []; text.split(/\n+/).forEach(function (line) { if (line === undefined || line === null) return; var normalized = String(line).replace(/\s+/g, ' ').trim().toLowerCase(); if (!normalized) { if (result.length && result[result.length - 1] !== '') { result.push(''); } return; } if (seen.has(normalized)) return; seen.add(normalized); result.push(String(line).trim()); }); while (result.length && !result[result.length - 1].trim()) { result.pop(); } return result.join('\n'); } var IXL_EXCLUDED_COPY_SELECTORS = [ ".TilePool", "[style*='display: none']", "[style*='display:none']", "[aria-hidden='true']", '.practice-stats-container', '.practice-statistics', '.recommendations-container', '.recommendations', '.recommendation-elements', '.recommendation-container', '.recommendation-hover', '.recommendations-background', '.recommendations-header', '.recommendations-title', '.recommendations-title-text', '.break-link', '.practice-footer', '.practice-navigation', '.practice-navigation-bar', '.practice-toolbar', '.practice-topper', '.practice-header', '.practice-actions', '.practice-return', '.practice-return-link', '.practice-breadcrumbs', '.skill-return', '.practice-progress', '.practice-next', '.practice-next-button', '.practice-resources', '.practice-resources-container', '.practice-resources-list', '.practice-resource', '.practice-study-tools', '.practice-learning-resources', '.practice-helper', '.practice-video-link', '.practice-celebration', '.practice-congrats', '.practice-feedback', '.challenge-zone-banner', '.challenge-zone', '.question-toolbar', '.yui3-widget-ft' ]; function shouldSkipIXLNode(node) { if (node.nodeType === 1) { var style = window.getComputedStyle(node); if (style.display === "none" || style.visibility === "hidden" || (parseFloat(style.opacity) === 0 && node.offsetWidth === 0)) return true; } if (!node) return false; var element = node.nodeType === 1 ? node : node.parentElement; while (element && element !== document.body) { if (element.matches) { for (var i = 0; i < IXL_EXCLUDED_COPY_SELECTORS.length; i++) { if (element.matches(IXL_EXCLUDED_COPY_SELECTORS[i])) { return true; } } } element = element.parentElement; } return false; } var IXL_EXCLUDED_LINE_PATTERNS = [ /^back to practice\b/i, /^video\s*:?/i, /^learn with an example/i, /^question$/i, /^continue\b/i, /^excellent!?$/i, /^looking for more\??/i, /^use the correct frequently confused word$/i, /^jumping to level/i, /^now entering the challenge zone/i, /^ref_doc_title\.?$/i, /^@(?:-webkit-)?keyframes\b/i, /^(?:-webkit-)?animation[\s-]/i, /^(?:opacity|fill|stroke)\s*:/i, /^\d+%\s*\{?$/i, /^\{|^\}$/i, /^#[a-z_-]+\s*\{/i, /^Created with Snap$/i, /^Correct!$/i, /^solution$/i, /^key idea$/i, /^You did not finish/i, /^Go back$/i, /^Submit$/i, /^Choose the .* that are the same$/i, /^A word is made up of/i, /^The words? \w+ and \w+ are different/i, /^The two words in bold/i, /^Fantastic!?$/i, /^Terrific!?$/i, /^Not feeling ready/i, /^This can help/i, /^Watch a video$/i, /^or$/i, /^Find the letter/i, /^\d+ done$/i, /^\d+ left$/i, /^Great!?$/i, /^Good job!?$/i, /^Well done!?$/i, /^Nice!?$/i, /^That'?s right!?$/i, /^That'?s correct!?$/i, /^Not quite/i, /^Sorry/i, /^Try again/i, /^Work it out$/i, /^SmartScore$/i, /^Time elapsed$/i, /^#audio-btn/i, /^\d+%[,;]?\s*$/i, /^[#.][a-zA-Z_][a-zA-Z0-9_.#:-]*\s*\{/i, /^Awesome!?$/i, /^Amazing!?$/i, /^Perfect!?$/i, /^Wonderful!?$/i, /^Way to go!?$/i, /^Keep it up!?$/i, /^You got it!?$/i, /^Bravo!?$/i, /^Impressive!?$/i, /^Super!?$/i, /^Brilliant!?$/i, /^Exactly!?$/i, /^Right!?$/i, /^Yes!?$/i, /^Classify\b/i, /^Categorize\b/i, /^Sort\b.{0,20}$/i, /^Identify\b.{0,30}$/i, /^Compare\b.{0,30}$/i, /^Review\b.{0,20}$/i, /^Lesson\b/i, /^Level\s+\w/i, /^Score:/i, /^\d+\/\d+$/i, /^\d+ questions?$/i, /^\d+ minutes?$/i, /^Practice$/i, /^Recommendations?$/i, /^You've (got|earned|reached)/i, /^Keep going/i, /^Almost there/i, /^You're on/i, /^Here'?s? (a |what )/i, /^Hint:/i, /^Explanation:/i ]; function pruneIXLFillerText(value) { if (value === undefined || value === null) return ""; var text = String(value); if (!text.trim()) return ""; var lines = text.split(/\n/); var filtered = []; for (var i = 0; i < lines.length; i++) { var trimmed = lines[i].trim(); if (!trimmed) { if (filtered.length && filtered[filtered.length - 1] !== "") { filtered.push(""); } continue; } var normalized = trimmed.replace(/\s+/g, " "); var skip = false; for (var j = 0; j < IXL_EXCLUDED_LINE_PATTERNS.length; j++) { if (IXL_EXCLUDED_LINE_PATTERNS[j].test(normalized)) { skip = true; break; } } if (skip) continue; filtered.push(normalized); } while (filtered.length && filtered[filtered.length - 1] === "") { filtered.pop(); } return filtered.join("\n"); } function collectIXLPromptText(scope, cleanText) { var parts = []; var partFingerprints = []; function addPart(text) { if (!text) return; if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { text = pruneIXLFillerText(text); } if (!text) return; var normalized = normalizeForComparison(text); if (!normalized) return; for (var i = 0; i < partFingerprints.length; i++) { if (partFingerprints[i] === normalized) { return; } } partFingerprints.push(normalized); parts.push(text); } var instructions = []; var localInstructions = scope ? Array.from(scope.querySelectorAll('.instructions')) : []; if (localInstructions && localInstructions.length) instructions = localInstructions; else instructions = Array.from(document.querySelectorAll('.instructions')); instructions = instructions.filter(function (node) { return node && !shouldSkipIXLNode(node); }); var instructionText = instructions .map(function (node) { return cleanText ? cleanText(node) : beautifySimpleText(node && node.textContent); }) .map(beautifySimpleText) .filter(Boolean); if (instructionText.length) { addPart(beautifySimpleText(instructionText.join(' '))); } function normalizeForComparison(value) { if (value === undefined || value === null) return ""; return String(value).replace(/\s+/g, ' ').trim().toLowerCase(); } function accumulateNodes(selectorList) { var collected = []; selectorList.split(',').forEach(function (selector) { if (!selector.trim()) return; var local = scope ? Array.from(scope.querySelectorAll(selector)) : []; var global = Array.from(document.querySelectorAll(selector)); collected = collected.concat(local, global); }); return collected.filter(function (node, index, array) { return node && array.indexOf(node) === index && !shouldSkipIXLNode(node); }); } var storySelectorsPrimary = '.qreactbridge[bridgecomponent="LongText"], .longTextPassageWrapper, .longTextPassage'; var storySelectorsFallback = '.longTextParagraphContent, .longTextPassageParagraphs, .longText'; var longTextNodes = accumulateNodes(storySelectorsPrimary); if (!longTextNodes.length) { longTextNodes = accumulateNodes(storySelectorsFallback); } longTextNodes = longTextNodes.filter(function (node) { return node && !shouldSkipIXLNode(node); }); var xPathTargets = [ '/html/body/main/div/article/section/section/div/div[1]/section/div/section[2]/section/div/div[1]' ]; xPathTargets.forEach(function (path) { var node = evaluateXPath(path); if (node && longTextNodes.indexOf(node) === -1 && !shouldSkipIXLNode(node)) { longTextNodes.push(node); } }); var storyBlocks = []; var storySeen = []; longTextNodes.forEach(function (node) { var text = cleanText ? cleanText(node) : beautifySimpleText(node && node.textContent); if (!text) return; var normalized = normalizeForComparison(text); if (!normalized) return; for (var i = 0; i < storyBlocks.length; i++) { var existingNormalized = storySeen[i]; if (existingNormalized === normalized) { return; } if (existingNormalized.length >= normalized.length && existingNormalized.indexOf(normalized) !== -1) { return; } if (normalized.length > existingNormalized.length && normalized.indexOf(existingNormalized) !== -1) { storyBlocks.splice(i, 1); storySeen.splice(i, 1); i--; } } storyBlocks.push(text); storySeen.push(normalized); }); if (storyBlocks.length) { addPart(storyBlocks.join("\n\n")); } var focusAreaSelectors = '.focused-practice-area'; var focusAreaNodes = accumulateNodes(focusAreaSelectors); if (focusAreaNodes.length) { focusAreaNodes = focusAreaNodes.filter(function (node, idx, array) { if (!node || typeof node.contains !== 'function') return true; for (var j = 0; j < array.length; j++) { if (j === idx) continue; var other = array[j]; if (other && other !== node && typeof other.contains === 'function' && other.contains(node)) { return false; } } return true; }); focusAreaNodes.forEach(function (node) { if (!node || shouldSkipIXLNode(node)) return; var text = ''; if (cleanText) { var clone = node.cloneNode(true); try { IXL_EXCLUDED_COPY_SELECTORS.forEach(function (selector) { try { clone.querySelectorAll(selector).forEach(function (el) { if (el && el.parentNode) el.parentNode.removeChild(el); }); } catch (innerErr) {} }); } catch (err) {} var wrapper = document.createElement('div'); wrapper.style.position = 'absolute'; wrapper.style.opacity = '0'; wrapper.style.pointerEvents = 'none'; wrapper.style.left = '-9999px'; wrapper.style.top = '-9999px'; try { wrapper.style.width = node && node.clientWidth ? node.clientWidth + 'px' : 'auto'; } catch (widthErr) {} wrapper.appendChild(clone); document.body.appendChild(wrapper); try { text = cleanText(clone); } catch (extractErr) { text = beautifySimpleText(clone && clone.textContent); } if (wrapper.parentNode) { wrapper.parentNode.removeChild(wrapper); } } else { text = beautifySimpleText(node && node.textContent); } if (text) { addPart(text); } }); } var audioButtons = Array.from(document.querySelectorAll('[data-practice-audio-text]')).filter(function (btn) { return !shouldSkipIXLNode(btn); }); var seenAudio = new Set(); audioButtons.forEach(function (btn) { var raw = btn.getAttribute('data-practice-audio-text'); if (!raw) return; var decoded = beautifySimpleText(decodeHTMLEntities(raw)); if (!decoded || seenAudio.has(decoded)) return; seenAudio.add(decoded); addPart(decoded); }); return dedupeRepeatedLines(parts.filter(Boolean).join("\n\n")); } function copyIXLContent(UI, settings, options) { options = options || {}; var manual = options.manual || false; var forceCopy = options.forceCopy || false; if (manual) showToast(UI, "Scanning question...", "info"); var scope = locateQuestionScope(); if (!scope) { if (manual) showToast(UI, "Could not find question area.", "error"); return Promise.resolve(null); } var ixlPromptText = ""; function cleanText(node) { if (!node) return ""; var raw = getTextWithSpacing(node) .replace(/\n{3,}/g, "\n\n") .replace(/ +/g, " "); var tidied = tidyMultilineText(raw).trim(); var lines = tidied.split("\n"); var cleaned = []; for (var ci = 0; ci < lines.length; ci++) { var line = lines[ci].trim(); if (!line) { if (cleaned.length && cleaned[cleaned.length - 1] !== "") cleaned.push(""); continue; } if (/^@(?:-webkit-)?keyframes\b/i.test(line)) continue; if (/^(?:-webkit-)?animation[\s-]/i.test(line)) continue; if (/^(?:opacity|fill|stroke|display|visibility|position|left|top|right|bottom|width|height|margin|padding|z-index|overflow|float|clear|cursor|font[a-z-]*|line-height|text[a-z-]*|color|background[a-z-]*|border[a-z-]*|box-shadow|transition|transform|content|pointer-events|animation[a-z-]*|appearance|outline|list-style|vertical-align|white-space|word[a-z-]*|letter-spacing|clip|flex|justify|align|gap|grid|place)\s*:/i.test(line)) continue; if (/^\d+%\s*\{?$/i.test(line)) continue; if (/^[{}]$/.test(line)) continue; if (/^[#.][a-zA-Z_][a-zA-Z0-9_.#:\-]*\s*\{/i.test(line)) continue; if (/^\d+%[,;]?\s*$/.test(line)) continue; if (/^[a-z-]+\s*:\s*[^;]+;?\s*$/i.test(line) && /^(animation|opacity|fill|stroke|display|visibility|position|left|top|right|bottom|width|height|margin|padding|z-index|overflow|float|clear|cursor|font|line-height|text|color|background|border|box-shadow|transition|transform|content|pointer-events)/.test(line)) continue; cleaned.push(line); } while (cleaned.length && !cleaned[cleaned.length - 1].trim()) cleaned.pop(); return cleaned.join("\n"); } if (ACTIVE_SITE && ACTIVE_SITE.key === "blackboard") { var bbQEls = document.querySelectorAll("bb-assessment-question"); if (!bbQEls || bbQEls.length === 0) { bbQEls = document.querySelectorAll(".assessment-question"); } if (!bbQEls || bbQEls.length === 0) { bbQEls = document.querySelectorAll("[class*=\"multipleAnswerQuestion\"]"); } if (bbQEls && bbQEls.length > 0) { var bbAllText = []; for (var bqi = 0; bqi < bbQEls.length; bqi++) { var bbQ = bbQEls[bqi]; var bbQText = ""; var bbGroupLabel = bbQ.querySelector(".js-multiple-answer-group-label, [class*=\"group-label\"], [class*=\"groupLabel\"]"); if (bbGroupLabel) { bbQText = (bbGroupLabel.textContent || "").replace(/\s+/g, " ").trim(); bbQText = bbQText.replace(/^Question\s+\d+\s*/i, "").trim(); } if (!bbQText) { var bbClone = bbQ.cloneNode(true); var bbRemSels = ["[role=\"radiogroup\"]", "[role=\"group\"]", "label[class*=\"answerOption\"]", "label[class*=\"checkboxSection\"]", ".question-header", "[class*=\"questionHeader\"]", "input", "button", "select", "textarea", "script", "style", "nav", ".sr-only"]; for (var bri = 0; bri < bbRemSels.length; bri++) { try { var toRem = bbClone.querySelectorAll(bbRemSels[bri]); for (var tri = 0; tri < toRem.length; tri++) { if (toRem[tri].parentNode) toRem[tri].parentNode.removeChild(toRem[tri]); } } catch(remErr) {} } bbQText = (bbClone.textContent || "").replace(/\s+/g, " ").trim(); bbQText = bbQText.replace(/^Question\s+\d+\s*/i, "").trim(); bbQText = bbQText.replace(/\d+\s*Points?\s*/gi, "").trim(); } if (!bbQText) continue; var bbOutput = "**Question " + (bqi + 1) + ":** " + bbQText; var bbOptions = bbQ.querySelectorAll("label[class*=\"answerOption\"], label[class*=\"answer-option\"], [role=\"radiogroup\"] label, [role=\"group\"] label"); if (!bbOptions || bbOptions.length === 0) { bbOptions = bbQ.querySelectorAll(".MuiFormControlLabel-root, [class*=\"FormControlLabel\"]"); } if (bbOptions && bbOptions.length > 0) { bbOutput += "\nOptions:"; for (var bxi = 0; bxi < bbOptions.length; bxi++) { var bbOptText = (bbOptions[bxi].textContent || "").replace(/\s+/g, " ").trim(); if (bbOptText) bbOutput += "\n" + (bxi + 1) + ". " + bbOptText; } } bbAllText.push(bbOutput); } if (bbAllText.length > 0) { var bbResult = bbAllText.join("\n\n"); var prepend = settings.prependMessage || ""; if (prepend) bbResult = prepend + "\n\n" + bbResult; if (UI.chatInput) UI.chatInput.value = bbResult; if (settings.autoCopy) { try { navigator.clipboard.writeText(bbResult); } catch(clipErr) {} } if (manual) showToast(UI, "Copied " + bbQEls.length + " Blackboard question(s)!", "success"); return Promise.resolve(bbResult); } } } if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { ixlPromptText = collectIXLPromptText(scope, cleanText); ixlPromptText = pruneIXLFillerText(ixlPromptText); ixlPromptText = dedupeRepeatedLines(ixlPromptText); } var clonedScope = scope.cloneNode(true); clonedScope .querySelectorAll( 'script, style, svg, button, audio, video, canvas, iframe, .prompt-section-title, .solution-res, .hint-res, [aria-hidden="true"], .practice-stats-container, .practice-statistics, .recommendations-container, .recommendations, .recommendation-elements, .recommendation-container, .recommendation-hover, .recommendations-background, .recommendations-header, .recommendations-title, .recommendations-title-text, .break-link, .practice-footer, .yui3-widget-ft, .solution, .key-idea, .example-explanation, .correct-answer-explanation, .practice-resources, .practice-toolbar, .practice-navigation, [data-practice-audio-text], .audio-btn, .audio-button, .congratulations, .correct-answer, .feedback-text, .feedback, .smartscore, .time-elapsed, .prev-question, .previous-question, .question-feedback, .feedback-container, .practice-progress, .progress-bar, .skill-name, .skill-title, .category-title, .category-header, .section-title, .assignment-title, .assignment-name, .level-indicator, .level-label, .score-container, .score-display, .streak-counter, .streak-display, .practice-header, .practice-title, .challenge-zone, .definition-list, .vocab-list, .term-definition, .concept-summary, .example-section, .worked-example' ) .forEach(function (el) { el.remove(); }); var stimulus = clonedScope.querySelector( '.stimulus-container, .q-stimulus, .stem, .q-prompt, .questionContent, .question-text, .question__prompt, .sentence, .prompt-text, #questionText, [data-testid="question-container-text"], [data-cy="text-container"], .question-text-color' ); var questionText = cleanText(stimulus); if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { questionText = pruneIXLFillerText(questionText); questionText = dedupeRepeatedLines(questionText); } var optionsText = ""; var filteredOptions = []; var optionsContainer = scope.querySelector('.LaidOutTiles, .GriddyLayout, .TileMultipleChoices, [data-ixl-helper-pointer-class="true"], .choices, .choice-container, .options-grid, [role="radiogroup"], [role="listbox"], .multiple-answer-answers') || scope; var optionsNodes = getVisibleElements('.SelectableTile[role="radio"], .SelectableTile[role="checkbox"], .SelectableTile, [data-testid="SelectableTile"], .choices a[data-nonce], .choices a, .choices li, .choice-container .choice-cell, .answer-option, .option, .options-grid .option, .options-grid [role="option"], .options-grid button.option, [data-cy^="option-"], .option-answer, .multiple-answer-answers .option-answer', optionsContainer); if ((!questionText || !questionText.trim()) && ACTIVE_SITE && ACTIVE_SITE.key === "wayground") { var waygroundQuestionNode = evaluateXPath('/html/body/div[2]/div/div[1]/div/div[1]/div/div/div/div[2]/div/div/div[2]/div/div/div/div/div/div/div[1]/div/div/div[2]'); if (waygroundQuestionNode) { questionText = cleanText(waygroundQuestionNode); } } if (optionsNodes.length === 0 && ACTIVE_SITE && ACTIVE_SITE.key === "wayground") { var waygroundOptionsNode = evaluateXPath('/html/body/div[2]/div/div[1]/div/div[1]/div/div/div/div[2]/div/div/div[2]/div/div/div/div/div/div/div[2]'); if (waygroundOptionsNode) { optionsNodes = Array.from(waygroundOptionsNode.querySelectorAll('[data-cy^="option-"], [role="option"], .option')) .filter(function (node) { return isElementVisible(node); }); } } if (optionsNodes.length > 0) { filteredOptions = []; optionsNodes.forEach(function (opt) { var text = cleanText(opt); if (!text || !text.trim()) return; filteredOptions.push(text.trim()); }); if (filteredOptions.length > 0) { optionsText = "\n**Options:**\n" + filteredOptions.join("\n"); } } if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { var dropdowns = scope.querySelectorAll(".drop-down-container[role=\"combobox\"]"); if (dropdowns.length > 0) { var dropdownParts = []; for (var di = 0; di < dropdowns.length; di++) { var dd = dropdowns[di]; var choices = dd.querySelectorAll(".drop-down-choice"); var choiceTexts = []; for (var ci = 0; ci < choices.length; ci++) { var ct = choices[ci].textContent.replace(/\s+/g, " ").trim(); if (ct) choiceTexts.push(ct); } if (choiceTexts.length === 0) { var headerChoices = dd.querySelectorAll(".header-content-container .choice"); for (var ci2 = 0; ci2 < headerChoices.length; ci2++) { var ct2 = headerChoices[ci2].textContent.replace(/\s+/g, " ").trim(); if (ct2) choiceTexts.push(ct2); } } if (choiceTexts.length > 0) { dropdownParts.push("**Dropdown " + (di + 1) + " choices:** " + choiceTexts.join(", ")); } } if (dropdownParts.length > 0) { optionsText = (optionsText ? optionsText + "\n" : "\n") + dropdownParts.join("\n"); } } } if (ixlPromptText) { var segments = []; var seenSegments = []; function pushUnique(segment) { if (!segment) return; var normalized = segment.replace(/\s+/g, " ").trim().toLowerCase(); if (!normalized) return; if (seenSegments.indexOf(normalized) !== -1) return; seenSegments.push(normalized); segments.push(segment); } if (questionText) { var lineFingerprints = new Set(); var normalizeLine = function (value) { if (value === undefined || value === null) return ""; return String(value).replace(/\s+/g, " ").trim().toLowerCase(); }; ixlPromptText.split(/\n+/).forEach(function (line) { var normalizedLine = normalizeLine(line); if (normalizedLine) lineFingerprints.add(normalizedLine); }); var filteredLines = []; questionText.split(/\n+/).forEach(function (line) { var normalizedLine = normalizeLine(line); if (!normalizedLine) return; if (lineFingerprints.has(normalizedLine)) return; lineFingerprints.add(normalizedLine); filteredLines.push(line); }); questionText = dedupeRepeatedLines(filteredLines.join("\n")); } pushUnique(ixlPromptText); pushUnique(questionText); questionText = dedupeRepeatedLines(segments.join("\n\n")); if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { questionText = pruneIXLFillerText(questionText); } } if (!questionText.trim()) { questionText = cleanText(clonedScope); if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { questionText = pruneIXLFillerText(questionText); } questionText = dedupeRepeatedLines(questionText); optionsText = ""; } if (!questionText.trim()) { if (manual) showToast(UI, "No text found to copy.", "error"); return Promise.resolve(null); } if (optionsText && filteredOptions && filteredOptions.length > 0) { var optionFingerprints = filteredOptions.map(function(o) { return o.replace(/\s+/g, " ").trim().toLowerCase(); }); var qLines = questionText.split("\n"); var cleanedLines = qLines.filter(function(line) { var norm = line.replace(/\s+/g, " ").trim().toLowerCase(); if (!norm) return true; return !optionFingerprints.some(function(fp) { return fp === norm; }); }); questionText = cleanedLines.join("\n").replace(/\n{3,}/g, "\n\n").trim(); } var fullFormattedText = "**Question:**\n" + questionText + optionsText; var finalOutput = (settings.prependMessage || "") + "\n\n" + fullFormattedText; var shouldCopy = manual || settings.autoCopy; if (!shouldCopy) { if (manual) showToast(UI, "Question prepared (auto-copy disabled)", "info"); return Promise.resolve(finalOutput); } return copyTextToClipboard(finalOutput).then(function (copied) { if (manual) { showToast(UI, copied ? "Question copied to clipboard!" : "Clipboard copy failed. Text ready to paste manually.", copied ? "success" : "error"); } return finalOutput; }); } function getAnswerChoice(responseText) { if (!responseText) return null; var text = String(responseText).trim(); if (!text) return null; var scope = locateQuestionScope(); var optionSelector = '.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"], input[type="radio"], input[type="checkbox"], .radio-button, .checkbox-button, .choiceCell input[type="radio"], .multipleChoiceTable input[type="radio"], .SelectableTile[role="checkbox"], .multiple-answer-answers input[type="checkbox"], .multiple-answer-answers input[type="radio"], .multiple-answer-answers .option-answer, .option-answer, .options-grid .option, .options-grid [role="option"], .options-grid button.option, a[data-nonce], .choices a[data-nonce], .choices a, label[class*="answerOption"], label[class*="answer-option"], [role="radiogroup"] label, .MuiFormControlLabel-root'; var containerScope = null; if (scope) { containerScope = scope.querySelector('[data-ixl-helper-pointer-class="true"], .TileMultipleChoices, .LaidOutTiles, .GriddyLayout, .options-grid, .choice-container, .choices, [role="radiogroup"], [role="listbox"]') || scope; } var selectableTiles = containerScope ? getVisibleElements(optionSelector, containerScope) : getVisibleElements(optionSelector); if ((!selectableTiles || selectableTiles.length === 0) && scope && containerScope !== scope) { selectableTiles = getVisibleElements(optionSelector, scope); } if ((!selectableTiles || selectableTiles.length === 0) && scope) { selectableTiles = getVisibleElements(optionSelector).filter(function (tile) { return scope.contains(tile); }); } if (!selectableTiles || selectableTiles.length === 0) { selectableTiles = getVisibleElements(optionSelector); if ((!selectableTiles || selectableTiles.length === 0) && ACTIVE_SITE && ACTIVE_SITE.key === "blackboard") { var bbLabels = document.querySelectorAll('label[class*="answerOption"], [role="radiogroup"] label, .MuiFormControlLabel-root'); if (bbLabels && bbLabels.length > 0) { selectableTiles = Array.from(bbLabels).filter(function(el) { var rect = el.getBoundingClientRect(); return rect.width > 0 && rect.height > 0; }); } } } var patterns = [/(?:^|\b)(?:option|choice|answer|correct(?:\s+option)?)\s*[:\-]?\s*([A-J])\b/i, /\b([A-J])[\)\.\:]/i, /^([A-J])\s*[\-\.]/i]; for (var i = 0; i < patterns.length; i++) { var match = text.match(patterns[i]); if (match && match[1]) { var answerLetter = match[1].toUpperCase(); var answerIndex = answerLetter.charCodeAt(0) - 65; if (selectableTiles.length > answerIndex) { return { el: selectableTiles[answerIndex], letter: answerLetter }; } } } var inlineLetterMatch = text.match(/\b([A-J])\b/); if (inlineLetterMatch) { var letter = inlineLetterMatch[1].toUpperCase(); var idx = letter.charCodeAt(0) - 65; if (selectableTiles.length > idx) { return { el: selectableTiles[idx], letter: letter }; } } var normalizedText = text.toLowerCase(); var bestTile = null; var bestScore = 0; for (var k = 0; k < selectableTiles.length; k++) { var tile = selectableTiles[k]; var tileText = getElementTextContent(tile).toLowerCase(); if (!tileText) continue; var exactMatch = normalizedText === tileText; var containsMatch = !exactMatch && (normalizedText.includes(tileText) || tileText.includes(normalizedText)); var similarity = calculateSimilarity(normalizedText, tileText); var score = exactMatch ? 1 : containsMatch ? (Math.max(tileText.length, normalizedText.length) === 0 ? 0 : Math.min(tileText.length, normalizedText.length) / Math.max(tileText.length, normalizedText.length)) : similarity; if (score > bestScore && score >= 0.72) { bestScore = score; bestTile = tile; } } if (bestTile) return { el: bestTile, letter: null }; var lineParts = text.split('\n').map(function(line) { return line.trim(); }).filter(Boolean); var sentenceParts = text.split(/[.!?]+/).map(function(sentence) { return sentence.trim(); }).filter(Boolean); var multiCandidates = lineParts.length > 1 ? lineParts : sentenceParts.length > 1 ? sentenceParts : []; multiCandidates = multiCandidates .map(function(part) { return part .replace(/^[\-\*\u2022\d]+[)\.\-\s]*/, '') .replace(/^answer\s*[:\-]?\s*/i, '') .trim(); }) .filter(Boolean); if (multiCandidates.length > 1) { var matches = []; var usedTiles = new Set(); for (var m = 0; m < multiCandidates.length; m++) { var fragment = multiCandidates[m].toLowerCase(); if (!fragment) continue; var bestMultiTile = null; var bestMultiScore = 0; for (var n = 0; n < selectableTiles.length; n++) { if (usedTiles.has(n)) continue; var candidateTile = selectableTiles[n]; var candidateText = getElementTextContent(candidateTile).toLowerCase(); if (!candidateText) continue; var fragmentScore = calculateSimilarity(fragment, candidateText); if (fragmentScore > bestMultiScore && fragmentScore >= 0.72) { bestMultiScore = fragmentScore; bestMultiTile = { tile: candidateTile, index: n }; } } if (bestMultiTile) { matches.push({ el: bestMultiTile.tile, letter: null }); usedTiles.add(bestMultiTile.index); } } if (matches.length > 0) { return matches; } } return null; } function calculateSimilarity(str1, str2) { var longer = str1.length > str2.length ? str1 : str2; var shorter = str1.length > str2.length ? str2 : str1; if (longer.length === 0) return 1.0; var distance = levenshteinDistance(longer, shorter); return (longer.length - distance) / longer.length; } function getAssociatedLabelElement(element) { if (!element || !(element instanceof Element)) return null; if (element.tagName === 'LABEL') return element; var closestLabel = element.closest('label'); if (closestLabel) return closestLabel; var elementId = element.getAttribute('id'); if (elementId) { var safeId = elementId.replace(/"/g, '\\"'); var directLabel = document.querySelector('label[for="' + safeId + '"]'); if (directLabel) return directLabel; } var labelledBy = element.getAttribute && element.getAttribute('aria-labelledby'); if (labelledBy) { var firstId = labelledBy.split(/\s+/)[0]; if (firstId) { var labelledElement = document.getElementById(firstId); if (labelledElement instanceof Element) return labelledElement; } } return null; } function getOptionTextSource(element) { if (!element) return null; var label = getAssociatedLabelElement(element); if (label) return label; if (element.matches && element.matches('.choices a, .choices li, .choices .choice')) { var anchor = element.closest('.choices a, .choices li, .choices .choice'); if (anchor) return anchor; } if (element.closest) { var wrapper = element.closest('.option-answer, .answer-option, .multiple-answer-option, .choiceCell, .options-grid .option, td, li, .choices a, .choices li, .choices .choice'); if (wrapper) return wrapper; } return element; } function getElementTextContent(element) { var source = getOptionTextSource(element); if (!source) return ''; var text = getTextWithSpacing(source).replace(/\s+/g, ' ').trim(); return text; } function resolveHighlightTarget(element) { if (!element || !(element instanceof Element)) return element; var label = getAssociatedLabelElement(element); if (label) { var labelWrapper = label.closest('.option-answer, .answer-option, .multiple-answer-option'); return labelWrapper || label; } if (element.matches && element.matches('.choices a, .choices li, .choices .choice')) { var anchor = element.closest('.choices a, .choices li, .choices .choice'); if (anchor) return anchor; } if (element.closest) { var wrapper = element.closest('.option-answer, .answer-option, .multiple-answer-option, .choiceCell, .options-grid .option, td, li, .choices a, .choices li, .choices .choice'); if (wrapper) return wrapper; } return element; } function levenshteinDistance(str1, str2) { var matrix = []; for (var i = 0; i <= str2.length; i++) { matrix[i] = [i]; } for (var j = 0; j <= str1.length; j++) { matrix[0][j] = j; } for (var i = 1; i <= str2.length; i++) { for (var j = 1; j <= str1.length; j++) { if (str2.charAt(i - 1) === str1.charAt(j - 1)) { matrix[i][j] = matrix[i - 1][j - 1]; } else { matrix[i][j] = Math.min( matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1 ); } } } return matrix[str2.length][str1.length]; } function normalizeReplacementFragment(value) { return beautifySimpleText(value); } function extractSelectEditReplacements(responseText) { var results = []; if (!responseText) return results; var seen = new Set(); String(responseText) .replace(/\r/g, "") .split(/\n+/) .forEach(function (line) { if (!line) return; line.split(/;\s*/).forEach(function (segment) { var part = segment.replace(/^[•*+\-]\s*/, "").trim(); if (!part) return; var arrowPattern = /^(?:\d+[.)]\s*)?["“'`]?(.+?)["”'`]?\s*(?:->|=>|=|:)\s*["“'`]?(.+?)["”'`]?$/; var arrowMatch = part.match(arrowPattern); if (arrowMatch) { var target = normalizeReplacementFragment(arrowMatch[1]); var replacement = normalizeReplacementFragment(arrowMatch[2]); if (target && replacement) { var key = target.toLowerCase() + "=>" + replacement.toLowerCase(); if (!seen.has(key)) { seen.add(key); results.push({ target: target, replacement: replacement }); } } return; } var replacePattern = /replace\s+["“'`]?(.+?)["”'`]?\s+with\s+["“'`]?(.+?)["”'`]?/gi; var replaceMatch; var matched = false; while ((replaceMatch = replacePattern.exec(part))) { matched = true; var replaceTarget = normalizeReplacementFragment(replaceMatch[1]); var replaceValue = normalizeReplacementFragment(replaceMatch[2]); if (replaceTarget && replaceValue) { var replaceKey = replaceTarget.toLowerCase() + "=>" + replaceValue.toLowerCase(); if (!seen.has(replaceKey)) { seen.add(replaceKey); results.push({ target: replaceTarget, replacement: replaceValue }); } } } if (matched) return; var inlinePattern = /["“'`]?(.+?)["”'`]?\s*(?:->|=>)\s*["“'`]?(.+?)["”'`]?/g; while ((replaceMatch = inlinePattern.exec(part))) { var inlineTarget = normalizeReplacementFragment(replaceMatch[1]); var inlineValue = normalizeReplacementFragment(replaceMatch[2]); if (inlineTarget && inlineValue) { var inlineKey = inlineTarget.toLowerCase() + "=>" + inlineValue.toLowerCase(); if (!seen.has(inlineKey)) { seen.add(inlineKey); results.push({ target: inlineTarget, replacement: inlineValue }); } } } }); }); return results; } function applySelectEditReplacements(replacements) { if (!replacements || !replacements.length) return { count: 0, inputs: [] }; var clickable = getVisibleElements('.select-edit-text-clickable', document); if (!clickable.length) return { count: 0, inputs: [] }; var used = new Set(); var filledInputs = []; var applied = 0; replacements.forEach(function (pair) { if (!pair || !pair.target || !pair.replacement) return; var normalizedTarget = pair.target.toLowerCase(); var bestIndex = -1; var bestScore = 0; clickable.forEach(function (node, index) { if (used.has(index)) return; var nodeText = beautifySimpleText(getTextWithSpacing(node)).toLowerCase(); if (!nodeText) return; var exact = nodeText === normalizedTarget; var score = exact ? 1 : calculateSimilarity(normalizedTarget, nodeText); if (score > bestScore && score >= 0.6) { bestScore = score; bestIndex = index; } }); if (bestIndex === -1) return; var targetNode = clickable[bestIndex]; used.add(bestIndex); try { targetNode.click(); } catch (err) {} var container = targetNode.closest('.select-edit-text-container, .select-edit-content-before') || targetNode.parentElement; var input = container && container.querySelector('textarea.fill-in, input.fill-in'); if (!input) return; var value = beautifySimpleText(pair.replacement); if (!value) return; try { input.focus(); } catch (err) {} input.value = ""; input.value = value; ['input', 'change', 'blur'].forEach(function (evt) { input.dispatchEvent(new Event(evt, { bubbles: true })); }); filledInputs.push(input); applied++; }); return { count: applied, inputs: filledInputs }; } function fillInTheBlank(UI, responseText, settings) { if (!settings.fillInBlank) return false; var fillInputs = document.querySelectorAll('input.fillIn, .old-fi-holder input[type="text"]'); if (fillInputs.length === 0) return false; var patterns = [ /\b([A-J])\b/i, /(\d+(?:\.\d+)?)\s*(?:°|degrees?)?/i, /-?\d+(?:\.\d+)?/g, /"([^"]+)"/, /'([^']+)'/, /^([a-zA-Z\s]+)$/ ]; var selectEditResult = { count: 0, inputs: [] }; if (ACTIVE_SITE && ACTIVE_SITE.key === "ixl") { var replacements = extractSelectEditReplacements(responseText); if (replacements.length) { selectEditResult = applySelectEditReplacements(replacements); } } var values = []; for (var i = 0; i < patterns.length; i++) { var matches = responseText.match(patterns[i]); if (matches) { if (patterns[i].global) { values = values.concat(matches); } else { values.push(matches[1] || matches[0]); } break; } } var skipInputs = new Set(selectEditResult.inputs || []); var filledCount = 0; if (values.length) { fillInputs.forEach(function (input, index) { if (skipInputs.has(input)) return; if (index < values.length) { var value = beautifySimpleText(values[index]); if (!value) return; input.value = ""; input.focus(); input.value = value; ["input", "change", "blur"].forEach(function (evt) { input.dispatchEvent(new Event(evt, { bubbles: true })); }); filledCount++; } }); } var totalFilled = filledCount + (selectEditResult.count || 0); if (totalFilled > 0) { showToast(UI, "Filled " + totalFilled + " blanks!", "success"); return true; } return false; } function clearHighlightEffect(element) { if (!element) return; element.classList.remove("ixl-highlighted-answer", "ixl-rainbow-highlight"); [ "outline", "outline-offset", "border-radius", "background-color", "box-shadow", "border", "transform", "filter", "position", "z-index", "pointer-events", "animation", "display", "width", "text-decoration", "--ixl-highlight-accent", "--ixl-highlight-fill", "--ixl-highlight-halo" ].forEach(function (prop) { try { element.style.removeProperty(prop); } catch (err) {} }); if (element._rainbowInterval) { clearInterval(element._rainbowInterval); element._rainbowInterval = null; } } function highlightAnswer(UI, responseText, settings) { var choice = getAnswerChoice(responseText); if (!choice) return false; var choices = Array.isArray(choice) ? choice : [choice]; var targetElements = choices .map(function (choiceItem) { if (!choiceItem || !choiceItem.el) return null; var baseElement = choiceItem.el; var resolved = resolveHighlightTarget(baseElement); return resolved instanceof Element ? resolved : baseElement; }) .filter(Boolean); if (!settings.multiAnswerHighlight) { document.querySelectorAll(".ixl-highlighted-answer, .ixl-rainbow-highlight").forEach(function (el) { clearHighlightEffect(el); }); } else { var targets = new Set(targetElements); document.querySelectorAll(".ixl-highlighted-answer, .ixl-rainbow-highlight").forEach(function (el) { if (targets.has(el)) { clearHighlightEffect(el); } }); } var currentTheme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var accentColor = settings.highlightColor || currentTheme.accent; var highlightLevel = parseFloat(settings.highlightOpacity); if (isNaN(highlightLevel)) highlightLevel = defaultSettings.highlightOpacity; highlightLevel = Math.max(0, Math.min(1, highlightLevel)); choices.forEach(function(choiceItem) { if (!choiceItem || !choiceItem.el) return; var baseElement = choiceItem.el; var targetElement = resolveHighlightTarget(baseElement); if (!targetElement || !(targetElement instanceof Element)) { targetElement = baseElement; } if (targetElement.tagName === 'A') { targetElement.style.setProperty('display', 'block', 'important'); targetElement.style.setProperty('width', '100%', 'important'); } targetElement.classList.add("ixl-highlighted-answer"); if (settings.rainbowHighlight) { targetElement.classList.add("ixl-rainbow-highlight"); startRainbowHighlight(targetElement); } else { var backgroundColor = convertHexToRgba(accentColor, highlightLevel); var haloColor = convertHexToRgba(accentColor, Math.min(0.6, highlightLevel + 0.25)); targetElement.style.setProperty('--ixl-highlight-accent', accentColor); targetElement.style.setProperty('--ixl-highlight-fill', backgroundColor); targetElement.style.setProperty('--ixl-highlight-halo', haloColor); } }); return true; } function startRainbowHighlight(element) { if (element._rainbowInterval) return; var hue = 0; element._rainbowInterval = setInterval(function() { hue = (hue + 2) % 360; var color = 'hsl(' + hue + ', 70%, 50%)'; var backgroundColor = 'hsla(' + hue + ', 70%, 50%, 0.2)'; var glowColor = 'hsla(' + hue + ', 70%, 50%, 0.3)'; element.style.setProperty('outline', color + ' solid 4px', 'important'); element.style.setProperty('background-color', backgroundColor, 'important'); element.style.setProperty('box-shadow', color + ' 0px 0px 15px, inset ' + color + ' 0px 0px 15px', 'important'); element.style.setProperty('border', '2px solid ' + color, 'important'); element.style.setProperty('filter', 'drop-shadow(0 0 8px ' + glowColor + ')', 'important'); }, 50); } function ensureInteractableChoice(element) { if (!element || !(element instanceof Element)) return; if (element.classList && element.classList.contains('disablePointerEvents')) { element.dataset.ixlHelperPointerClass = 'true'; element.style.pointerEvents = 'auto'; } var parent = element.closest('.disablePointerEvents'); if (parent && parent.classList.contains('disablePointerEvents')) { parent.dataset.ixlHelperPointerClass = 'true'; parent.style.pointerEvents = 'auto'; } if (element.style && element.style.pointerEvents === 'none') { element.dataset.ixlHelperPointerEvents = 'none'; element.style.pointerEvents = 'auto'; } } function dispatchClickSequence(target) { if (!target || !(target instanceof Element)) return false; var rect = null; try { rect = target.getBoundingClientRect(); } catch (err) {} var clientX = rect ? rect.left + Math.min(rect.width / 2, 10) : 0; var clientY = rect ? rect.top + Math.min(rect.height / 2, 10) : 0; var eventTypes = ['touchstart', 'touchend']; if (typeof PointerEvent === 'function') { eventTypes.push('pointerdown', 'pointerup'); } eventTypes = eventTypes.concat(['mousedown', 'mouseup', 'click']); var dispatched = false; for (var i = 0; i < eventTypes.length; i++) { var type = eventTypes[i]; try { var options = { bubbles: true, cancelable: true, view: window, clientX: clientX, clientY: clientY }; var evt = null; if (type.indexOf('pointer') === 0 && typeof PointerEvent === 'function') { evt = new PointerEvent(type, Object.assign({ pointerType: 'mouse' }, options)); } else if (type.indexOf('touch') === 0) { if (typeof TouchEvent === 'function') { try { evt = new TouchEvent(type, Object.assign({ touches: [], targetTouches: [], changedTouches: [] }, options)); } catch (touchErr) { evt = new MouseEvent(type, options); } } else { evt = new MouseEvent(type, options); } } else { evt = new MouseEvent(type, options); } target.dispatchEvent(evt); dispatched = true; } catch (err) {} } try { target.dispatchEvent(new Event('input', { bubbles: true })); dispatched = true; } catch (err) {} try { target.dispatchEvent(new Event('change', { bubbles: true })); dispatched = true; } catch (err2) {} return dispatched; } function gatherChoiceClickTargets(element) { var results = []; var seen = new Set(); function push(node) { if (!node || !(node instanceof Element) || seen.has(node)) return; seen.add(node); results.push(node); } if (element instanceof Element) { push(element); var label = getAssociatedLabelElement(element); if (label) push(label); if (element.closest) { var container = element.closest('label, button, .SelectableTile, .option, .option-answer, .answer-option, [role="option"], [role="radio"]'); if (container) push(container); } var interactive = element.querySelectorAll('input[type="radio"], input[type="checkbox"], button, [role="radio"], [role="option"], .TileSkinBare, .GeneticallyModified, .option-inner, .bpl-content-container'); interactive.forEach(function (node) { push(node); }); } return results; } function attemptChoiceActivation(target) { if (!target || !(target instanceof Element)) return false; ensureInteractableChoice(target); try { if (typeof target.focus === 'function') { target.focus({ preventScroll: true }); } } catch (err) {} var clicked = false; try { target.click(); clicked = true; } catch (err) {} if (!clicked) { clicked = dispatchClickSequence(target); } if (!clicked && target !== document.body) { try { target.dispatchEvent(new Event('change', { bubbles: true })); clicked = true; } catch (err2) {} } return clicked; } function applyManualTileSelection(tile, allTiles) { if (!tile) return false; var tiles = Array.isArray(allTiles) ? allTiles : null; if (!tiles || !tiles.length) { var cursor = tile.parentElement; while (cursor && cursor !== document.body) { if (cursor.querySelectorAll) { var candidateList = cursor.querySelectorAll('.SelectableTile[role="radio"], .SelectableTile'); if (candidateList && candidateList.length) { tiles = Array.from(candidateList); break; } } cursor = cursor.parentElement; } if (!tiles || !tiles.length) tiles = [tile]; } tiles.forEach(function (option) { if (!option || !(option instanceof Element)) return; var radio = option.querySelector('input[type="radio"]'); if (option === tile) { option.setAttribute('aria-checked', 'true'); option.classList.add('selected'); if (radio) radio.checked = true; } else { option.setAttribute('aria-checked', 'false'); option.classList.remove('selected'); if (radio) radio.checked = false; } }); var primaryRadio = tile.querySelector('input[type="radio"]'); if (primaryRadio) { try { primaryRadio.dispatchEvent(new Event('input', { bubbles: true })); primaryRadio.dispatchEvent(new Event('change', { bubbles: true })); } catch (err) {} } try { tile.dispatchEvent(new Event('change', { bubbles: true })); } catch (err) {} return true; } function selectAnswer(UI, responseText) { var choice = getAnswerChoice(responseText); if (!choice) return false; var choices = Array.isArray(choice) ? choice : [choice]; var success = false; choices.forEach(function(choiceItem) { if (!choiceItem || !choiceItem.el) return; var element = choiceItem.el; var localSuccess = false; var targets = gatherChoiceClickTargets(element); for (var i = 0; i < targets.length; i++) { if (attemptChoiceActivation(targets[i])) { localSuccess = true; break; } } if (!localSuccess) { var xpath = getXPath(element); if (xpath) { try { var result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null); if (result.singleNodeValue) { localSuccess = attemptChoiceActivation(result.singleNodeValue); } } catch (err) {} } } if (localSuccess) { success = true; setTimeout(function(target) { try { attemptChoiceActivation(target); } catch (err) {} }.bind(null, element), 120); } }); if (!success) { success = selectAnswerByXPath(responseText); } return success; } function selectAnswerByXPath(answerText) { if (!answerText) return false; var normalized = String(answerText).trim().toLowerCase(); if (!normalized) return false; var optionContainers = [ '/html/body/main/div/article/section/section/div/div[1]/section/div/section[2]/section/div/div[3]/div/div/div/div/div[2]/div', '/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/section/div/div[2]/div/div/div', '/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/section/div/div[2]/div/div/div[2]/div/div/div', '/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/div/div[2]/div/div/div[2]/div/div' ]; var container = null; var tiles = []; for (var i = 0; i < optionContainers.length; i++) { var candidate = evaluateXPath(optionContainers[i]); if (!candidate || !candidate.querySelectorAll) continue; var candidateTiles = Array.from(candidate.querySelectorAll('.SelectableTile[role="radio"], .SelectableTile')); candidateTiles = candidateTiles.filter(isElementVisible); if (candidateTiles.length) { container = candidate; tiles = candidateTiles; break; } } if (!tiles.length) { tiles = getVisibleElements('.SelectableTile[role="radio"], .SelectableTile'); } if (!tiles.length) return false; if (!container && tiles[0]) { container = tiles[0].closest('.TileMultipleChoices, [role="radiogroup"], .LaidOutTiles, .VerticalLayout') || tiles[0].parentElement; } var matched = tiles.find(function (tile) { var text = getElementTextContent(tile); return text && text.trim().toLowerCase() === normalized; }); if (!matched) return false; ensureInteractableChoice(matched); try { matched.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (err) {} var activated = false; var targets = gatherChoiceClickTargets(matched); for (var j = 0; j < targets.length; j++) { if (attemptChoiceActivation(targets[j])) { activated = true; break; } } if (!activated) { activated = dispatchClickSequence(matched); } if (activated) { applyManualTileSelection(matched, tiles); } else { activated = applyManualTileSelection(matched, tiles) || activated; } return activated; } function getXPath(element) { if (element.id) { return '//*[@id="' + element.id + '"]'; } if (element === document.body) { return '/html/body'; } var ix = 0; var siblings = element.parentNode.childNodes; for (var i = 0; i < siblings.length; i++) { var sibling = siblings[i]; if (sibling === element) { return getXPath(element.parentNode) + '/' + element.tagName.toLowerCase() + '[' + (ix + 1) + ']'; } if (sibling.nodeType === 1 && sibling.tagName === element.tagName) { ix++; } } } function submitAnswer(UI) { var submitButton = null; var submitPaths = [ '/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/div/button', '/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/section/div/button' ]; for (var i = 0; i < submitPaths.length; i++) { try { var result = document.evaluate(submitPaths[i], document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null); if (result && result.singleNodeValue) { submitButton = result.singleNodeValue; break; } } catch (err) {} } if (!submitButton) { submitButton = document.querySelector('button.crisp-button'); } if (!submitButton) { var allButtons = document.querySelectorAll('button'); submitButton = Array.from(allButtons).find(function (btn) { if (!btn || !btn.textContent) return false; var text = btn.textContent.trim().toLowerCase(); return text === 'submit' || text === 'next'; }); } if (!submitButton) { showToast(UI, 'Could not find submit button.', 'error'); return; } try { submitButton.dispatchEvent(new Event('click', { bubbles: true })); } catch (err) {} if (typeof submitButton.click === 'function') { try { submitButton.click(); } catch (err2) {} } } function initQuestionObserver(UI, settings, sendMessage, site) { var debounceTimer; var lastQuestionFingerprint = null; function processNewQuestion() { if (!settings.autoDetect || !site.features.autoDetect) return; if (UI.state && UI.state.safeWindowPaused) return; copyIXLContent(UI, settings, { manual: false }).then(function (questionText) { if (questionText) sendMessage(questionText, null, true); }); } var observer = new MutationObserver(function () { if (!settings.autoDetect || !site.features.autoDetect) return; if (UI.state && UI.state.safeWindowPaused) return; var tiles = document.querySelectorAll('.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"], .options-grid .option, .options-grid [role="option"]'); if (tiles.length > 0) { var currentFingerprint = Array.from(tiles).map(function (t) { return t.textContent; }).join("").slice(0, 200); if (currentFingerprint && currentFingerprint !== lastQuestionFingerprint) { lastQuestionFingerprint = currentFingerprint; clearTimeout(debounceTimer); debounceTimer = setTimeout(processNewQuestion, 250); } } var bbFingerprint = document.querySelectorAll("bb-assessment-question, .assessment-question, .assessment-question-container, [data-question-id]"); if (bbFingerprint.length > 0) { var bbFp = Array.from(bbFingerprint).map(function(el) { return el.textContent; }).join("").slice(0, 200); if (bbFp && bbFp !== lastQuestionFingerprint) { lastQuestionFingerprint = bbFp; clearTimeout(debounceTimer); debounceTimer = setTimeout(processNewQuestion, 250); } } }); var targetNode = document.querySelector("main") || document.body; observer.observe(targetNode, { childList: true, subtree: true }); setTimeout(processNewQuestion, 200); } function ensureGlobalHighlightStyles(settings) { var id = "ixl-helper-global-style"; var style = document.getElementById(id); if (!style) { style = document.createElement("style"); style.id = id; document.head.appendChild(style); } var currentTheme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var accentColor = settings.highlightColor || currentTheme.accent; var highlightLevel = parseFloat(settings.highlightOpacity); if (isNaN(highlightLevel)) highlightLevel = defaultSettings.highlightOpacity; highlightLevel = Math.max(0, Math.min(1, highlightLevel)); var backgroundColor = convertHexToRgba(accentColor, highlightLevel); var haloColor = convertHexToRgba(accentColor, Math.min(0.6, highlightLevel + 0.25)); var pulseColor = convertHexToRgba(accentColor, Math.min(0.75, highlightLevel + 0.35)); var underlineGlow = convertHexToRgba(accentColor, Math.min(0.45, highlightLevel + 0.3)); var accentVar = "var(--ixl-highlight-accent, " + accentColor + ")"; var fillVar = "var(--ixl-highlight-fill, " + backgroundColor + ")"; var haloVar = "var(--ixl-highlight-halo, " + haloColor + ")"; var stealthStrength = clampTransparency(settings.stealthHighlightStrength, defaultSettings.stealthHighlightStrength); var stealthRatio = Math.max(0, Math.min(1, stealthStrength / 100)); var tintGlow = convertHexToRgba(accentColor, Math.min(0.55, 0.2 + stealthRatio * 0.45)); var tintShadow = convertHexToRgba(accentColor, Math.min(0.28, 0.1 + stealthRatio * 0.24)); var dimOverlay = convertHexToRgba(accentColor, Math.min(0.3, 0.12 + stealthRatio * 0.25)); var dimShadow = convertHexToRgba(accentColor, Math.min(0.45, 0.18 + stealthRatio * 0.35)); var dimBlur = (6 + stealthRatio * 10).toFixed(1); var tintBlur = (2 + stealthRatio * 6).toFixed(1); var dimBrightness = (1 + stealthRatio * 0.12).toFixed(2); var dimSaturation = (1 + stealthRatio * 0.08).toFixed(2); var tintSaturation = (1 + stealthRatio * 0.15).toFixed(2); var tintBrightness = (1 + stealthRatio * 0.05).toFixed(2); var dimOpacity = Math.min(0.55, 0.2 + stealthRatio * 0.35).toFixed(3); updateHighlightAttributeFlags(settings); var baseAnimation = settings.pulseHighlight === false ? "none" : "ixl-pulse 1.5s ease-in-out infinite"; style.textContent = ` @keyframes ixl-pulse { 0% { box-shadow: 0 0 0 0 ${pulseColor}; } 70% { box-shadow: 0 0 0 12px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } } .ixl-highlighted-answer { position: relative !important; z-index: 1000 !important; pointer-events: auto !important; border-radius: 12px !important; box-sizing: border-box !important; transition: box-shadow 0.3s ease, transform 0.3s ease; animation: ${baseAnimation} !important; } body[data-ixl-pulse="off"] .ixl-highlighted-answer { animation: none !important; } .ixl-highlighted-answer::after { content: ''; display: none; } body[data-ixl-highlight-mode="fill"] .ixl-highlighted-answer { outline: 3px solid ${accentVar} !important; outline-offset: 4px !important; background: ${fillVar} !important; box-shadow: 0 0 0 4px ${haloVar} !important, 0 0 18px ${haloVar} !important; transform: none !important; filter: drop-shadow(0 0 8px ${haloVar}); } body[data-ixl-highlight-mode="outline"] .ixl-highlighted-answer { background: transparent !important; outline: none !important; outline: 2px solid ${accentVar} !important; outline-offset: 2px !important; box-shadow: 0 0 0 3px ${haloVar} !important; transform: none !important; filter: drop-shadow(0 0 6px ${haloVar}); } body[data-ixl-highlight-mode="underline"] .ixl-highlighted-answer { background: transparent !important; outline: none !important; border: none !important; box-shadow: none !important; transform: none !important; filter: drop-shadow(0 3px 8px rgba(0,0,0,0.2)); } body[data-ixl-highlight-mode="underline"] .ixl-highlighted-answer::after { display: block; position: absolute; left: 0; right: 0; bottom: -4px; height: 3px; border-radius: 999px; background: ${accentVar}; box-shadow: 0 0 10px ${underlineGlow}; opacity: 0.95; } .ixl-highlighted-answer a { text-decoration: none !important; color: inherit !important; } body[data-ixl-stealth-highlight="tint"] .ixl-highlighted-answer { background: transparent !important; outline: none !important; border: none !important; box-shadow: inset 0 -1px 0 ${tintShadow} !important; transform: none !important; color: ${accentVar}; text-shadow: 0 0 ${tintBlur}px ${tintGlow}; filter: brightness(${tintBrightness}) saturate(${tintSaturation}); } body[data-ixl-stealth-highlight="tint"] .ixl-highlighted-answer::after { display: none !important; } body[data-ixl-stealth-highlight="tint"] .ixl-highlighted-answer * { color: inherit !important; text-shadow: none !important; } body[data-ixl-stealth-highlight="dim"] .ixl-highlighted-answer { background: transparent !important; outline: none !important; border: none !important; box-shadow: none !important; overflow: visible !important; transform: none !important; color: inherit !important; filter: brightness(${dimBrightness}) saturate(${dimSaturation}); } body[data-ixl-stealth-highlight="dim"] .ixl-highlighted-answer::after { display: none !important; } body[data-ixl-stealth-highlight="dim"] .ixl-highlighted-answer * { color: inherit !important; } body[data-ixl-stealth-highlight="dim"] .ixl-highlighted-answer::before { content: ''; position: absolute; inset: 2px; border-radius: 10px; background: ${dimOverlay}; opacity: ${dimOpacity}; box-shadow: 0 6px 18px ${dimShadow}; filter: blur(${dimBlur}px); pointer-events: none; z-index: -1; } body[data-ixl-stealth-highlight="off"] .ixl-highlighted-answer::before { display: none !important; } `; } function appendMessage(UI, role, text, imageUrl) { if (role === "user" && UI && UI.settings && UI.settings.hideOutgoingMessages) { return null; } var messageEl = document.createElement("div"); messageEl.className = "chat-message " + role; if (imageUrl) { var img = document.createElement("img"); img.src = imageUrl; img.alt = "Attached image"; img.loading = "lazy"; messageEl.appendChild(img); } if (text) { var p = document.createElement("p"); p.textContent = text; messageEl.appendChild(p); } UI.messages.appendChild(messageEl); scrollMessagesToBottom(UI); return messageEl; } function scrollMessagesToBottom(UI){ try { var el = UI.messages; el.scrollTop = el.scrollHeight; requestAnimationFrame(function(){ el.scrollTop = el.scrollHeight; if (el.lastElementChild && el.lastElementChild.scrollIntoView) { el.lastElementChild.scrollIntoView({ block: 'end' }); } }); setTimeout(function(){ el.scrollTop = el.scrollHeight; }, 50); } catch(e) {} } function applyTheme(UI, settings) { refreshComputedSettings(settings); var theme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var hostStyle = UI.host.style; var fontFamily = resolveFontFamily(settings.fontStyle); var fontWeights = resolveFontWeights(settings.fontWeight); if (fontFamily) { try { hostStyle.setProperty("--font-sans", fontFamily); } catch (e) {} } if (fontWeights) { try { hostStyle.setProperty("--font-weight-body", fontWeights.body); hostStyle.setProperty("--font-weight-heading", fontWeights.heading); hostStyle.setProperty("--font-weight-strong", fontWeights.strong); } catch (err) {} } if (settings.animatedBackground) UI.host.setAttribute("data-animated", "on"); else UI.host.removeAttribute("data-animated"); if (settings.lockPosition) UI.host.setAttribute("data-lock-position", "on"); else UI.host.removeAttribute("data-lock-position"); if (settings.hideWhileIdle) { UI.host.setAttribute("data-hide-while-idle", "on"); if (!UI.host.getAttribute("data-idle-state")) { UI.host.setAttribute("data-idle-state", "active"); } } else { UI.host.removeAttribute("data-hide-while-idle"); UI.host.removeAttribute("data-idle-state"); } if (theme) { for (var key in theme) { if (Object.prototype.hasOwnProperty.call(theme, key) && theme[key] !== undefined) { try { hostStyle.setProperty("--" + key, theme[key]); } catch (e) {} } } } var gradientFrom = theme.gradientFrom || theme.bg || "#0a0a0a"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg || gradientFrom; var surfaces = computePanelSurfaces(theme, settings); settings.backgroundTransparency = surfaces.values.backgroundTransparency; settings.panelTransparency = surfaces.values.panelTransparency; hostStyle.setProperty("--gradient-from", gradientFrom); hostStyle.setProperty("--gradient-to", gradientTo); hostStyle.setProperty("--panel-bg", surfaces.panelBg); hostStyle.setProperty("--panel-header-bg", surfaces.headerBg); hostStyle.setProperty("--panel-footer-bg", surfaces.footerBg); hostStyle.setProperty("--panel-border", surfaces.border); hostStyle.setProperty("--solid-background", surfaces.solidBackground); hostStyle.setProperty("--gradient-background", surfaces.gradientBackground); var panelOpacity = surfaces.values.panelOpacity; var accentColor = theme.accent || "#00d4ff"; var accentHover = theme.accentHover || accentColor; var accentContrast = getContrastColor(accentColor); var accentSoft = convertHexToRgba(accentColor, 0.25); var accentSoftBorder = convertHexToRgba(accentColor, 0.55); var sideTransparency = clampTransparency(settings.sideButtonTransparency, defaultSettings.sideButtonTransparency); var sideOpacity = 1 - sideTransparency / 100; var safeSideOpacity = Math.max(0.2, Math.min(1, sideOpacity)); var floatingBg = convertHexToRgba(accentColor, safeSideOpacity); var floatingHoverBg = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.1)); var floatingBorder = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.3)); var quickBase = theme.surface || theme.bg || gradientFrom; var quickBg = convertHexToRgba(quickBase, safeSideOpacity); var quickHoverBg = convertHexToRgba(theme.elevated || quickBase, Math.min(1, safeSideOpacity + 0.15)); var quickBorder = convertHexToRgba(theme.border || quickBase, Math.min(1, safeSideOpacity + 0.35)); var sideShadow = "0 14px 24px rgba(0, 0, 0, " + (0.35 * safeSideOpacity).toFixed(3) + ")"; var sideShadowHover = "0 18px 28px rgba(0, 0, 0, " + (0.45 * safeSideOpacity).toFixed(3) + ")"; var sideBackdrop = "blur(" + (4 + safeSideOpacity * 6).toFixed(1) + "px) saturate(120%)"; hostStyle.setProperty("--accent-soft", accentSoft); hostStyle.setProperty("--accent-soft-border", accentSoftBorder); hostStyle.setProperty("--accent-contrast", accentContrast); hostStyle.setProperty("--floating-btn-bg", floatingBg); hostStyle.setProperty("--floating-btn-hover-bg", floatingHoverBg); hostStyle.setProperty("--floating-btn-border", floatingBorder); hostStyle.setProperty("--floating-btn-color", accentContrast); hostStyle.setProperty("--quick-copy-btn-bg", quickBg); hostStyle.setProperty("--quick-copy-btn-hover-bg", quickHoverBg); hostStyle.setProperty("--quick-copy-btn-border", quickBorder); hostStyle.setProperty("--quick-copy-btn-color", theme.text || "#ffffff"); hostStyle.setProperty("--side-button-shadow", sideShadow); hostStyle.setProperty("--side-button-shadow-hover", sideShadowHover); hostStyle.setProperty("--side-button-backdrop", sideBackdrop); var baseSurface = theme.surface || theme.bg || gradientFrom; var baseElevated = theme.elevated || baseSurface; var tintedSurface = convertHexToRgba(baseSurface, Math.min(1, panelOpacity + 0.02)); var tintedElevated = convertHexToRgba(baseElevated, Math.min(1, panelOpacity + 0.08)); var tintedInput = convertHexToRgba(baseElevated, Math.min(1, panelOpacity + 0.12)); var tintedChip = convertHexToRgba(baseSurface, Math.min(1, panelOpacity + 0.14)); if (settings.gradientEnabled) { UI.host.setAttribute("data-gradient", "on"); } else { UI.host.removeAttribute("data-gradient"); } if (typeof UI.updateTransparencyDisplays === "function") { UI.updateTransparencyDisplays(); } var scope = settings.themeScope === "background" ? "background" : "full"; UI.host.setAttribute("data-theme-scope", scope); if (scope === "full") { hostStyle.setProperty("--surface", tintedSurface); hostStyle.setProperty("--elevated", tintedElevated); hostStyle.setProperty("--input-bg", tintedInput); hostStyle.setProperty("--chip-bg", tintedChip); } else { hostStyle.setProperty("--surface", baseSurface); hostStyle.setProperty("--elevated", baseElevated); hostStyle.setProperty("--input-bg", baseElevated); hostStyle.setProperty("--chip-bg", "rgba(255, 255, 255, 0.08)"); } var gradientFrom = theme.gradientFrom || theme.bg || "#0a0a0a"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg || gradientFrom; var gradientBackground = "linear-gradient(135deg, " + gradientFrom + ", " + gradientTo + ")"; hostStyle.setProperty("--gradient-from", gradientFrom); hostStyle.setProperty("--gradient-to", gradientTo); hostStyle.setProperty("--solid-background", theme.bg || gradientFrom); if (settings.gradientEnabled) { hostStyle.setProperty("--gradient-background", gradientBackground); UI.host.setAttribute("data-gradient", "on"); } else { hostStyle.setProperty("--gradient-background", theme.bg || gradientFrom); UI.host.removeAttribute("data-gradient"); } var scope = settings.themeScope === "background" ? "background" : "full"; UI.host.setAttribute("data-theme-scope", scope); try { hostStyle.setProperty("--stealth-dim-percent", String(clampFadeIntensity(settings.stealthFadeIntensity, defaultSettings.stealthFadeIntensity))); } catch (dimErr) {} if (typeof UI.applyStealthAppearance === "function") { UI.applyStealthAppearance(); } } var toastTimeout; function showToast(UI, message, type) { type = type || "info"; clearTimeout(toastTimeout); var toast = UI.shadow.querySelector(".toast"); if (!toast) { toast = document.createElement("div"); toast.className = "toast"; UI.shadow.appendChild(toast); } toast.textContent = message; toast.className = "toast show " + type; toastTimeout = setTimeout(function () { toast.classList.remove("show"); }, 5000); } function getPanelHTML(site) { return ` <div class="panel-header"> <div class="panel-title">${site.title}</div> <div class="panel-stats"> <span class="panel-stat" id="questions-answered-counter">0 done</span> <span class="panel-stat" id="questions-remaining-counter">8 left</span> </div> <div class="panel-actions"> <button class="header-btn copy-btn" title="Copy Question Text">${ICONS.COPY}</button> <button class="header-btn settings-btn" title="Settings">${ICONS.SETTINGS}</button> <button class="header-btn close-btn" title="Close">${ICONS.CLOSE}</button> </div> </div> <div class="panel-body"> <div class="chat-view"> <div class="chat-messages"></div> </div> <div class="settings-view"> <details class="settings-section" data-category="themes" open> <summary> <div class="summary-text"> <span class="summary-title">Themes & Colors</span> <span class="summary-caption">Organize every visual option</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content theme-section"> <div class="field-group"> <div class="field-label"> <span>Theme Library</span> <small>Select, edit, or remove saved themes.</small> </div> <div class="theme-list" id="theme-list"></div> </div> <div class="control-row"> <div class="control-label"> <span>Gradient Background</span> <small>Blend theme colors across the interface.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="gradient-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="control-row"> <div class="control-label"> <span>Animated Background</span> <small>Enable a slow gradient motion behind the panel.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="animated-background-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="control-row"> <div class="control-label"> <span>Theme Coverage</span> <small>Apply colors to the full UI or just the background.</small> </div> <div class="segmented-control" id="theme-scope-control"> <input type="radio" id="theme-scope-full" name="theme-scope" value="full" /> <label for="theme-scope-full">Entire UI</label> <input type="radio" id="theme-scope-background" name="theme-scope" value="background" /> <label for="theme-scope-background">Background only</label> </div> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Font Style</span> <select id="font-style-select"> <option value="system">System</option> <option value="clean">Clean (Inter)</option> <option value="rounded">Rounded (Poppins)</option> </select> </label> <label class="field-group"> <span class="field-label">Font Weight</span> <select id="font-weight-select"> <option value="regular">Balanced</option> <option value="light">Light</option> <option value="bold">Bold</option> <option value="mixed">Mixed</option> </select> </label> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Background Transparency</span> <div class="range-with-value"> <input type="range" id="background-transparency" min="0" max="100" step="5" /> <span class="range-value" id="background-transparency-value"></span> </div> </label> <label class="field-group"> <span class="field-label">Panel Transparency</span> <div class="range-with-value"> <input type="range" id="panel-transparency" min="0" max="100" step="5" /> <span class="range-value" id="panel-transparency-value"></span> </div> </label> </div> </div> </details> <details class="settings-section" data-category="profiles" open> <summary> <div class="summary-text"> <span class="summary-title">Prepend Profiles</span> <span class="summary-caption">Save and reuse your favorite prepends.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content profile-section"> <label class="field-group"> <span class="field-label">Saved Profiles</span> <select id="prepend-preset-select"></select> </label> <label class="field-group full"> <span class="field-label">Prepend Message</span> <textarea id="prepend-message-input" rows="4"></textarea> </label> <div class="field-grid"> <label class="field-group"> <span class="field-label">Profile Name</span> <input type="text" id="prepend-name-input" placeholder="New profile name" /> </label> <div class="field-actions"> <button type="button" class="btn primary" id="prepend-save-btn">Save as new</button> <button type="button" class="btn secondary" id="prepend-update-btn">Update selected</button> <button type="button" class="btn secondary" id="prepend-duplicate-btn">Duplicate selected</button> <button type="button" class="btn danger" id="prepend-delete-btn">Delete selected</button> </div> </div> </div> </details> <details class="settings-section" data-category="model" open> <summary> <div class="summary-text"> <span class="summary-title">AI Model</span> <span class="summary-caption">Select the Gemini or Gemma model to use.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content model-section"> <label class="field-group"> <span class="field-label">Model</span> <select id="model-select"> <optgroup label="Gemini Models"> <option value="gemini-3-flash-preview">Gemini 3 Flash (Preview)</option> <option value="gemini-2.5-flash">Gemini 2.5 Flash</option> <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option> <option value="gemini-2.5-pro">Gemini 2.5 Pro</option> </optgroup> <optgroup label="Gemma 3 Models"> <option value="gemma-3-27b-it">Gemma 3 27B</option> <option value="gemma-3-12b-it">Gemma 3 12B</option> <option value="gemma-3-4b-it">Gemma 3 4B</option> <option value="gemma-3-2b-it">Gemma 3 2B</option> <option value="gemma-3-1b-it">Gemma 3 1B</option> <option value="gemma-3-270m-it">Gemma 3 270M</option> </optgroup> </select> </label> </div> </details> <details class="settings-section" data-category="highlight" open> <summary> <div class="summary-text"> <span class="summary-title">Highlighting</span> <span class="summary-caption">Control how answers are emphasized.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content highlight-section"> <div class="toggle-row"> <div class="control-label"> <span>Highlight Answer</span> <small>Automatically spotlight detected answers.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-highlight-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Highlight Color</span> <input type="color" id="highlight-color" class="settings-input-color" /> </label> <label class="field-group"> <span class="field-label">Highlight Opacity</span> <input type="range" id="highlight-opacity" class="settings-input-range" min="0" max="1" step="0.05" /> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Rainbow Highlight</span> <small>Cycle through accent colors while highlighting.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="rainbow-highlight-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Pulse Effect</span> <small>Animate highlights with a gentle glow.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="pulse-effect-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Underline Mode</span> <small>Underline answers instead of filling the background.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="underline-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Answer Outline</span> <small>Draw a thin outline around detected answers.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="outline-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Multi-Answer Highlight</span> <small>Keep multiple answers highlighted at once.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="multi-highlight-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="field-pair stealth-highlight-controls"> <label class="field-group"> <span class="field-label">Stealth Highlight Style</span> <select id="stealth-highlight-mode"> <option value="off">Standard (full highlight)</option> <option value="tint">Tint text only</option> <option value="dim">Dim surroundings</option> </select> </label> <label class="field-group"> <span class="field-label">Stealth Intensity</span> <div class="range-with-value"> <input type="range" id="stealth-highlight-strength" min="0" max="100" step="5" /> <span class="range-value" id="stealth-highlight-strength-value"></span> </div> </label> </div> </div> </details> <details class="settings-section" data-category="copy" open> <summary> <div class="summary-text"> <span class="summary-title">Copy Behavior</span> <span class="summary-caption">Control keyboard focus after copying.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content copy-section"> <div class="toggle-row"> <div class="control-label"> <span>Copy Mode</span> <small>Standard focuses the chat input; advanced keeps it hidden.</small> </div> <div class="segmented-control" id="copy-mode-control"> <input type="radio" id="copy-mode-standard" name="copy-mode" value="standard" /> <label for="copy-mode-standard">Standard</label> <input type="radio" id="copy-mode-advanced" name="copy-mode" value="advanced" /> <label for="copy-mode-advanced">Advanced</label> </div> </div> </div> </details> <details class="settings-section" data-category="automation" open> <summary> <div class="summary-text"> <span class="summary-title">Automation & Timing</span> <span class="summary-caption">Control how hands-free the helper becomes.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content automation-section"> <div class="toggle-grid"> <div class="toggle-row"> <div class="control-label"> <span>Auto-Select Answer</span> <small>Click the detected answer choice automatically.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-select-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Submit</span> <small>Submit answers after the delay timer.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-submit-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Detect Questions</span> <small>Watch the page and resend on new questions.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-detect-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Fill-in-the-Blank</span> <small>Try to type answers into blank inputs.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="fill-in-blank-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Copy</span> <small>Copy formatted prompts to your clipboard.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-copy-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Selection Delay (seconds)</span> <input type="number" id="selection-delay" class="settings-input-short" min="0" max="10" step="1" /> </label> <label class="field-group"> <span class="field-label">Submit Delay (seconds)</span> <input type="number" id="submit-delay" class="settings-input-short" min="0" max="15" step="1" /> </label> </div> </div> </details> <details class="settings-section" data-category="usage" open> <summary> <div class="summary-text"> <span class="summary-title">Usage & Counters</span> <span class="summary-caption">Track progress and manage unlock codes.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content usage-section"> <div class="toggle-row"> <div class="control-label"> <span>Question Counter</span> <small>Display how many questions you've completed.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="show-question-counter-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Remaining Counter</span> <small>Show how many questions are left in the current window.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="show-remaining-counter-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="field-group full locked-only"> <span class="field-label">Unlock Code</span> <div class="code-row"> <input type="text" id="access-code-input" placeholder="Enter unlock code" /> <button type="button" class="btn secondary" id="apply-code-btn">Apply Code</button> </div> <p class="usage-status" id="access-code-status"></p> </div> </div> </details> <details class="settings-section" data-category="chat" open> <summary> <div class="summary-text"> <span class="summary-title">Chat Behavior</span> <span class="summary-caption">Control how prompts and replies appear.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content chat-section"> <div class="toggle-row"> <div class="control-label"> <span>Hide Sent Messages</span> <small>Send prompts silently and only show AI replies.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="hide-outgoing-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> </div> </details> <details class="settings-section" data-category="interface" open> <summary> <div class="summary-text"> <span class="summary-title">Interface Behavior</span> <span class="summary-caption">Control visibility, idle hiding, and stealth options.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content interface-section"> <div class="toggle-row"> <div class="control-label"> <span>Auto-Hide Side Buttons</span> <small>Hide the launcher and quick copy button while the panel is open.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-hide-side-buttons" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Hide While Idle</span> <small>Fade the panel and launchers after 20 seconds of inactivity.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="hide-while-idle-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Lock Position</span> <small>Prevent dragging the panel or launcher buttons.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="lock-position-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Stealth Mode</span> <small>Hide the interface until you tap the helper badge.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="stealth-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Mirror Mode</span> <small>Blend the helper into the page as a native widget.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="mirror-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row sub-toggle"> <div class="control-label"> <span>Match Site Theme</span> <small>Adopt fonts and colors from the current site.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="mirror-match-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Notebook Mode</span> <small>Disguise the panel as notes. Double-tap the title to reveal.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="notebook-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Dim Mode</span> <small>Fade, blur, and soften the interface for stealth.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="dim-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <label class="field-group stealth-fade-group"> <span class="field-label">Stealth Fade Intensity</span> <div class="range-with-value"> <input type="range" id="stealth-fade-intensity" min="0" max="80" step="5" /> <span class="range-value" id="stealth-fade-intensity-value"></span> </div> </label> <div class="toggle-row"> <div class="control-label"> <span>Widget Mode</span> <small>Shrink to a 1-line utility strip with live stats.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="widget-mode-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Frozen Overlay</span> <small>Show a static snapshot while the helper keeps running.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="frozen-overlay-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Safe Window Mode</span> <small>Pop the panel into a 200×400 floating window.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="safe-window-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <label class="field-group"> <span class="field-label">Side Button Transparency</span> <div class="range-with-value"> <input type="range" id="side-button-transparency" min="0" max="80" step="5" /> <span class="range-value" id="side-button-transparency-value"></span> </div> </label> </div> </details> <details class="settings-section" data-category="sync"><summary><div class="summary-text"><span class="summary-title">Sync Settings</span><span class="summary-caption">Export or import settings across sites</span></div><span class="summary-icon"></span></summary><div class="section-content"><div class="field-row"><button id="export-settings-btn" type="button" class="btn primary" style="flex:1">Export Settings</button><button id="import-settings-btn" type="button" class="btn secondary" style="flex:1">Import Settings</button></div><textarea id="settings-sync-area" rows="3" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:12px;resize:vertical;display:none" placeholder="Paste settings here..."></textarea></div></details><p class="autosave-hint">Changes save automatically</p> <footer class="copyright">© <span id="copyright-year"></span> aidenwrld</footer> </div> </div> <div class="panel-footer"> <div class="image-preview"></div> <div class="chat-input-wrapper"> <button class="attach-btn" title="Attach Image">${ICONS.ATTACH}</button> <button class="screenshot-btn" title="Screenshot"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect><path d="M8 5l2-2h4l2 2"></path></svg></button> <input type="text" class="chat-input" placeholder="Ask a question..." /> <button class="send-btn" title="Send">${ICONS.SEND}</button> </div> </div> `; } function getCSS(settings, theme) { var gradientFrom = theme.gradientFrom || theme.bg; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg; var surfaces = computePanelSurfaces(theme, settings); var accentColor = theme.accent || "#00d4ff"; var accentHover = theme.accentHover || accentColor; var accentSoft = convertHexToRgba(accentColor, 0.25); var accentSoftBorder = convertHexToRgba(accentColor, 0.55); var accentContrast = getContrastColor(accentColor); var sideTransparency = clampTransparency(settings.sideButtonTransparency, defaultSettings.sideButtonTransparency); var sideOpacity = 1 - sideTransparency / 100; var safeSideOpacity = Math.max(0.2, Math.min(1, sideOpacity)); var floatingBg = convertHexToRgba(accentColor, safeSideOpacity); var floatingHoverBg = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.1)); var floatingBorder = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.3)); var quickBase = theme.surface || theme.bg || gradientFrom; var quickBg = convertHexToRgba(quickBase, safeSideOpacity); var quickHoverBg = convertHexToRgba(theme.elevated || quickBase, Math.min(1, safeSideOpacity + 0.15)); var quickBorder = convertHexToRgba(theme.border || quickBase, Math.min(1, safeSideOpacity + 0.35)); var sideShadow = "0 14px 24px rgba(0, 0, 0, " + (0.35 * safeSideOpacity).toFixed(3) + ")"; var sideShadowHover = "0 18px 28px rgba(0, 0, 0, " + (0.45 * safeSideOpacity).toFixed(3) + ")"; var sideBackdrop = "blur(" + (4 + safeSideOpacity * 6).toFixed(1) + "px) saturate(120%)"; var fontImport = resolveFontImport(settings.fontStyle); var fontFamily = resolveFontFamily(settings.fontStyle); var fontWeights = resolveFontWeights(settings.fontWeight); return ` ${fontImport ? fontImport + "\n" : ""}:host { --bg: ${theme.bg}; --surface: ${theme.surface}; --elevated: ${theme.elevated}; --text: ${theme.text}; --subtext: ${theme.subtext}; --border: ${theme.border}; --accent: ${theme.accent}; --accent-hover: ${theme.accentHover}; --success: ${theme.success}; --error: ${theme.error}; --gradient-from: ${gradientFrom}; --gradient-to: ${gradientTo}; --solid-background: ${surfaces.solidBackground}; --gradient-background: ${surfaces.gradientBackground}; --panel-bg: ${surfaces.panelBg}; --panel-header-bg: ${surfaces.headerBg}; --panel-footer-bg: ${surfaces.footerBg}; --panel-border: ${surfaces.border}; --accent-soft: ${accentSoft}; --accent-soft-border: ${accentSoftBorder}; --accent-contrast: ${accentContrast}; --floating-btn-bg: ${floatingBg}; --floating-btn-hover-bg: ${floatingHoverBg}; --floating-btn-border: ${floatingBorder}; --floating-btn-color: ${accentContrast}; --quick-copy-btn-bg: ${quickBg}; --quick-copy-btn-hover-bg: ${quickHoverBg}; --quick-copy-btn-border: ${quickBorder}; --quick-copy-btn-color: ${theme.text}; --side-button-shadow: ${sideShadow}; --side-button-shadow-hover: ${sideShadowHover}; --side-button-backdrop: ${sideBackdrop}; --chip-bg: rgba(255, 255, 255, 0.08); --input-bg: var(--elevated); --scrollbar-thumb: rgba(255, 255, 255, 0.2); --font-sans: ${fontFamily}; --font-weight-body: ${fontWeights.body}; --font-weight-heading: ${fontWeights.heading}; --font-weight-strong: ${fontWeights.strong}; --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); } :host, :host * { box-sizing: border-box; font-family: var(--font-sans); font-weight: var(--font-weight-body); } *:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; } @keyframes ixl-gradient-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } } ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 6px; } .floating-btn, .quick-copy-btn { position: fixed; z-index: 2147483647; pointer-events: auto; display: grid; place-items: center; border: none; box-shadow: var(--side-button-shadow); backdrop-filter: var(--side-button-backdrop); -webkit-backdrop-filter: var(--side-button-backdrop); cursor: grab; border-radius: 50%; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.25s ease; } .floating-btn { width: 52px; height: 52px; background: var(--floating-btn-bg); color: var(--floating-btn-color); border: 1px solid var(--floating-btn-border); } .quick-copy-btn { width: 44px; height: 44px; background: var(--quick-copy-btn-bg); color: var(--quick-copy-btn-color); border: 1px solid var(--quick-copy-btn-border); z-index: 2147483646; cursor: pointer; } .stealth-handle { position: fixed; z-index: 2147483647; width: 26px; height: 26px; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(23, 32, 48, 0.22); box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18); backdrop-filter: blur(8px) saturate(130%); -webkit-backdrop-filter: blur(8px) saturate(130%); display: none; pointer-events: none; opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; touch-action: manipulation; cursor: pointer; } .stealth-handle::after { content: ""; width: 6px; height: 6px; border-radius: 50%; background: rgba(255, 255, 255, 0.65); box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.15); } :host([data-stealth="hidden"]) .stealth-handle { display: grid; pointer-events: auto; opacity: 0.55; } :host([data-stealth="hidden"]) .stealth-handle:hover { opacity: 0.85; transform: scale(1.05); } :host([data-stealth="hidden"]) .stealth-handle:active { transform: scale(0.92); opacity: 1; } .floating-btn svg { width: 24px; height: 24px; } .quick-copy-btn svg { width: 20px; height: 20px; } .floating-btn:hover { transform: scale(1.1); background: var(--floating-btn-hover-bg); box-shadow: var(--side-button-shadow-hover); } .quick-copy-btn:hover { transform: scale(1.1); background: var(--quick-copy-btn-hover-bg); box-shadow: var(--side-button-shadow-hover); } .widget-strip { position: fixed; bottom: 18px; left: 16px; right: 16px; z-index: 2147483646; display: none; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 999px; background: var(--quick-copy-btn-bg); color: var(--quick-copy-btn-color); border: 1px solid var(--quick-copy-btn-border); box-shadow: var(--side-button-shadow); backdrop-filter: var(--side-button-backdrop); -webkit-backdrop-filter: var(--side-button-backdrop); font-size: 0.92rem; line-height: 1.3; transition: opacity 0.3s ease, transform 0.3s ease; } .widget-strip .widget-icon { font-size: 1.1rem; } .widget-strip .widget-label { flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; } :host([data-widget-mode="collapsed"]) .widget-strip { display: flex; opacity: 0.95; pointer-events: auto; } :host([data-widget-mode="expanded"]) .widget-strip { display: flex; opacity: 0; pointer-events: none; transform: translateY(40px); } :host([data-animated="on"]) .panel { background: var(--gradient-background); background-size: 200% 200%; animation: ixl-gradient-pan 18s ease infinite; } :host([data-lock-position="on"]) .floating-btn, :host([data-lock-position="on"]) .panel-header { cursor: default; } :host([data-hide-while-idle="on"][data-idle-state="hidden"]) .panel, :host([data-stealth="hidden"]) .panel { opacity: 0 !important; pointer-events: none !important; visibility: hidden !important; } :host([data-hide-while-idle="on"][data-idle-state="hidden"]) .floating-btn, :host([data-hide-while-idle="on"][data-idle-state="hidden"]) .quick-copy-btn, :host([data-stealth="hidden"]) .floating-btn, :host([data-stealth="hidden"]) .quick-copy-btn { opacity: 0; pointer-events: none; transform: scale(0.85); } :host([data-stealth="revealed"]) .floating-btn, :host([data-stealth="revealed"]) .quick-copy-btn { opacity: 1; } .frozen-overlay { position: fixed; display: none; pointer-events: none; z-index: 2147483646; overflow: hidden; } .frozen-overlay .frozen-panel-clone { pointer-events: none; width: 100%; height: 100%; border-radius: 16px; box-shadow: var(--shadow-lg); overflow: hidden; } :host([data-frozen-overlay="on"]) .frozen-overlay { display: block; } :host([data-frozen-overlay="on"]) .panel { opacity: 0; pointer-events: none; } :host([data-frozen-overlay="on"]) .floating-btn, :host([data-frozen-overlay="on"]) .quick-copy-btn, :host([data-frozen-overlay="on"]) .widget-strip { opacity: 0; pointer-events: none; } :host([data-safe-window]) .floating-btn, :host([data-safe-window]) .quick-copy-btn, :host([data-safe-window]) .stealth-handle { display: none !important; } :host([data-safe-window]) .widget-strip { right: 28px; left: auto; width: 220px; } :host([data-safe-window]) .panel { right: 20px; left: auto !important; transform-origin: top right; transition: opacity 0.25s ease, transform 0.25s ease; } :host([data-safe-window="open"]) .panel, :host([data-safe-window="hidden"]) .panel { width: 200px; height: 400px; top: 20px !important; } :host([data-safe-window="hidden"]) .panel { opacity: 0; visibility: hidden; pointer-events: none; } .panel { position: fixed; z-index: 2147483645; width: 380px; height: 540px; background: var(--panel-bg); color: var(--text); border-radius: 16px; border: 1px solid var(--panel-border); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: top left; overflow: hidden; } .panel.settings-mode { overflow: visible; } .panel.open { opacity: 1; visibility: visible; pointer-events: auto; } :host([data-dim-mode="on"]) .panel, :host([data-dim-mode="on"]) .floating-btn, :host([data-dim-mode="on"]) .quick-copy-btn, :host([data-dim-mode="on"]) .widget-strip { opacity: calc(1 - (var(--stealth-dim-percent, 40) / 120)); filter: saturate(0.85) brightness(0.98); backdrop-filter: blur(calc(var(--stealth-dim-percent, 40) * 0.08px)) saturate(85%); -webkit-backdrop-filter: blur(calc(var(--stealth-dim-percent, 40) * 0.08px)) saturate(85%); } :host([data-dim-mode="on"]) .panel-header, :host([data-dim-mode="on"]) .panel-footer { backdrop-filter: blur(calc(var(--stealth-dim-percent, 40) * 0.06px)); -webkit-backdrop-filter: blur(calc(var(--stealth-dim-percent, 40) * 0.06px)); } .panel-header { display: flex; align-items: center; padding: 12px 8px 12px 16px; background: var(--panel-header-bg); border-bottom: 1px solid var(--panel-border); cursor: grab; gap: 8px; } .panel-title { font-weight: var(--font-weight-heading); font-size: 16px; flex: 1; } .panel-stats { display: flex; align-items: center; gap: 6px; margin-right: 8px; } .panel-stat { display: none; font-size: 12px; font-weight: var(--font-weight-strong); padding: 2px 8px; border-radius: 999px; background: var(--accent-soft); color: var(--accent-contrast); line-height: 1.2; white-space: nowrap; } .panel-stat.active { display: inline-flex; } :host([data-mirror-mode]) .panel { box-shadow: none; border-radius: 12px; border: 1px solid rgba(0, 0, 0, 0.08); background: var(--mirror-bg, var(--panel-bg)); color: var(--mirror-text, var(--text)); } :host([data-mirror-mode]) .panel-header, :host([data-mirror-mode]) .panel-footer { background: transparent; border-color: rgba(0, 0, 0, 0.08); } :host([data-mirror-mode]) .panel-body { background: transparent; } :host([data-mirror-mode]) .panel-title { font-weight: 600; letter-spacing: 0.02em; } :host([data-mirror-mode="ixl"][data-mirror-match="on"]) .panel { background: linear-gradient(180deg, rgba(245, 247, 251, 0.96), rgba(245, 247, 251, 0.9)); border-color: rgba(0, 147, 208, 0.18); } :host([data-mirror-mode="ixl"][data-mirror-match="on"]) .panel-title { color: var(--mirror-text, #1f2b4d); font-family: 'Nunito', 'Proxima Nova', var(--font-sans); } :host([data-mirror-mode="blackboard"][data-mirror-match="on"]) .panel { background: linear-gradient(180deg, rgba(32, 32, 32, 0.94), rgba(24, 24, 24, 0.96)); color: var(--mirror-text, #f4f4f4); border-color: rgba(255, 255, 255, 0.12); } :host([data-mirror-mode="blackboard"][data-mirror-match="on"]) .panel-title { font-family: 'Segoe UI', 'Helvetica Neue', var(--font-sans); text-transform: uppercase; letter-spacing: 0.06em; } :host([data-mirror-mode="vocabulary"][data-mirror-match="on"]) .panel { background: linear-gradient(180deg, rgba(248, 241, 227, 0.96), rgba(244, 232, 210, 0.92)); color: var(--mirror-text, #2e2719); border-color: rgba(122, 91, 44, 0.18); } :host([data-mirror-mode="vocabulary"][data-mirror-match="on"]) .panel-title { font-family: 'Merriweather', 'Georgia', serif; } :host([data-notebook-mode]) .panel { background: linear-gradient(180deg, rgba(252, 249, 242, 0.95) 0, rgba(252, 249, 242, 0.95) 23px, rgba(173, 205, 255, 0.45) 24px) repeat-y; background-size: 100% 24px; border-radius: 12px; border: 1px solid rgba(120, 120, 120, 0.28); box-shadow: none; color: rgba(33, 33, 33, 0.92); } :host([data-notebook-mode]) .panel-header { background: transparent; border-bottom: 1px solid rgba(120, 120, 120, 0.28); } :host([data-notebook-mode]) .panel-title { font-family: 'Noticia Text', 'Georgia', serif; font-weight: 600; letter-spacing: 0.03em; } :host([data-notebook-mode]) .chat-messages { background: transparent; } :host([data-notebook-mode]) .chat-input-wrapper { background: rgba(255, 255, 255, 0.8); border-top: 1px solid rgba(120, 120, 120, 0.2); } .panel-actions { display: flex; align-items: center; gap: 4px; } .header-btn { background: none; border: none; color: var(--subtext); width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; } .header-btn svg { width: 18px; height: 18px; } .header-btn:hover { background: var(--elevated); color: var(--text); } .panel-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; } .panel.settings-mode .panel-body { overflow: visible; } .chat-view { flex: 1; display: flex; flex-direction: column; min-height: 0; } .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; -webkit-overflow-scrolling: touch; } .chat-message { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; } .chat-message.user { align-items: flex-end; } .chat-message p { margin: 0; padding: 10px 14px; border-radius: 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; background: var(--elevated); border: 1px solid var(--panel-border); color: var(--text); } .chat-message.user p { background: var(--accent); border-color: transparent; color: #ffffff; } .chat-message.bot p { background: var(--elevated); border: 1px solid var(--panel-border); color: var(--text); } .chat-message img { max-width: 100%; max-height: 240px; border-radius: 12px; margin-bottom: 4px; object-fit: contain; } .panel-footer { background: var(--panel-footer-bg); border-top: 1px solid var(--panel-border); padding: 8px 16px 12px; display: flex; flex-direction: column; gap: 10px; } .image-preview { display: none; align-items: center; gap: 12px; padding: 8px 10px; border-radius: 12px; border: 1px dashed var(--panel-border); background: var(--elevated); } .image-preview img { max-height: 64px; border-radius: 8px; } .image-preview button { background: transparent; border: none; color: var(--text); font-size: 20px; cursor: pointer; } .chat-input-wrapper { display: flex; align-items: center; gap: 8px; } .chat-input { flex: 1; background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 14px; height: 42px; transition: border 0.2s ease, box-shadow 0.2s ease; } .chat-input::placeholder { color: var(--subtext); } .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15); } .attach-btn, .screenshot-btn, .send-btn { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--panel-border); background: var(--elevated); color: var(--text); display: grid; place-items: center; cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease; } .attach-btn svg, .screenshot-btn svg, .send-btn svg { width: 20px; height: 20px; } .attach-btn:hover, .screenshot-btn:hover, .send-btn:hover { background: var(--accent); border-color: var(--accent); color: #041019; transform: translateY(-1px); } .settings-view { display: none; padding: 18px 18px 22px; overflow-y: auto; gap: 14px; background: transparent; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch; } .panel.settings-mode .chat-view { display: none; } .panel.settings-mode .settings-view { display: flex; flex-direction: column; min-height: 0; } .panel.settings-mode .panel-footer { display: none; } .settings-section { position: relative; margin-bottom: 12px; border: 1px solid var(--panel-border); border-radius: 12px; background: var(--surface); overflow: visible; transition: border 0.2s ease, box-shadow 0.2s ease; } .settings-section summary { list-style: none; display: flex; align-items: center; justify-content: space-between; gap: 14px; padding: 14px 18px; cursor: pointer; background: transparent; transition: background 0.2s ease; border-radius: 12px; } .settings-section[open] summary { border-radius: 12px 12px 0 0; border-bottom: 1px solid var(--panel-border); } .settings-section summary::-webkit-details-marker { display: none; } .settings-section summary:hover { background: var(--elevated); } .summary-text { display: flex; flex-direction: column; gap: 2px; } .summary-title { font-size: 15px; font-weight: var(--font-weight-heading); color: var(--text); } .summary-caption { font-size: 12px; color: var(--subtext); opacity: 0.85; } .summary-icon { width: 12px; height: 12px; border-right: 2px solid var(--subtext); border-bottom: 2px solid var(--subtext); transform: rotate(45deg); transition: transform 0.2s ease; } .settings-section[open] .summary-icon { transform: rotate(225deg); } .settings-section .section-content { padding: 14px 16px 18px; display: flex; flex-direction: column; gap: 14px; border-radius: 0 0 12px 12px; background: var(--surface); border-top: 1px solid var(--panel-border); } .settings-section .info-card { padding: 14px; border-radius: 12px; border: 1px dashed var(--panel-border); background: color-mix(in srgb, var(--panel-bg) 85%, transparent); color: var(--subtext); line-height: 1.5; font-size: 13px; } .settings-section .info-card ul { margin: 8px 0 0; padding-left: 18px; display: flex; flex-direction: column; gap: 6px; } .field-group { display: flex; flex-direction: column; gap: 6px; } .field-group.full textarea { min-height: 140px; } .field-label { font-size: 13px; font-weight: var(--font-weight-heading); color: var(--subtext); } .field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: start; } .field-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; } .field-pair { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; } .range-with-value { display: flex; align-items: center; gap: 10px; } .range-with-value input[type="range"] { flex: 1; } .range-with-value .range-value { min-width: 40px; text-align: right; font-size: 12px; color: var(--subtext); } .stealth-fade-group { margin-top: 6px; transition: opacity 0.2s ease; } :host(:not([data-dim-mode="on"])) .stealth-fade-group { opacity: 0.65; } .control-row, .toggle-row { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding: 4px 0; } .control-label { display: flex; flex-direction: column; gap: 4px; max-width: 70%; } .control-label span { font-size: 14px; font-weight: var(--font-weight-heading); color: var(--text); } .control-label small { font-size: 12px; color: var(--subtext); opacity: 0.85; } .usage-section .code-row { display: flex; align-items: center; gap: 8px; } .usage-section .code-row input[type="text"] { flex: 1; min-width: 0; } .usage-section .btn { white-space: nowrap; } .usage-section .usage-status { font-size: 12px; color: var(--subtext); margin-top: 6px; min-height: 16px; } .usage-section .usage-status.positive { color: var(--success); } .usage-section .usage-status.negative { color: var(--error); } .usage-section .usage-status.warning { color: var(--accent); } :host(:not([data-access-profile="locked"])) .locked-only { display: none !important; } .toggle-row.sub-toggle { margin-left: 18px; opacity: 0.85; } .toggle-row.sub-toggle .control-label span { font-size: 12px; font-weight: var(--font-weight-body); } .toggle-row.sub-toggle .control-label small { font-size: 11px; } .toggle-grid { display: flex; flex-direction: column; gap: 14px; } .theme-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; } .theme-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--panel-border); background: var(--elevated); transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease; } .theme-card.active { border-color: var(--accent); box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25); } .theme-card-main { flex: 1; display: flex; align-items: center; gap: 10px; background: transparent; border: none; color: var(--text); cursor: pointer; padding: 0; text-align: left; } .theme-card-main:hover { color: var(--accent); } .theme-chip { width: 34px; height: 34px; border-radius: 10px; border: 2px solid rgba(0, 0, 0, 0.15); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06); flex-shrink: 0; } .theme-card-name { font-weight: var(--font-weight-heading); font-size: 14px; } .theme-card-actions { display: flex; gap: 6px; } .icon-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--panel-border); background: var(--surface); color: var(--text); display: grid; place-items: center; cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease, color 0.2s ease; } .icon-btn svg { width: 16px; height: 16px; } .icon-btn:hover { transform: translateY(-1px); border-color: var(--accent); color: var(--accent); } .icon-btn.danger:hover { border-color: #ff4d4f; color: #ff8588; } .theme-card.create { justify-content: center; border: 1px dashed var(--panel-border); background: transparent; color: var(--accent); font-weight: var(--font-weight-heading); cursor: pointer; } .theme-card.create:hover { border-color: var(--accent); background: var(--elevated); } .theme-card.create span { display: inline-flex; align-items: center; gap: 8px; } .theme-card.create svg { width: 18px; height: 18px; } .segmented-control { display: inline-flex; align-items: stretch; gap: 4px; background: linear-gradient(135deg, var(--accent-soft), rgba(255, 255, 255, 0.03)); border-radius: 999px; padding: 4px; border: 1px solid var(--accent-soft-border); } .segmented-control input { display: none; } .segmented-control label { flex: 1; min-width: 0; padding: 8px 14px; border-radius: 999px; cursor: pointer; font-size: 13px; color: var(--subtext); background: rgba(255, 255, 255, 0.06); text-align: center; white-space: nowrap; transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; line-height: 1; } .segmented-control label:hover { background: rgba(255, 255, 255, 0.16); } .segmented-control label:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35), 0 0 0 4px rgba(0, 0, 0, 0.25); } .segmented-control input:checked + label { background: var(--accent); color: var(--accent-contrast, #06121e); box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25); transform: translateY(-1px); } .row { display: flex; align-items: center; gap: 12px; } .row.full-width { flex-direction: column; align-items: flex-start; } .row label { font-size: 13px; color: var(--subtext); flex: 1; } .control-stack { display: flex; align-items: center; gap: 8px; width: 100%; } .control-stack select { flex: 1; } .inline-actions { display: flex; align-items: center; gap: 6px; } .toggle { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding: 4px 0; } .toggle span { font-size: 14px; color: var(--text); } .toggle-switch { position: relative; display: inline-flex; align-items: center; width: 48px; height: 26px; } .toggle-switch input { opacity: 0; width: 0; height: 0; } .toggle-switch .slider { position: relative; width: 100%; height: 100%; border-radius: 999px; background: var(--surface); border: 1px solid var(--panel-border); transition: background 0.2s ease, border 0.2s ease; display: flex; align-items: center; padding: 3px; } .toggle-switch .slider .dot { width: 20px; height: 20px; border-radius: 50%; background: var(--subtext); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25); transition: transform 0.2s ease, background 0.2s ease; } .toggle-switch input:checked + .slider { background: var(--accent); border-color: var(--accent); } .toggle-switch input:checked + .slider .dot { transform: translateX(20px); background: #06121e; box-shadow: none; } .toggle-switch input:focus-visible + .slider { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15); } select, textarea, input[type="text"], input[type="number"] { width: 100%; background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 12px; font-size: 14px; transition: border 0.2s ease, box-shadow 0.2s ease; } select:focus, textarea:focus, input[type="text"]:focus, input[type="number"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25); outline: none; } textarea { min-height: 110px; resize: vertical; } .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; } .btn { padding: 8px 14px; border-radius: 10px; border: 1px solid var(--panel-border); background: var(--surface); color: var(--text); font-size: 13px; font-weight: var(--font-weight-strong); cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease; } .btn:hover { transform: translateY(-1px); } .btn.primary { background: var(--accent); border-color: var(--accent); color: #06121e; } .btn.secondary, .btn.outline { background: var(--elevated); border-color: var(--panel-border); } .btn.danger { border-color: #ff4d4f; color: #ff8c8f; background: rgba(255, 77, 79, 0.1); } .btn.danger:hover { background: #ff4d4f; color: #1a0404; } .modal-host { position: fixed; inset: 0; pointer-events: none; } .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.55); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; pointer-events: auto; z-index: 2147483647; } .modal { position: relative; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 18px; padding: 22px 24px; width: min(460px, 92vw); max-height: 84vh; overflow: auto; box-shadow: 0 22px 44px rgba(0, 0, 0, 0.45); } .modal h2 { margin: 0; font-size: 20px; color: var(--text); } .modal-close { position: absolute; top: 12px; right: 14px; background: transparent; border: none; font-size: 26px; color: var(--subtext); cursor: pointer; line-height: 1; } .modal-content { margin-top: 16px; display: flex; flex-direction: column; gap: 18px; } .form-group { display: flex; flex-direction: column; gap: 8px; } .form-group label { font-size: 13px; color: var(--subtext); } .form-group input { background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 12px; } .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 14px; } .theme-preview { display: flex; flex-direction: column; gap: 12px; padding: 16px; border: 1px solid var(--panel-border); border-radius: 14px; background: var(--surface); } .theme-preview .preview-shell { border-radius: 14px; overflow: hidden; border: 1px solid var(--panel-border); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25); transition: background 0.3s ease, border 0.3s ease; } .theme-preview .preview-topbar { padding: 10px 14px; font-weight: var(--font-weight-heading); font-size: 13px; } .theme-preview .preview-body { padding: 14px; display: flex; flex-direction: column; gap: 8px; min-height: 90px; } .theme-preview .bubble { border-radius: 10px; padding: 8px 12px; font-size: 12px; color: inherit; opacity: 0.9; } .theme-preview .bubble.user { align-self: flex-end; font-weight: var(--font-weight-heading); } .theme-preview .bubble.bot { align-self: flex-start; } .theme-preview[data-scope="background"] .preview-topbar { opacity: 0.85; } .modal-field { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--subtext); } .modal-field input[type="color"] { width: 100%; height: 44px; border-radius: 10px; border: 1px solid var(--panel-border); background: transparent; cursor: pointer; padding: 0; } .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 6px; } .autosave-hint { text-align: center; font-size: 12px; color: var(--subtext); margin-top: 4px; } .copyright { font-size: 12px; color: var(--subtext); margin-top: 6px; text-align: center; } :host([data-gradient="on"]) { --panel-bg: var(--gradient-background); } .toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150%); background: var(--elevated); color: var(--text); padding: 14px 22px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: var(--shadow-lg); opacity: 0; transition: all 0.4s cubic-bezier(0.2, 1, 0.2, 1); z-index: 2147483647; max-width: 80%; text-align: center; pointer-events: auto; } .toast.show { opacity: 1; transform: translate(-50%, 0); } .toast.success { background: var(--success); color: #ffffff; border-color: transparent; } .toast.error { background: var(--error); color: #ffffff; border-color: transparent; } .toast.info { background: var(--elevated); color: var(--text); } :host([data-theme-scope="background"]) { --panel-bg: var(--surface); --panel-header-bg: var(--surface); --panel-footer-bg: var(--surface); --panel-border: var(--border); } @media (max-width: 520px) { .panel { width: calc(100vw - 32px); height: min(560px, calc(100vh - 32px)); } } `; } try { main(); } catch (e) { console.error((ACTIVE_SITE && ACTIVE_SITE.title ? ACTIVE_SITE.title : 'IXL Helper') + ' failed to initialize:', e); } })();
