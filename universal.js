javascript:(function(){ if (window.__ixlHelperInjected) return; window.__ixlHelperInjected = true; var API_KEY = 'AIzaSyAS8HjnF9tIwMO-7Wuih68ZIw8pTCzRTDQ'; var defaultSettings = { theme: "Midnight", copyKey: "c", toggleKey: "Tab", prependMessage: "You are an expert IXL tutor. Read each question carefully and provide ONLY the exact text of the correct answer choice.\n\nGuidelines:\n- Grammar: Choose the option that follows proper grammar rules\n- Math: Calculate precisely and provide the exact numerical answer or choice text\n- Reading: Answer based on the passage content, not outside knowledge\n- Science: Use scientific facts and principles\n- For yes/no questions: Answer 'yes' or 'no' only\n- For multiple choice: Give the exact text of the correct option\n- For \"select all that apply\" or \"two/three\" answers: List each correct answer on a separate line\n- For table/checklist questions: Identify which rows and columns need to be selected\n- Double-check your reasoning before answering\n\nProvide ONLY the answer text, no explanations.", prependPresets: { "Expert Tutor (Default)": "You are an expert IXL tutor. Read each question carefully and provide ONLY the exact text of the correct answer choice.\n\nGuidelines:\n- Grammar: Choose the option that follows proper grammar rules\n- Math: Calculate precisely and provide the exact numerical answer or choice text\n- Reading: Answer based on the passage content, not outside knowledge\n- Science: Use scientific facts and principles\n- For yes/no questions: Answer 'yes' or 'no' only\n- For multiple choice: Give the exact text of the correct option\n- For \"select all that apply\" or \"two/three\" answers: List each correct answer on a separate line\n- For table/checklist questions: Identify which rows and columns need to be selected\n- Double-check your reasoning before answering\n\nProvide ONLY the answer text, no explanations.", "Simple & Direct": "Answer the question with ONLY the exact text of the correct choice. No explanations.", "Grammar Focus": "You are a grammar expert. Choose the grammatically correct option. For complete sentence questions, pick the sentence that follows proper grammar rules. For run-on questions, identify comma splices and fragments. Answer with only the exact text choice.", "Math Specialist": "STOP. READ CAREFULLY.\n\nFor COMPLEMENTARY angles: Find the angle that adds with the given angle to make 90°.\nFor SUPPLEMENTARY angles: Find the angle that adds with the given angle to make 180°.\nFor VERTICAL angles: Find the angle directly opposite when lines intersect.\n\nLook at the answer choices. Pick the ONE angle name that matches the geometric relationship.\n\nExample: If choices are A, B, C, D and you need complementary to AFB, check which angle forms 90° with AFB.\n\nGive ONLY the letter answer or angle name. Nothing else.", "Reading Comprehension": "Base your answer ONLY on the passage provided. Do not use outside knowledge. Find evidence in the text. For main idea questions, look for the central theme. For detail questions, find specific information. Answer with exact choice text.", "Science Expert": "Use scientific facts and principles. For physics: apply formulas correctly. For biology: use classification and processes. For chemistry: consider reactions and properties. Answer with exact choice text only.", "Test Taking Mode": "Read carefully. Eliminate wrong answers. Look for key words. Double-check your reasoning. Provide ONLY the exact answer text with same capitalization as shown.", "Geometry Expert": "You are solving angle problems. CRITICAL RULES:\n\n1. COMPLEMENTARY = angles that add to 90°\n2. SUPPLEMENTARY = angles that add to 180°\n3. VERTICAL = opposite angles when lines cross\n4. MEASUREMENT = read protractor carefully\n\nFor PROTRACTOR questions:\n- Look at where the angle rays meet the scale\n- Use the correct scale (inner/outer numbers)\n- Give the exact degree number\n\nDO NOT explain. Give ONLY the answer (angle name or degree number).", "Protractor Expert": "PROTRACTOR READING - CRITICAL RULES:\n\n⚠️ MOST IXL PROTRACTORS SHOW ACUTE ANGLES (20°-80°)\n\n1. Find the protractor CENTER (small dot/circle)\n2. Identify the BASELINE ray (usually horizontal or at 0°)\n3. Find where the OTHER ray crosses the NUMBER SCALE\n4. Read the SMALLER number if you see two options\n5. Common angles: 30°, 35°, 45°, 60°, 75°\n\n❌ AVOID: 120°, 135°, 150° (these are usually wrong scale)\n✅ PREFER: Numbers between 20°-80°\n\nGive ONLY the number (like '35').", "Table Expert": "TABLE/CHECKLIST QUESTION EXPERT\n\nFor table questions with checkboxes/radio buttons:\n1. Read each row carefully\n2. Determine which column category each row belongs to\n3. List your answers clearly\n\nFormat your response as:\nRow 1: Column Name\nRow 2: Column Name\nRow 3: Column Name\n\nExample:\nThe king forced colonists to house soldiers: Military\nThe king cut off trade: Economic\nThe king denied trials: Judicial\n\nBe precise and concise.", "Custom": "" }, autoHighlight: false, autoSelect: false, autoSubmit: false, autoDetect: false, selectionDelay: 3, submitDelay: 5, fillInBlank: false, highlightColor: "#00aaff", highlightOpacity: 0.15, rainbowHighlight: false, autoCopy: false, showFloatingButton: true, showQuickCopyButton: true, autoHideSideButtons: true, sideButtonTransparency: 0, gradientEnabled: false, backgroundTransparency: 0, panelTransparency: 0, themeScope: "full", btnPos: { top: "20px", left: "20px" }, panelPos: { top: "85px", left: "20px" }, customThemes: {}, removedThemes: {}, customPrepends: {}, removedPrepends: {}, themes: { Midnight: { bg: "#0a0a0a", surface: "#1a1a1a", elevated: "#2a2a2a", text: "#ffffff", subtext: "#b0b0b0", border: "#333333", accent: "#00d4ff", accentHover: "#33dfff", success: "#00ff88", error: "#ff4444", gradientFrom: "#0f172a", gradientTo: "#1f2937" }, Nord: { bg: "#2e3440", surface: "#3b4252", elevated: "#434c5e", text: "#d8dee9", subtext: "#e5e9f0", border: "#4c566a", accent: "#88c0d0", accentHover: "#8fbcbb", success: "#a3be8c", error: "#bf616a", gradientFrom: "#2e3440", gradientTo: "#4c566a" }, Latte: { bg: "#eff1f5", surface: "#e6e9ef", elevated: "#dce0e8", text: "#4c4f69", subtext: "#5c5f77", border: "#ccd0da", accent: "#1e66f5", accentHover: "#4082f7", success: "#40a02b", error: "#d20f39", gradientFrom: "#f2f4f8", gradientTo: "#e1e7f5" }, Ocean: { bg: "#0c1445", surface: "#1a237e", elevated: "#283593", text: "#e8eaf6", subtext: "#c5cae9", border: "#3949ab", accent: "#00bcd4", accentHover: "#26c6da", success: "#4caf50", error: "#f44336", gradientFrom: "#0c1445", gradientTo: "#1b2b7d" }, Forest: { bg: "#1b2e1b", surface: "#2e4a2e", elevated: "#3d5a3d", text: "#e8f5e8", subtext: "#c8e6c8", border: "#4caf50", accent: "#8bc34a", accentHover: "#9ccc65", success: "#4caf50", error: "#f44336", gradientFrom: "#1b2e1b", gradientTo: "#3b5d3b" }, Sunset: { bg: "#2d1b2e", surface: "#4a2c4a", elevated: "#5d3a5d", text: "#f8e8f8", subtext: "#e8c8e8", border: "#9c27b0", accent: "#e91e63", accentHover: "#f06292", success: "#4caf50", error: "#f44336", gradientFrom: "#33152f", gradientTo: "#552454" }, Cyber: { bg: "#0a0a0a", surface: "#1a1a1a", elevated: "#2a2a2a", text: "#00ff00", subtext: "#00cc00", border: "#333333", accent: "#00ffff", accentHover: "#33ffff", success: "#00ff00", error: "#ff0000", gradientFrom: "#050505", gradientTo: "#111111" }, Royal: { bg: "#1a0d2e", surface: "#2d1b4e", elevated: "#3d2a5d", text: "#f0e6ff", subtext: "#d9c7ff", border: "#6a4c93", accent: "#9c27b0", accentHover: "#ba68c8", success: "#4caf50", error: "#f44336", gradientFrom: "#1d1035", gradientTo: "#3a2166" } } }; const SITE_DEFINITIONS = [ { key: "ixl", title: "IXL Helper", matches: [/^(?:[a-z0-9-]+\.)*ixl\.com$/i], toolsTab: { id: "ixl-tools", label: "IXL Tools" }, features: { automation: true, autoDetect: true } }, { key: "blackboard", title: "Blackboard Helper", matches: [/^(?:[a-z0-9-]+\.)*blackboard\.com$/i], toolsTab: { id: "blackboard-tools", label: "Blackboard Tools" }, features: { automation: false, autoDetect: false } }, { key: "vocabulary", title: "Vocabulary Helper", matches: [/^(?:[a-z0-9-]+\.)*vocabulary\.com$/i], toolsTab: { id: "vocabulary-tools", label: "Vocabulary Tools" }, features: { automation: false, autoDetect: false } } ]; const DEFAULT_SITE = { key: "generic", title: "AI Study Helper", toolsTab: null, features: { automation: false, autoDetect: false } }; function detectActiveSite() { var host = window.location.hostname.toLowerCase(); for (var i = 0; i < SITE_DEFINITIONS.length; i++) { var site = SITE_DEFINITIONS[i]; if (site.matches.some(function (rx) { return rx.test(host); })) { return site; } } return DEFAULT_SITE; } const ACTIVE_SITE = detectActiveSite(); function deepClone(value) { if (value === undefined) return undefined; return JSON.parse(JSON.stringify(value)); } function isDefaultTheme(name) { return Object.prototype.hasOwnProperty.call(defaultSettings.themes, name); } function isDefaultPreset(name) { return Object.prototype.hasOwnProperty.call(defaultSettings.prependPresets, name); } function buildThemeLibrary(settings) { var library = {}; var removed = settings.removedThemes || {}; Object.keys(defaultSettings.themes).forEach(function (name) { if (!removed[name]) library[name] = deepClone(defaultSettings.themes[name]); }); var custom = settings.customThemes || {}; Object.keys(custom).forEach(function (name) { if (!custom[name] || removed[name]) return; library[name] = deepClone(custom[name]); }); if (!Object.keys(library).length) { library.Midnight = deepClone(defaultSettings.themes.Midnight); if (settings.removedThemes) delete settings.removedThemes.Midnight; } return library; } function buildPrependLibrary(settings) { var library = {}; var removed = settings.removedPrepends || {}; Object.keys(defaultSettings.prependPresets).forEach(function (name) { if (!removed[name]) library[name] = defaultSettings.prependPresets[name]; }); var custom = settings.customPrepends || {}; Object.keys(custom).forEach(function (name) { if (custom[name] === null || custom[name] === undefined || removed[name]) return; library[name] = custom[name]; }); if (!Object.keys(library).length) { library.Custom = ""; if (settings.removedPrepends) delete settings.removedPrepends.Custom; } return library; } function refreshComputedSettings(settings) { settings.themes = buildThemeLibrary(settings); settings.prependPresets = buildPrependLibrary(settings); } function sanitizeSettingsForSave(settings) { var copy = deepClone(settings) || {}; delete copy.themes; delete copy.prependPresets; return copy; } function ensurePlainObject(value) { return value && typeof value === "object" ? deepClone(value) : {}; } function areObjectsEqual(a, b) { if (a === b) return true; if (!a || !b) return false; try { return JSON.stringify(a) === JSON.stringify(b); } catch (e) { return false; } } function clampTransparency(value, fallback) { var base = typeof fallback === "number" ? fallback : 0; if (value === undefined || value === null) return base; var parsed = parseFloat(value); if (isNaN(parsed)) return base; return Math.max(0, Math.min(100, Math.round(parsed))); } function convertHexToRgba(color, alpha) { var fallbackAlpha = typeof alpha === "number" ? alpha : 1; var normalizedAlpha = Math.max(0, Math.min(1, fallbackAlpha)); if (!color || typeof color !== "string") { return "rgba(0,0,0," + normalizedAlpha + ")"; } var ctx = convertHexToRgba._ctx; if (!ctx) { var canvas = document.createElement("canvas"); convertHexToRgba._ctx = canvas.getContext && canvas.getContext("2d"); ctx = convertHexToRgba._ctx; } var parsed = color.trim(); if (ctx) { try { ctx.fillStyle = "#000"; ctx.fillStyle = parsed; parsed = ctx.fillStyle || parsed; } catch (err) { parsed = parsed || "#000"; } } if (!parsed) { return "rgba(0,0,0," + normalizedAlpha + ")"; } if (parsed[0] === "#") { var value = parsed.slice(1); if (value.length === 3) { value = value[0] + value[0] + value[1] + value[1] + value[2] + value[2]; } if (value.length === 6) { var r = parseInt(value.slice(0, 2), 16); var g = parseInt(value.slice(2, 4), 16); var b = parseInt(value.slice(4, 6), 16); if (!isNaN(r) && !isNaN(g) && !isNaN(b)) { return "rgba(" + r + "," + g + "," + b + "," + normalizedAlpha + ")"; } } } var rgbMatch = parsed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if (rgbMatch) { var rVal = parseInt(rgbMatch[1], 10); var gVal = parseInt(rgbMatch[2], 10); var bVal = parseInt(rgbMatch[3], 10); if (!isNaN(rVal) && !isNaN(gVal) && !isNaN(bVal)) { return "rgba(" + rVal + "," + gVal + "," + bVal + "," + normalizedAlpha + ")"; } } return "rgba(0,0,0," + normalizedAlpha + ")"; } function getContrastColor(hex) { if (!hex || typeof hex !== "string") return "#06121e"; var value = hex.replace(/^#/, ""); if (value.length === 3) { value = value[0] + value[0] + value[1] + value[1] + value[2] + value[2]; } if (value.length !== 6) return "#06121e"; var r = parseInt(value.slice(0, 2), 16); var g = parseInt(value.slice(2, 4), 16); var b = parseInt(value.slice(4, 6), 16); if (isNaN(r) || isNaN(g) || isNaN(b)) return "#06121e"; var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.55 ? "#08111d" : "#ffffff"; } function computePanelSurfaces(theme, settings) { var normalizedBackground = clampTransparency( settings.backgroundTransparency, defaultSettings.backgroundTransparency ); var normalizedPanel = clampTransparency( settings.panelTransparency, defaultSettings.panelTransparency ); var backgroundOpacity = 1 - normalizedBackground / 100; var panelOpacity = 1 - normalizedPanel / 100; var gradientFrom = theme.gradientFrom || theme.bg || "#0a0a0a"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg || gradientFrom; var surface = theme.surface || theme.bg || gradientFrom; var elevated = theme.elevated || surface; var border = theme.border || gradientFrom; var gradientPanelBg = "linear-gradient(135deg, " + convertHexToRgba(gradientFrom, panelOpacity) + ", " + convertHexToRgba(gradientTo, panelOpacity) + ")"; return { values: { backgroundTransparency: normalizedBackground, panelTransparency: normalizedPanel, backgroundOpacity: backgroundOpacity, panelOpacity: panelOpacity }, panelBg: settings.gradientEnabled ? gradientPanelBg : convertHexToRgba(surface, panelOpacity), headerBg: convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.05)), footerBg: convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.1)), border: convertHexToRgba(border, Math.min(1, panelOpacity + 0.35)), solidBackground: convertHexToRgba(theme.bg || gradientFrom, backgroundOpacity), gradientBackground: "linear-gradient(135deg, " + convertHexToRgba(gradientFrom, backgroundOpacity) + ", " + convertHexToRgba(gradientTo, backgroundOpacity) + ")" }; } var ICONS = { CHAT:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>', SETTINGS:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>', CLOSE:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>', BACK:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>', SEND:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>', COPY:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>', ATTACH:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>', PENCIL:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>', TRASH:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>', PLUS:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>' }; function loadSettings() { var storedSettings = {}; try { storedSettings = JSON.parse(localStorage.getItem("ixlHelperSettings") || "{}") || {}; } catch (err) { storedSettings = {}; } var parsedHighlight = defaultSettings.highlightOpacity; if (storedSettings.highlightOpacity !== undefined) { var highlightNumber = parseFloat(storedSettings.highlightOpacity); if (!isNaN(highlightNumber)) { parsedHighlight = Math.max(0, Math.min(1, highlightNumber)); } } var derivedAutoHide = storedSettings.autoHideSideButtons; if (derivedAutoHide === undefined) { if (storedSettings.showFloatingButton === false || storedSettings.showQuickCopyButton === false) { derivedAutoHide = true; } } var sideTransparency = clampTransparency( storedSettings.sideButtonTransparency, defaultSettings.sideButtonTransparency ); var settings = { theme: storedSettings.theme || defaultSettings.theme, copyKey: storedSettings.copyKey || defaultSettings.copyKey, toggleKey: storedSettings.toggleKey || defaultSettings.toggleKey, prependMessage: storedSettings.prependMessage || defaultSettings.prependMessage, autoHighlight: storedSettings.autoHighlight !== undefined ? storedSettings.autoHighlight : defaultSettings.autoHighlight, autoSelect: storedSettings.autoSelect !== undefined ? storedSettings.autoSelect : defaultSettings.autoSelect, autoSubmit: storedSettings.autoSubmit !== undefined ? storedSettings.autoSubmit : defaultSettings.autoSubmit, autoDetect: storedSettings.autoDetect !== undefined ? storedSettings.autoDetect : defaultSettings.autoDetect, selectionDelay: storedSettings.selectionDelay !== undefined ? storedSettings.selectionDelay : defaultSettings.selectionDelay, submitDelay: storedSettings.submitDelay !== undefined ? storedSettings.submitDelay : defaultSettings.submitDelay, fillInBlank: storedSettings.fillInBlank !== undefined ? storedSettings.fillInBlank : defaultSettings.fillInBlank, highlightColor: storedSettings.highlightColor || defaultSettings.highlightColor, highlightOpacity: parsedHighlight, rainbowHighlight: storedSettings.rainbowHighlight !== undefined ? storedSettings.rainbowHighlight : defaultSettings.rainbowHighlight, autoCopy: storedSettings.autoCopy !== undefined ? storedSettings.autoCopy : defaultSettings.autoCopy, showFloatingButton: true, showQuickCopyButton: true, autoHideSideButtons: derivedAutoHide !== undefined ? !!derivedAutoHide : defaultSettings.autoHideSideButtons, sideButtonTransparency: sideTransparency, gradientEnabled: storedSettings.gradientEnabled !== undefined ? storedSettings.gradientEnabled : defaultSettings.gradientEnabled, backgroundTransparency: clampTransparency( storedSettings.backgroundTransparency, defaultSettings.backgroundTransparency ), panelTransparency: clampTransparency( storedSettings.panelTransparency, defaultSettings.panelTransparency ), themeScope: storedSettings.themeScope || defaultSettings.themeScope, btnPos: deepClone(storedSettings.btnPos) || deepClone(defaultSettings.btnPos), panelPos: deepClone(storedSettings.panelPos) || deepClone(defaultSettings.panelPos), customThemes: ensurePlainObject(storedSettings.customThemes), removedThemes: ensurePlainObject(storedSettings.removedThemes), customPrepends: ensurePlainObject(storedSettings.customPrepends), removedPrepends: ensurePlainObject(storedSettings.removedPrepends) }; if (storedSettings.themes && typeof storedSettings.themes === "object") { Object.keys(storedSettings.themes).forEach(function (name) { var value = storedSettings.themes[name]; if (!value || settings.removedThemes[name]) return; if (!isDefaultTheme(name) || !areObjectsEqual(defaultSettings.themes[name], value)) { settings.customThemes[name] = deepClone(value); } }); } if (storedSettings.prependPresets && typeof storedSettings.prependPresets === "object") { Object.keys(storedSettings.prependPresets).forEach(function (name) { var value = storedSettings.prependPresets[name]; if (value === undefined || value === null || settings.removedPrepends[name]) return; if (!isDefaultPreset(name) || defaultSettings.prependPresets[name] !== value) { settings.customPrepends[name] = value; } }); } refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { var firstTheme = Object.keys(settings.themes)[0]; settings.theme = firstTheme || defaultSettings.theme; } if (settings.themeScope !== "background") settings.themeScope = "full"; settings.gradientEnabled = !!settings.gradientEnabled; settings.selectionDelay = parseInt(settings.selectionDelay, 10); if (isNaN(settings.selectionDelay) || settings.selectionDelay < 0) { settings.selectionDelay = defaultSettings.selectionDelay; } settings.submitDelay = parseInt(settings.submitDelay, 10); if (isNaN(settings.submitDelay) || settings.submitDelay < 0) { settings.submitDelay = defaultSettings.submitDelay; } var opacity = parseFloat(settings.highlightOpacity); if (isNaN(opacity)) opacity = defaultSettings.highlightOpacity; settings.highlightOpacity = Math.max(0, Math.min(1, opacity)); if (!settings.btnPos || typeof settings.btnPos.top === "undefined") { settings.btnPos = deepClone(defaultSettings.btnPos); } if (!settings.panelPos || typeof settings.panelPos.top === "undefined") { settings.panelPos = deepClone(defaultSettings.panelPos); } if (!Object.keys(settings.prependPresets).length) { settings.prependPresets.Custom = ""; } if (!settings.prependMessage) { settings.prependMessage = defaultSettings.prependMessage; } return settings; } function saveSettings(settings) { try { var prepared = sanitizeSettingsForSave(settings); localStorage.setItem("ixlHelperSettings", JSON.stringify(prepared || {})); } catch (err) {} } function main() { var settings = loadSettings(); if (document.body) init(settings, ACTIVE_SITE); else window.addEventListener("DOMContentLoaded", function () { init(settings, ACTIVE_SITE); }); } function init(settings, site) { var host = document.createElement("div"); host.id = "ixl-helper-host"; host.style.zIndex = "2147483647"; host.style.position = "fixed"; host.style.top = "0"; host.style.left = "0"; host.style.width = "0"; host.style.height = "0"; document.body.appendChild(host); var shadow = host.attachShadow({ mode: "open" }); ensureGlobalHighlightStyles(settings); var UI = createUI(host, shadow, settings, site); applyTheme(UI, settings); var sendMessage = createSendMessageFunction(UI, settings, site); setupEventListeners(UI, settings, sendMessage, site); if (site.features.autoDetect) { initQuestionObserver(UI, settings, sendMessage, site); } } function createUI(host, shadow, settings, site) { var theme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var style = document.createElement("style"); style.textContent = getCSS(settings, theme); shadow.appendChild(style); var floatingBtn = document.createElement("button"); floatingBtn.className = "floating-btn"; floatingBtn.innerHTML = ICONS.CHAT; floatingBtn.title = 'Open ' + site.title; shadow.appendChild(floatingBtn); var quickCopyBtn = document.createElement("button"); quickCopyBtn.className = "quick-copy-btn"; quickCopyBtn.innerHTML = ICONS.COPY; quickCopyBtn.title = 'Copy question to ' + site.title; shadow.appendChild(quickCopyBtn); var panel = document.createElement("div"); panel.className = "panel"; panel.innerHTML = getPanelHTML(site); shadow.appendChild(panel); var settingsView = panel.querySelector(".settings-view"); if (settingsView) { var sections = Array.from(settingsView.querySelectorAll('.settings-section')); sections.forEach(function (section) { var category = section.getAttribute('data-category'); if (site.key !== 'ixl' && (category === 'automation' || category === 'interface')) { section.remove(); } }); if (site.key !== 'ixl') { var infoDetails = document.createElement('details'); infoDetails.className = 'settings-section'; infoDetails.setAttribute('data-category', 'site-info'); infoDetails.open = true; var summary = document.createElement('summary'); var title = site.key === 'blackboard' ? 'Blackboard Tools' : 'Vocabulary Tools'; var caption = site.key === 'blackboard' ? 'Enhancements tuned for MASD Blackboard questions.' : 'Highlight helpers tailored for Vocabulary.com passages.'; summary.innerHTML = '<div class="summary-text"><span class="summary-title">' + title + '</span><span class="summary-caption">' + caption + '</span></div><span class="summary-icon"></span>'; infoDetails.appendChild(summary); var content = document.createElement('div'); content.className = 'section-content info-section'; var card = document.createElement('div'); card.className = 'info-card'; var list = document.createElement('ul'); var points = site.key === 'blackboard' ? [ 'Multi-answer checkbox groups highlight accurately.', 'Answer parsing respects Blackboard rich text labels.', 'Use the Highlighting section to fine-tune colors and opacity.' ] : [ 'Highlights stay aligned with long reading passages.', 'Prepend profiles help you switch study personas quickly.', 'Automation stays off here for consistent workflows.' ]; points.forEach(function (text) { var li = document.createElement('li'); li.textContent = text; list.appendChild(li); }); card.appendChild(list); content.appendChild(card); infoDetails.appendChild(content); var autosaveHint = settingsView.querySelector('.autosave-hint'); settingsView.insertBefore(infoDetails, autosaveHint || settingsView.lastChild); } } var fileInput = document.createElement("input"); fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.style.display = "none"; shadow.appendChild(fileInput); var modalHost = document.createElement("div"); modalHost.className = "modal-host"; shadow.appendChild(modalHost); var UI = { shadow: shadow, host: host, style: style, floatingBtn: floatingBtn, quickCopyBtn: quickCopyBtn, panel: panel, fileInput: fileInput, modalHost: modalHost, title: panel.querySelector(".panel-title"), closeBtn: panel.querySelector(".close-btn"), settingsBtn: panel.querySelector(".settings-btn"), copyBtn: panel.querySelector(".copy-btn"), settingsView: settingsView, autoSelectToggle: panel.querySelector("#auto-select-toggle"), autoSubmitToggle: panel.querySelector("#auto-submit-toggle"), autoHighlightToggle: panel.querySelector("#auto-highlight-toggle"), autoDetectToggle: panel.querySelector("#auto-detect-toggle"), prependMessageInput: panel.querySelector("#prepend-message-input"), selectionDelayInput: panel.querySelector("#selection-delay"), submitDelayInput: panel.querySelector("#submit-delay"), copyrightYear: panel.querySelector("#copyright-year"), messages: panel.querySelector(".chat-messages"), chatInput: panel.querySelector(".chat-input"), sendBtn: panel.querySelector(".send-btn"), attachBtn: panel.querySelector(".attach-btn"), screenshotBtn: panel.querySelector(".screenshot-btn"), imagePreview: panel.querySelector(".image-preview"), themeList: panel.querySelector("#theme-list"), fillInBlankToggle: panel.querySelector("#fill-in-blank-toggle"), highlightColorInput: panel.querySelector("#highlight-color"), highlightOpacityInput: panel.querySelector("#highlight-opacity"), rainbowHighlightToggle: panel.querySelector("#rainbow-highlight-toggle"), autoCopyToggle: panel.querySelector("#auto-copy-toggle"), prependPresetSelect: panel.querySelector("#prepend-preset-select"), gradientToggle: panel.querySelector("#gradient-toggle"), backgroundTransparencyInput: panel.querySelector("#background-transparency"), panelTransparencyInput: panel.querySelector("#panel-transparency"), backgroundTransparencyValue: panel.querySelector("#background-transparency-value"), panelTransparencyValue: panel.querySelector("#panel-transparency-value"), autoHideButtonsToggle: panel.querySelector("#auto-hide-side-buttons"), sideButtonTransparencyInput: panel.querySelector("#side-button-transparency"), sideButtonTransparencyValue: panel.querySelector("#side-button-transparency-value"), themeScopeInputs: Array.from(panel.querySelectorAll('input[name="theme-scope"]')), prependNameInput: panel.querySelector("#prepend-name-input"), prependSaveBtn: panel.querySelector("#prepend-save-btn"), prependUpdateBtn: panel.querySelector("#prepend-update-btn"), prependDeleteBtn: panel.querySelector("#prepend-delete-btn"), site: site }; UI.updateTransparencyDisplays = function () { if (UI.backgroundTransparencyInput) { UI.backgroundTransparencyInput.value = settings.backgroundTransparency; } if (UI.panelTransparencyInput) { UI.panelTransparencyInput.value = settings.panelTransparency; } if (UI.backgroundTransparencyValue) { UI.backgroundTransparencyValue.textContent = settings.backgroundTransparency + "%"; } if (UI.panelTransparencyValue) { UI.panelTransparencyValue.textContent = settings.panelTransparency + "%"; } if (UI.sideButtonTransparencyInput) { UI.sideButtonTransparencyInput.value = settings.sideButtonTransparency; } if (UI.sideButtonTransparencyValue) { UI.sideButtonTransparencyValue.textContent = settings.sideButtonTransparency + "%"; } }; UI.attachedImageBase64 = null; UI.attachedImageMime = null; floatingBtn.style.top = settings.btnPos.top; floatingBtn.style.left = settings.btnPos.left; quickCopyBtn.style.top = "calc(" + settings.btnPos.top + " + 60px)"; quickCopyBtn.style.left = settings.btnPos.left; panel.style.top = settings.panelPos.top; panel.style.left = settings.panelPos.left; if (settings.panelPos.left === "50%") panel.style.transform = "translate(-50%, -50%) scale(0.95)"; else panel.style.transform = "scale(0.95)"; makeDraggable(floatingBtn, "btnPos", settings, null, [quickCopyBtn]); makeDraggable(panel, "panelPos", settings, panel.querySelector(".panel-header")); return UI; } function createSendMessageFunction(UI, settings, site) { function sendMessageWithRetries(payload, loadingMessage, retries) { retries = retries || 2; function attempt(retryCount) { var geminiPayload = { contents: [{ parts: [] }] }; if (payload.message) geminiPayload.contents[0].parts.push({ text: payload.message }); if (payload.image) { geminiPayload.contents[0].parts.push({ inlineData: { mimeType: payload.imageMime || "image/png", data: payload.image } }); } fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(geminiPayload) }) .then(function (response) { if (response.status >= 400) throw new Error("HTTP error " + response.status); return response.json(); }) .then(function (data) { var responseText = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || "Error: No response from Gemini"; if (loadingMessage) loadingMessage.querySelector("p").textContent = responseText; showToast(UI, "Answer: " + responseText, "success"); if (settings.autoHighlight) highlightAnswer(UI, responseText, settings); var canAutomate = site.features.automation; var fillSuccess = canAutomate ? fillInTheBlank(UI, responseText, settings) : false; if (canAutomate && settings.autoSelect && !fillSuccess) { var selectionSuccess = selectAnswer(UI, responseText); if (selectionSuccess && settings.autoSubmit) { var delaySeconds = settings.submitDelay || 5; setTimeout(function () { submitAnswer(UI); }, delaySeconds * 1000); } } if (canAutomate && settings.autoSubmit && !settings.autoSelect) { var delayOnly = settings.submitDelay || 5; setTimeout(function () { submitAnswer(UI); }, delayOnly * 1000); } }) .catch(function (error) { if (retryCount < retries) { if (loadingMessage) loadingMessage.querySelector("p").textContent = "AI is slow, retrying... (" + (retryCount + 1) + ")"; setTimeout(function () { attempt(retryCount + 1); }, 2000 * (retryCount + 1)); } else { var errorMsg = "Error: " + (error.message || "AI failed to respond."); if (loadingMessage) loadingMessage.querySelector("p").textContent = errorMsg; showToast(UI, errorMsg, "error"); } }); } attempt(0); } return function (text, image, isQuickCopy) { isQuickCopy = isQuickCopy || false; var messageText = typeof text === "string" ? text : UI.chatInput.value.trim(); var imageBase64 = null; var imageMime = null; if (image && typeof image === "object") { imageBase64 = image.base64 || null; imageMime = image.mime || null; } else if (typeof image === "string") { imageBase64 = image; } else { imageBase64 = UI.attachedImageBase64 || null; imageMime = UI.attachedImageMime || null; } if (imageBase64 && !imageMime) imageMime = "image/png"; if (!messageText && !imageBase64) return; var loadingMessage = null; if (!isQuickCopy) { var dataUrl = imageBase64 ? "data:" + imageMime + ";base64," + imageBase64 : null; appendMessage(UI, "user", messageText, dataUrl); if (typeof text !== "string") UI.chatInput.value = ""; if (UI.clearImagePreview) UI.clearImagePreview(); scrollMessagesToBottom(UI); loadingMessage = appendMessage(UI, "bot", "● ● ●"); } else { showToast(UI, "Getting answer...", "info"); scrollMessagesToBottom(UI); } sendMessageWithRetries({ message: messageText, image: imageBase64, imageMime: imageMime }, loadingMessage); }; } function setupEventListeners(UI, settings, sendMessage, site) { refreshComputedSettings(settings); UI.sendMessage = sendMessage; var attachedImageBase64 = null; var attachedImageMime = null; UI.copyrightYear.textContent = new Date().getFullYear(); var saveTimer = null; function queueSave(options) { options = options || {}; if (saveTimer) clearTimeout(saveTimer); var delay = typeof options.delay === "number" ? options.delay : 250; saveTimer = setTimeout(function () { saveTimer = null; if (options.refresh !== false) { refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { var fallbackTheme = Object.keys(settings.themes)[0]; if (fallbackTheme) settings.theme = fallbackTheme; } } saveSettings(settings); }, delay); } function setPanelOpen(forceOpen) { var transform = UI.panel.style.left === "50%" ? "translate(-50%, -50%)" : ""; if (forceOpen) { UI.panel.classList.add("open"); UI.panel.style.transform = transform ? transform + " scale(1)" : "scale(1)"; scrollMessagesToBottom(UI); if (UI.chatInput && !UI.panel.classList.contains("settings-mode")) { try { UI.chatInput.focus(); } catch (e) {} } } else { UI.panel.classList.remove("open"); UI.panel.style.transform = transform ? transform + " scale(0.95)" : "scale(0.95)"; } updateSideButtonVisibility(); } function togglePanel() { setPanelOpen(!UI.panel.classList.contains("open")); } function ensureChatView(options) { var shouldFocus = !options || options.focus !== false; if (UI.panel.classList.contains("settings-mode")) { UI.panel.classList.remove("settings-mode"); UI.title.textContent = UI.site.title; UI.settingsBtn.innerHTML = ICONS.SETTINGS; } scrollMessagesToBottom(UI); if (shouldFocus && UI.chatInput) { try { UI.chatInput.focus(); } catch (e) {} } } UI.clearImagePreview = function () { attachedImageBase64 = null; attachedImageMime = null; UI.attachedImageBase64 = null; UI.attachedImageMime = null; UI.imagePreview.innerHTML = ""; UI.imagePreview.style.display = "none"; try { UI.fileInput.value = ""; } catch (err) {} }; function updateSideButtonVisibility() { var hideForPanel = settings.autoHideSideButtons !== false && UI.panel.classList.contains("open"); var showFloating = !hideForPanel && settings.showFloatingButton !== false; var showQuickCopy = !hideForPanel && settings.showQuickCopyButton !== false; if (UI.floatingBtn) { UI.floatingBtn.style.display = showFloating ? "" : "none"; } if (UI.quickCopyBtn) { UI.quickCopyBtn.style.display = showQuickCopy ? "" : "none"; } } updateSideButtonVisibility(); function handleImageFile(file) { if (!file || !file.type || !file.type.startsWith("image/")) return; var reader = new FileReader(); reader.onload = function (e) { var dataUrl = e.target.result; attachedImageBase64 = dataUrl.split(",")[1]; attachedImageMime = file.type || "image/png"; UI.attachedImageBase64 = attachedImageBase64; UI.attachedImageMime = attachedImageMime; UI.imagePreview.innerHTML = '<img src="' + dataUrl + '" alt="Attachment preview" /><button aria-label="Remove image">&times;</button>'; UI.imagePreview.style.display = "flex"; var removeBtn = UI.imagePreview.querySelector("button"); if (removeBtn) removeBtn.onclick = UI.clearImagePreview; try { UI.fileInput.value = ""; } catch (err) {} }; reader.readAsDataURL(file); } function getSortedThemeNames() { return Object.keys(settings.themes || {}).sort(function (a, b) { return a.localeCompare(b); }); } function getPresetNames() { return Object.keys(settings.prependPresets || {}).sort(function (a, b) { if (a === "Custom") return -1; if (b === "Custom") return 1; return a.localeCompare(b); }); } function findPresetNameByMessage(message) { if (!message) return ""; var normalized = String(message).trim(); var match = ""; Object.keys(settings.prependPresets || {}).some(function (name) { var preset = settings.prependPresets[name]; if (String(preset || "").trim() === normalized) { match = name; return true; } return false; }); return match; } function renderThemeList(targetName) { refreshComputedSettings(settings); if (!UI.themeList) return; var names = getSortedThemeNames(); if (!names.length) { names = [settings.theme || defaultSettings.theme]; } var active = targetName && settings.themes[targetName] ? targetName : settings.theme; if (!settings.themes[active] && names.length) { active = names[0]; settings.theme = active; } UI.themeList.innerHTML = ""; names.forEach(function (name) { var theme = settings.themes[name]; if (!theme) return; var card = document.createElement("div"); card.className = "theme-card" + (name === settings.theme ? " active" : ""); card.dataset.themeName = name; var mainButton = document.createElement("button"); mainButton.type = "button"; mainButton.className = "theme-card-main"; mainButton.dataset.themeAction = "select"; mainButton.dataset.themeName = name; var chip = document.createElement("span"); chip.className = "theme-chip"; var gradientFrom = theme.gradientFrom || theme.bg || "#000000"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || gradientFrom; chip.style.background = "linear-gradient(135deg, " + gradientFrom + ", " + gradientTo + ")"; chip.style.borderColor = theme.border || gradientFrom; mainButton.appendChild(chip); var nameSpan = document.createElement("span"); nameSpan.className = "theme-card-name"; nameSpan.textContent = name; mainButton.appendChild(nameSpan); card.appendChild(mainButton); var actions = document.createElement("div"); actions.className = "theme-card-actions"; var editBtn = document.createElement("button"); editBtn.type = "button"; editBtn.className = "icon-btn"; editBtn.title = "Edit theme"; editBtn.dataset.themeAction = "edit"; editBtn.dataset.themeName = name; editBtn.innerHTML = ICONS.PENCIL; actions.appendChild(editBtn); var deleteBtn = document.createElement("button"); deleteBtn.type = "button"; deleteBtn.className = "icon-btn danger"; deleteBtn.title = "Delete theme"; deleteBtn.dataset.themeAction = "delete"; deleteBtn.dataset.themeName = name; deleteBtn.innerHTML = ICONS.TRASH; actions.appendChild(deleteBtn); card.appendChild(actions); UI.themeList.appendChild(card); }); var createBtn = document.createElement("button"); createBtn.type = "button"; createBtn.className = "theme-card create"; createBtn.dataset.themeAction = "create"; createBtn.innerHTML = ICONS.PLUS + '<span>Create new theme</span>'; UI.themeList.appendChild(createBtn); } function getThemeScopeValue() { var value = "full"; (UI.themeScopeInputs || []).forEach(function (input) { if (input && input.checked) value = input.value; }); return value === "background" ? "background" : "full"; } function syncThemeScopeUI(value) { var resolved = value === "background" ? "background" : "full"; (UI.themeScopeInputs || []).forEach(function (input) { if (!input) return; input.checked = input.value === resolved; }); } function populatePrependSelect(targetName) { refreshComputedSettings(settings); var names = getPresetNames(); if (!names.length) names = ["Custom"]; var options = names.map(function (name) { return '<option value="' + name + '">' + name + '</option>'; }).join(""); UI.prependPresetSelect.innerHTML = options; var baseMessage = UI.prependMessageInput.value || settings.prependMessage; var resolved = targetName && settings.prependPresets[targetName] !== undefined ? targetName : findPresetNameByMessage(baseMessage); if (!resolved && names.indexOf("Custom") !== -1) resolved = "Custom"; if (!resolved) resolved = names[0]; UI.prependPresetSelect.value = resolved; if (resolved === "Custom") UI.prependNameInput.value = ""; else UI.prependNameInput.value = resolved || ""; } function createModal(title) { var overlay = document.createElement("div"); overlay.className = "modal-overlay"; var modal = document.createElement("div"); modal.className = "modal"; overlay.appendChild(modal); var closeBtn = document.createElement("button"); closeBtn.type = "button"; closeBtn.className = "modal-close"; closeBtn.innerHTML = '&times;'; modal.appendChild(closeBtn); if (title) { var heading = document.createElement("h2"); heading.textContent = title; modal.appendChild(heading); } var content = document.createElement("div"); content.className = "modal-content"; modal.appendChild(content); UI.modalHost.appendChild(overlay); function close() { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); } closeBtn.addEventListener("click", close); overlay.addEventListener("click", function (event) { if (event.target === overlay) close(); }); return { overlay: overlay, modal: modal, content: content, close: close }; } function openThemeEditor(existingName) { var isEdit = !!existingName; var activeTheme = settings.themes[existingName] || settings.themes[settings.theme] || defaultSettings.themes.Midnight; var themeData = deepClone(activeTheme) || deepClone(defaultSettings.themes.Midnight); if (!themeData.gradientFrom) themeData.gradientFrom = themeData.bg || "#000000"; if (!themeData.gradientTo) themeData.gradientTo = themeData.elevated || themeData.surface || themeData.bg || "#000000"; var modal = createModal(isEdit ? "Edit Theme" : "Create Theme"); var form = document.createElement("form"); form.className = "theme-form"; var nameGroup = document.createElement("div"); nameGroup.className = "form-group"; var nameLabel = document.createElement("label"); nameLabel.textContent = "Theme Name"; var nameInput = document.createElement("input"); nameInput.type = "text"; nameInput.id = "theme-name-input"; nameInput.placeholder = "Theme name"; nameInput.value = existingName || ""; nameGroup.appendChild(nameLabel); nameGroup.appendChild(nameInput); form.appendChild(nameGroup); var controlsRow = document.createElement("div"); controlsRow.className = "field-grid"; var gradientField = document.createElement("div"); gradientField.className = "field-group"; var gradientLabel = document.createElement("span"); gradientLabel.className = "field-label"; gradientLabel.textContent = "Use gradient background"; gradientField.appendChild(gradientLabel); var gradientToggle = document.createElement("label"); gradientToggle.className = "toggle-switch"; var gradientInput = document.createElement("input"); gradientInput.type = "checkbox"; gradientInput.checked = settings.gradientEnabled; var gradientSlider = document.createElement("span"); gradientSlider.className = "slider"; gradientSlider.appendChild(document.createElement("span")).className = "dot"; gradientToggle.appendChild(gradientInput); gradientToggle.appendChild(gradientSlider); gradientField.appendChild(gradientToggle); controlsRow.appendChild(gradientField); var scopeField = document.createElement("div"); scopeField.className = "field-group"; var scopeLabel = document.createElement("span"); scopeLabel.className = "field-label"; scopeLabel.textContent = "Apply theme to"; scopeField.appendChild(scopeLabel); var scopeControl = document.createElement("div"); scopeControl.className = "segmented-control"; var scopeFullInput = document.createElement("input"); scopeFullInput.type = "radio"; scopeFullInput.name = "builder-theme-scope"; scopeFullInput.value = "full"; scopeFullInput.id = "builder-scope-full"; var scopeFullLabel = document.createElement("label"); scopeFullLabel.htmlFor = scopeFullInput.id; scopeFullLabel.textContent = "Entire UI"; var scopeBgInput = document.createElement("input"); scopeBgInput.type = "radio"; scopeBgInput.name = "builder-theme-scope"; scopeBgInput.value = "background"; scopeBgInput.id = "builder-scope-background"; var scopeBgLabel = document.createElement("label"); scopeBgLabel.htmlFor = scopeBgInput.id; scopeBgLabel.textContent = "Background only"; scopeControl.appendChild(scopeFullInput); scopeControl.appendChild(scopeFullLabel); scopeControl.appendChild(scopeBgInput); scopeControl.appendChild(scopeBgLabel); scopeField.appendChild(scopeControl); controlsRow.appendChild(scopeField); form.appendChild(controlsRow); var preview = document.createElement("div"); preview.className = "theme-preview"; var previewShell = document.createElement("div"); previewShell.className = "preview-shell"; var previewTop = document.createElement("div"); previewTop.className = "preview-topbar"; previewTop.textContent = "Theme preview"; var previewBody = document.createElement("div"); previewBody.className = "preview-body"; var botBubble = document.createElement("div"); botBubble.className = "bubble bot"; botBubble.textContent = "Answer highlight"; var userBubble = document.createElement("div"); userBubble.className = "bubble user"; userBubble.textContent = "You copied the question"; previewBody.appendChild(botBubble); previewBody.appendChild(userBubble); previewShell.appendChild(previewTop); previewShell.appendChild(previewBody); preview.appendChild(previewShell); form.appendChild(preview); var fields = [ { key: "bg", label: "Background" }, { key: "surface", label: "Surface" }, { key: "elevated", label: "Elevated" }, { key: "text", label: "Text" }, { key: "subtext", label: "Subtext" }, { key: "border", label: "Border" }, { key: "accent", label: "Accent" }, { key: "accentHover", label: "Accent Hover" }, { key: "success", label: "Success" }, { key: "error", label: "Error" }, { key: "gradientFrom", label: "Gradient Start" }, { key: "gradientTo", label: "Gradient End" } ]; var grid = document.createElement("div"); grid.className = "modal-grid"; fields.forEach(function (field) { var wrapper = document.createElement("label"); wrapper.className = "modal-field"; var span = document.createElement("span"); span.textContent = field.label; wrapper.appendChild(span); var input = document.createElement("input"); input.type = "color"; var value = themeData[field.key]; if (!value) value = defaultSettings.themes.Midnight[field.key] || themeData.bg || "#000000"; input.value = value; input.dataset.key = field.key; wrapper.appendChild(input); grid.appendChild(wrapper); }); form.appendChild(grid); var actions = document.createElement("div"); actions.className = "modal-actions"; var submitBtn = document.createElement("button"); submitBtn.type = "submit"; submitBtn.className = "btn primary"; submitBtn.textContent = isEdit ? "Save Theme" : "Create Theme"; var cancelBtn = document.createElement("button"); cancelBtn.type = "button"; cancelBtn.className = "btn secondary"; cancelBtn.textContent = "Cancel"; actions.appendChild(submitBtn); actions.appendChild(cancelBtn); form.appendChild(actions); modal.content.appendChild(form); cancelBtn.addEventListener("click", modal.close); function getBuilderScope() { return scopeBgInput.checked ? "background" : "full"; } function updatePreview() { var gradientActive = gradientInput.checked; var scopeValue = getBuilderScope(); var gradientValue = "linear-gradient(135deg, " + themeData.gradientFrom + ", " + themeData.gradientTo + ")"; var surface = themeData.surface || themeData.bg || "#0a0a0a"; var elevated = themeData.elevated || surface; var panelOpacity = 1 - clampTransparency(settings.panelTransparency, defaultSettings.panelTransparency) / 100; var backgroundOpacity = 1 - clampTransparency( settings.backgroundTransparency, defaultSettings.backgroundTransparency ) / 100; var panelBackground = gradientActive ? "linear-gradient(135deg, " + convertHexToRgba(themeData.gradientFrom, panelOpacity) + ", " + convertHexToRgba(themeData.gradientTo, panelOpacity) + ")" : convertHexToRgba(surface, panelOpacity); previewShell.style.background = panelBackground; previewShell.style.borderColor = convertHexToRgba(themeData.border || surface, Math.min(1, panelOpacity + 0.35)); preview.setAttribute('data-scope', scopeValue); previewTop.style.background = scopeValue === "background" ? convertHexToRgba(themeData.bg || surface, Math.min(1, backgroundOpacity + 0.12)) : convertHexToRgba(elevated, Math.min(1, panelOpacity + 0.05)); previewTop.style.color = themeData.text || "#ffffff"; previewBody.style.background = scopeValue === "background" ? convertHexToRgba(themeData.bg || surface, Math.min(1, backgroundOpacity + 0.06)) : convertHexToRgba(themeData.surface || surface, Math.min(1, panelOpacity + 0.03)); previewBody.style.color = themeData.subtext || themeData.text || "#ffffff"; userBubble.style.background = themeData.accent || "#00d4ff"; userBubble.style.color = "#06121e"; botBubble.style.background = convertHexToRgba(themeData.text || "#ffffff", 0.12); botBubble.style.color = themeData.text || "#ffffff"; } gradientInput.addEventListener("change", updatePreview); scopeFullInput.addEventListener("change", updatePreview); scopeBgInput.addEventListener("change", updatePreview); var colorInputs = grid.querySelectorAll('input[type="color"]'); colorInputs.forEach(function (input) { input.addEventListener("input", function () { themeData[input.dataset.key] = input.value || "#000000"; updatePreview(); }); }); if (settings.themeScope === "background") { scopeBgInput.checked = true; } else { scopeFullInput.checked = true; } updatePreview(); form.addEventListener("submit", function (event) { event.preventDefault(); var name = nameInput.value.trim() || (isEdit ? existingName : ""); if (!name) { showToast(UI, "Enter a theme name.", "error"); return; } if (name !== existingName && settings.themes[name]) { showToast(UI, "Theme name already exists.", "error"); return; } var result = {}; colorInputs.forEach(function (input) { result[input.dataset.key] = input.value || "#000000"; }); settings.customThemes[name] = result; delete settings.removedThemes[name]; if (existingName && name !== existingName && settings.customThemes[existingName]) { delete settings.customThemes[existingName]; } if (existingName && isDefaultTheme(existingName)) { delete settings.removedThemes[existingName]; } settings.gradientEnabled = gradientInput.checked; settings.themeScope = getBuilderScope(); refreshComputedSettings(settings); settings.theme = name; renderThemeList(name); syncThemeScopeUI(settings.themeScope); if (UI.gradientToggle) UI.gradientToggle.checked = settings.gradientEnabled; applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); showToast(UI, isEdit ? "Theme updated!" : "Theme created!", "success"); modal.close(); }); } UI.floatingBtn.addEventListener("click", togglePanel); UI.closeBtn.addEventListener("click", function () { setPanelOpen(false); }); UI.quickCopyBtn.addEventListener("click", function () { copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { if (questionText) { setPanelOpen(true); ensureChatView({ focus: false }); UI.chatInput.value = ""; sendMessage(questionText, null); } }); }); UI.copyBtn.addEventListener("click", function () { copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { if (questionText) { if (!UI.panel.classList.contains("open")) setPanelOpen(true); ensureChatView(); UI.chatInput.value = ""; sendMessage(questionText, null); } }); }); UI.sendBtn.addEventListener("click", function () { sendMessage(); }); UI.attachBtn.addEventListener("click", function () { UI.fileInput.click(); }); UI.screenshotBtn.addEventListener("click", function () { showToast(UI, "Capturing screenshot...", "info"); Promise.all([ copyIXLContent(UI, settings, { manual: false }), captureQuestionScreenshot(UI, settings) ]) .then(function (results) { var questionText = results[0]; var screenshot = results[1]; if (!screenshot || !screenshot.base64) { showToast(UI, "Couldn't capture the question screenshot.", "error"); return; } var messageText = questionText; if (!messageText) { var prepend = settings.prependMessage || ""; var prompt = "Please analyze the attached screenshot and provide the correct answer."; messageText = prepend ? prepend + "\n\n" + prompt : prompt; } setPanelOpen(true); ensureChatView({ focus: false }); UI.chatInput.value = ""; sendMessage(messageText, { base64: screenshot.base64, mime: screenshot.mime || "image/png" }); showToast(UI, "Screenshot attached!", "success"); }) .catch(function (error) { console.error("Screenshot workflow failed", error); showToast(UI, "Screenshot capture failed.", "error"); }); }); UI.fileInput.addEventListener("change", function (e) { handleImageFile(e.target.files[0]); }); UI.chatInput.addEventListener("paste", function (e) { var file = e.clipboardData && e.clipboardData.files && e.clipboardData.files[0]; if (file) handleImageFile(file); }); UI.chatInput.addEventListener("keydown", function (e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); UI.settingsBtn.addEventListener("click", function () { var isSettings = UI.panel.classList.toggle("settings-mode"); UI.title.textContent = isSettings ? "Settings" : UI.site.title; UI.settingsBtn.innerHTML = isSettings ? ICONS.BACK : ICONS.SETTINGS; }); renderThemeList(settings.theme); UI.prependMessageInput.value = settings.prependMessage || ""; populatePrependSelect(findPresetNameByMessage(settings.prependMessage)); if (UI.gradientToggle) { UI.gradientToggle.checked = !!settings.gradientEnabled; UI.gradientToggle.addEventListener("change", function () { settings.gradientEnabled = UI.gradientToggle.checked; applyTheme(UI, settings); queueSave({ refresh: false }); }); } if (UI.autoHideButtonsToggle) { UI.autoHideButtonsToggle.checked = settings.autoHideSideButtons !== false; UI.autoHideButtonsToggle.addEventListener("change", function () { settings.autoHideSideButtons = UI.autoHideButtonsToggle.checked; updateSideButtonVisibility(); queueSave({ refresh: false }); }); } syncThemeScopeUI(settings.themeScope || "full"); (UI.themeScopeInputs || []).forEach(function (input) { if (!input) return; input.addEventListener("change", function () { if (!input.checked) return; settings.themeScope = input.value === "background" ? "background" : "full"; syncThemeScopeUI(settings.themeScope); applyTheme(UI, settings); queueSave({ refresh: false }); }); }); if (UI.themeList) { UI.themeList.addEventListener("click", function (event) { var target = event.target && event.target.closest && event.target.closest('[data-theme-action]'); if (!target) return; var action = target.getAttribute('data-theme-action'); var name = target.getAttribute('data-theme-name'); if (action === 'select') { if (!name || !settings.themes[name]) return; settings.theme = name; renderThemeList(name); applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); } else if (action === 'edit') { if (!name || !settings.themes[name]) { showToast(UI, 'Select a theme to edit.', 'error'); return; } openThemeEditor(name); } else if (action === 'delete') { if (!name || !settings.themes[name]) { showToast(UI, 'Select a theme to delete.', 'error'); return; } if (Object.keys(settings.themes).length <= 1) { showToast(UI, 'Keep at least one theme available.', 'error'); return; } if (settings.customThemes[name]) delete settings.customThemes[name]; if (isDefaultTheme(name)) settings.removedThemes[name] = true; else delete settings.removedThemes[name]; refreshComputedSettings(settings); if (!settings.themes[settings.theme]) { settings.theme = Object.keys(settings.themes)[0]; } renderThemeList(settings.theme); applyTheme(UI, settings); ensureGlobalHighlightStyles(settings); saveSettings(settings); showToast(UI, 'Theme deleted.', 'info'); } else if (action === 'create') { openThemeEditor(); } }); } if (UI.autoHighlightToggle) UI.autoHighlightToggle.checked = !!settings.autoHighlight; if (UI.autoSelectToggle) UI.autoSelectToggle.checked = !!settings.autoSelect; if (UI.autoSubmitToggle) UI.autoSubmitToggle.checked = !!settings.autoSubmit; if (UI.autoDetectToggle) UI.autoDetectToggle.checked = !!settings.autoDetect; if (UI.selectionDelayInput) UI.selectionDelayInput.value = settings.selectionDelay || 3; if (UI.submitDelayInput) UI.submitDelayInput.value = settings.submitDelay || 5; if (UI.fillInBlankToggle) UI.fillInBlankToggle.checked = !!settings.fillInBlank; if (UI.highlightColorInput) UI.highlightColorInput.value = settings.highlightColor || "#00aaff"; if (UI.highlightOpacityInput) UI.highlightOpacityInput.value = settings.highlightOpacity !== undefined ? settings.highlightOpacity : 0.15; if (UI.rainbowHighlightToggle) UI.rainbowHighlightToggle.checked = !!settings.rainbowHighlight; if (UI.autoCopyToggle) UI.autoCopyToggle.checked = settings.autoCopy === true; if (typeof UI.updateTransparencyDisplays === "function") { UI.updateTransparencyDisplays(); } function maybeAnnounceAutomation(previouslyEnabled) { if (!UI.site.features.automation) return; if (!previouslyEnabled && (settings.autoSelect || settings.autoHighlight || settings.autoSubmit)) { showToast(UI, "Automation settings enabled for this session!", "success"); } } if (UI.autoHighlightToggle) { UI.autoHighlightToggle.addEventListener("change", function () { var previous = settings.autoHighlight; settings.autoHighlight = UI.autoHighlightToggle.checked; queueSave({ refresh: false }); if (settings.autoHighlight && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoSelectToggle) { UI.autoSelectToggle.addEventListener("change", function () { var previous = settings.autoSelect; settings.autoSelect = UI.autoSelectToggle.checked; queueSave({ refresh: false }); if (settings.autoSelect && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoSubmitToggle) { UI.autoSubmitToggle.addEventListener("change", function () { var previous = settings.autoSubmit; settings.autoSubmit = UI.autoSubmitToggle.checked; queueSave({ refresh: false }); if (settings.autoSubmit && !previous) { maybeAnnounceAutomation(previous); } }); } if (UI.autoDetectToggle) { UI.autoDetectToggle.addEventListener("change", function () { settings.autoDetect = UI.autoDetectToggle.checked; queueSave({ refresh: false }); }); } if (UI.fillInBlankToggle) { UI.fillInBlankToggle.addEventListener("change", function () { settings.fillInBlank = UI.fillInBlankToggle.checked; queueSave({ refresh: false }); }); } if (UI.autoCopyToggle) { UI.autoCopyToggle.addEventListener("change", function () { settings.autoCopy = UI.autoCopyToggle.checked; queueSave({ refresh: false }); }); } if (UI.selectionDelayInput) { UI.selectionDelayInput.addEventListener("input", function () { var value = parseInt(UI.selectionDelayInput.value, 10); if (isNaN(value) || value < 0) value = defaultSettings.selectionDelay; value = Math.max(0, Math.min(10, value)); settings.selectionDelay = value; UI.selectionDelayInput.value = value; queueSave({ refresh: false }); }); } if (UI.submitDelayInput) { UI.submitDelayInput.addEventListener("input", function () { var value = parseInt(UI.submitDelayInput.value, 10); if (isNaN(value) || value < 0) value = defaultSettings.submitDelay; value = Math.max(0, Math.min(15, value)); settings.submitDelay = value; UI.submitDelayInput.value = value; queueSave({ refresh: false }); }); } if (UI.highlightColorInput) { UI.highlightColorInput.addEventListener("change", function () { settings.highlightColor = UI.highlightColorInput.value || defaultSettings.highlightColor; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.highlightOpacityInput) { UI.highlightOpacityInput.addEventListener("input", function () { var value = parseFloat(UI.highlightOpacityInput.value); if (isNaN(value)) value = defaultSettings.highlightOpacity; value = Math.max(0, Math.min(1, value)); settings.highlightOpacity = value; ensureGlobalHighlightStyles(settings); queueSave({ refresh: false }); }); } if (UI.rainbowHighlightToggle) { UI.rainbowHighlightToggle.addEventListener("change", function () { settings.rainbowHighlight = UI.rainbowHighlightToggle.checked; queueSave({ refresh: false }); }); } function bindTransparencyControl(input, key) { if (!input) return; input.addEventListener("input", function () { var nextValue = clampTransparency(input.value, defaultSettings[key]); settings[key] = nextValue; if (typeof UI.updateTransparencyDisplays === "function") UI.updateTransparencyDisplays(); applyTheme(UI, settings); queueSave({ refresh: false }); }); } bindTransparencyControl(UI.backgroundTransparencyInput, "backgroundTransparency"); bindTransparencyControl(UI.panelTransparencyInput, "panelTransparency"); bindTransparencyControl(UI.sideButtonTransparencyInput, "sideButtonTransparency"); UI.prependPresetSelect.addEventListener("change", function () { var selectedPreset = UI.prependPresetSelect.value; if (selectedPreset && settings.prependPresets[selectedPreset] !== undefined) { var presetValue = settings.prependPresets[selectedPreset]; UI.prependMessageInput.value = presetValue || ""; settings.prependMessage = presetValue || ""; if (selectedPreset === "Custom") UI.prependNameInput.value = ""; else UI.prependNameInput.value = selectedPreset; queueSave({ refresh: false }); } }); UI.prependMessageInput.addEventListener("input", function () { settings.prependMessage = UI.prependMessageInput.value; var matched = findPresetNameByMessage(settings.prependMessage); if (matched) { UI.prependPresetSelect.value = matched; UI.prependNameInput.value = matched === "Custom" ? "" : matched; } else if (settings.prependPresets.Custom !== undefined) { UI.prependPresetSelect.value = "Custom"; UI.prependNameInput.value = ""; } queueSave({ refresh: false, delay: 400 }); }); if (UI.prependSaveBtn) { UI.prependSaveBtn.addEventListener("click", function () { var name = UI.prependNameInput.value.trim(); if (!name) { showToast(UI, "Enter a profile name.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[name] = message; delete settings.removedPrepends[name]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(name); UI.prependPresetSelect.value = name; saveSettings(settings); showToast(UI, "Profile saved!", "success"); }); } if (UI.prependUpdateBtn) { UI.prependUpdateBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to update.", "error"); return; } var message = UI.prependMessageInput.value.trim(); if (!message) { showToast(UI, "Enter a message to save.", "error"); return; } settings.customPrepends[selected] = message; delete settings.removedPrepends[selected]; settings.prependMessage = message; refreshComputedSettings(settings); populatePrependSelect(selected); saveSettings(settings); showToast(UI, "Profile updated!", "success"); }); } if (UI.prependDeleteBtn) { UI.prependDeleteBtn.addEventListener("click", function () { var selected = UI.prependPresetSelect.value; if (!selected || settings.prependPresets[selected] === undefined) { showToast(UI, "Select a profile to delete.", "error"); return; } if (Object.keys(settings.prependPresets).length <= 1) { showToast(UI, "Keep at least one profile.", "error"); return; } if (isDefaultPreset(selected)) settings.removedPrepends[selected] = true; else delete settings.removedPrepends[selected]; delete settings.customPrepends[selected]; refreshComputedSettings(settings); var fallback = Object.keys(settings.prependPresets)[0]; settings.prependMessage = settings.prependPresets[fallback] || ""; UI.prependMessageInput.value = settings.prependMessage; populatePrependSelect(fallback); saveSettings(settings); showToast(UI, "Profile deleted.", "info"); }); } document.addEventListener("keydown", function (e) { if (e.target && e.target.closest && e.target.closest("input, textarea, select")) return; if (e.ctrlKey && e.key.toLowerCase() === settings.copyKey.toLowerCase()) { e.preventDefault(); copyIXLContent(UI, settings, { manual: true }).then(function (questionText) { if (questionText) { if (UI.panel.classList.contains("open")) { sendMessage(questionText, null); } else { sendMessage(questionText, null, true); } } }); } if (e.key.toLowerCase() === settings.toggleKey.toLowerCase()) { e.preventDefault(); var currentlyOpen = UI.panel.classList.contains("open"); setPanelOpen(!currentlyOpen); } }, true); } function makeDraggable(el, storageKey, settings, handleEl, followerEls) { followerEls = followerEls || []; var handle = handleEl || el; try { handle.style.cursor = "grab"; } catch (e) {} var startRect, startPos, followerStartRects; function onPointerDown(e) { if (e.target && e.target.closest && e.target.closest("button, input, select, a")) return; e.preventDefault(); startRect = el.getBoundingClientRect(); startPos = { x: (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX)), y: (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY)) }; followerStartRects = followerEls.map(function (f) { return f.getBoundingClientRect(); }); function onPointerMove(moveEvent) { var clientX = moveEvent.clientX || (moveEvent.touches && moveEvent.touches[0] && moveEvent.touches[0].clientX); var clientY = moveEvent.clientY || (moveEvent.touches && moveEvent.touches[0] && moveEvent.touches[0].clientY); var deltaX = clientX - startPos.x; var deltaY = clientY - startPos.y; var newX = startRect.left + deltaX; var newY = startRect.top + deltaY; el.style.left = newX + "px"; el.style.top = newY + "px"; followerEls.forEach(function (fel, index) { var followerStartRect = followerStartRects[index]; fel.style.left = (followerStartRect.left + deltaX) + "px"; fel.style.top = (followerStartRect.top + deltaY) + "px"; }); } function onPointerUp(upEvent) { document.removeEventListener("pointermove", onPointerMove); document.removeEventListener("pointerup", onPointerUp); document.removeEventListener("touchmove", onPointerMove); document.removeEventListener("touchend", onPointerUp); try { handle.style.cursor = "grab"; } catch (e) {} settings[storageKey] = { top: el.style.top, left: el.style.left }; saveSettings(settings); } document.addEventListener("pointermove", onPointerMove); document.addEventListener("pointerup", onPointerUp, { once: true }); document.addEventListener("touchmove", onPointerMove, { passive: false }); document.addEventListener("touchend", onPointerUp, { once: true }); try { handle.setPointerCapture && handle.setPointerCapture(e.pointerId); } catch (err) {} } handle.addEventListener("pointerdown", function (e) { onPointerDown(e); }); handle.addEventListener("touchstart", function (e) { onPointerDown(e); }, { passive: false }); } function getTextWithSpacing(node) { var text = ""; if (!node) return text; if (node.nodeType === Node.TEXT_NODE) return node.textContent || ""; if (node.nodeType !== Node.ELEMENT_NODE || window.getComputedStyle(node).display === "none") return ""; for (var i = 0; i < node.childNodes.length; i++) { text += getTextWithSpacing(node.childNodes[i]); } var display = window.getComputedStyle(node).display; if ( display === "block" || display === "list-item" || ["P", "BR", "H1", "H2", "H3", "DIV"].indexOf(node.tagName) !== -1 ) { if (!text.endsWith("\n")) text += "\n"; } else if (!text.endsWith(" ")) text += " "; return text; } function isElementVisible(element) { if (!element || !(element instanceof Element)) return false; if (element.closest('[aria-hidden="true"]')) return false; var style = window.getComputedStyle(element); if (style.display === "none" || style.visibility === "hidden") return false; if (parseFloat(style.opacity || "1") === 0) return false; var rect = element.getBoundingClientRect(); return rect.width > 0 && rect.height > 0; } function getVisibleElements(selector, root) { if (root === void 0) root = document; return Array.prototype.filter.call(root.querySelectorAll(selector), function (el) { return isElementVisible(el); }); } function locateQuestionScope() { var selectors = [ ".q-content", ".question-view", ".question-body", "section[data-question-id]", ".question-wrapper", ".question-container", ".practice-question", ".practice-area", ".practice-main", "main" ]; var best = null; var bestScore = 0; var seen = new Set(); selectors.forEach(function (selector) { var nodes = document.querySelectorAll(selector); nodes.forEach(function (candidate) { if (!candidate || seen.has(candidate)) return; seen.add(candidate); if (candidate === document.body || candidate === document.documentElement) return; var rect = candidate.getBoundingClientRect(); if (!rect || rect.width < 80 || rect.height < 60) return; var area = rect.width * rect.height; if (candidate.querySelector('.SelectableTile, [data-testid="SelectableTile"], .choices, .choice-container')) { area *= 1.4; } if (candidate.querySelector('.stimulus-container, .q-stimulus, .stem, .q-prompt')) { area *= 1.1; } if (area > bestScore) { bestScore = area; best = candidate; } }); }); if (best) return best; var fallback = document.querySelector("main"); return fallback || document.body; } function findQuestionCaptureTarget() { var scope = locateQuestionScope(); if (!scope) return document.body; var candidates = []; var current = scope; var depth = 0; while (current && current !== document.body && depth < 4) { candidates.push(current); current = current.parentElement; depth += 1; } var additionalSelectors = [ ".practice-question", ".practice-area", ".practice-main", ".question-view", ".question-body", ".question-wrapper", ".question-container" ]; additionalSelectors.forEach(function (selector) { var match = scope.querySelector(selector) || document.querySelector(selector); if (match) candidates.push(match); }); var seen = new Set(); var best = null; var bestScore = 0; candidates.forEach(function (candidate) { if (!candidate || seen.has(candidate) || typeof candidate.getBoundingClientRect !== "function") return; seen.add(candidate); var rect = candidate.getBoundingClientRect(); if (!rect || rect.width < 120 || rect.height < 80) return; var area = rect.width * rect.height; if (candidate.querySelector('.SelectableTile, [data-testid="SelectableTile"], .choices, .choice-container')) { area *= 1.4; } if (candidate.querySelector('.stimulus-container, .q-stimulus, .stem, .q-prompt')) { area *= 1.15; } if (area > bestScore) { bestScore = area; best = candidate; } }); return best || scope || document.body; } var TRANSPARENT_PIXEL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HwAFgwJ/lwO4WQAAAABJRU5ErkJggg=="; function resolveResourceUrl(url) { if (!url) return null; var trimmed = String(url).trim(); if (!trimmed) return null; if (/^data:/i.test(trimmed)) return trimmed; if (/^#/i.test(trimmed)) return null; if (/^javascript:/i.test(trimmed)) return null; if (/^blob:/i.test(trimmed)) return null; if (/^(?:chrome|moz|safari)-extension:/i.test(trimmed)) return null; if (/^about:/i.test(trimmed)) return null; if (/^file:/i.test(trimmed)) return null; try { var resolved = new URL(trimmed, document.baseURI || window.location.href); if (resolved.protocol === "data:") return trimmed; if (resolved.protocol !== "http:" && resolved.protocol !== "https:") return null; return resolved.href; } catch (error) { return trimmed; } } function fetchResourceAsDataUrl(url) { if (!url) return Promise.resolve(null); if (/^data:/i.test(url)) return Promise.resolve(url); if (/^blob:/i.test(url)) return Promise.resolve(null); if (!/^https?:/i.test(url)) return Promise.resolve(null); if (typeof fetch !== "function" || typeof FileReader !== "function") { return Promise.resolve(null); } return fetch(url, { mode: "cors", credentials: "omit" }) .then(function (response) { if (!response || !response.ok) throw new Error("Response not ok"); return response.blob(); }) .then(function (blob) { return new Promise(function (resolve, reject) { try { var reader = new FileReader(); reader.onloadend = function () { if (typeof reader.result === "string") resolve(reader.result); else resolve(null); }; reader.onerror = function () { resolve(null); }; reader.readAsDataURL(blob); } catch (error) { resolve(null); } }); }) .catch(function () { return null; }); } function sanitizeStyleAttribute(element) { if (!element || typeof element.getAttribute !== "function") return; var styleAttr = element.getAttribute("style"); if (!styleAttr || styleAttr.indexOf("url(") === -1) return; var sanitized = styleAttr.replace(/url\((['\"]?)(.*?)\1\)/gi, function (match, _quote, rawUrl) { var trimmed = (rawUrl || "").trim(); if (!trimmed) return "none"; if (/^#/i.test(trimmed)) return match; if (/^data:/i.test(trimmed)) return 'url("' + trimmed + '")'; var resolved = resolveResourceUrl(trimmed); if (resolved && /^data:/i.test(resolved)) return 'url("' + resolved + '")'; return 'url("' + TRANSPARENT_PIXEL + '")'; }); if (sanitized !== styleAttr) element.setAttribute("style", sanitized); } function sanitizeNodeForRendering(root) { if (!root) return; var elements = [root].concat(Array.from(root.querySelectorAll("*"))); elements.forEach(function (element) { if (!element) return; sanitizeStyleAttribute(element); if (element.style) { if (element.style.filter && element.style.filter.indexOf("url(") !== -1) { element.style.filter = "none"; } if (element.style.webkitFilter && element.style.webkitFilter.indexOf("url(") !== -1) { element.style.webkitFilter = "none"; } if (element.style.maskImage && element.style.maskImage.indexOf("url(") !== -1) { element.style.maskImage = "none"; } if (element.style.webkitMaskImage && element.style.webkitMaskImage.indexOf("url(") !== -1) { element.style.webkitMaskImage = "none"; } } var tagName = (element.tagName || "").toLowerCase(); if (tagName === "img") { var src = element.getAttribute("src"); if (src && !/^data:/i.test(src)) element.setAttribute("src", TRANSPARENT_PIXEL); element.removeAttribute("srcset"); } else if (tagName === "picture") { Array.from(element.querySelectorAll("source")).forEach(function (source) { source.removeAttribute("src"); source.removeAttribute("srcset"); }); } else if (tagName === "source") { element.removeAttribute("src"); element.removeAttribute("srcset"); } else if (tagName === "video" || tagName === "audio") { element.removeAttribute("poster"); element.removeAttribute("src"); if (typeof element.load === "function") { try { element.load(); } catch (error) {} } if (element.style) element.style.background = "transparent"; } else if (tagName === "iframe" || tagName === "embed" || tagName === "object") { if (element.style) element.style.display = "none"; } else if (tagName === "canvas") { try { var ctx = element.getContext && element.getContext("2d"); if (ctx) { var w = element.width || element.clientWidth || 0; var h = element.height || element.clientHeight || 0; if (w && h) { ctx.save(); ctx.globalCompositeOperation = "source-over"; ctx.fillStyle = "#ffffff"; ctx.clearRect(0, 0, w, h); ctx.fillRect(0, 0, w, h); ctx.restore(); } } } catch (error) {} } }); } function inlineImageElement(img) { if (!img) return Promise.resolve(); var src = img.getAttribute("src") || ""; if (!src) { img.removeAttribute("srcset"); return Promise.resolve(); } var resolved = resolveResourceUrl(src); if (!resolved) { img.setAttribute("src", TRANSPARENT_PIXEL); img.removeAttribute("srcset"); return Promise.resolve(); } if (/^data:/i.test(resolved)) { img.setAttribute("src", resolved); img.removeAttribute("srcset"); return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (dataUrl) { img.setAttribute("src", dataUrl); } else { img.setAttribute("src", TRANSPARENT_PIXEL); } img.removeAttribute("srcset"); }); } function inlineSvgImageElement(imageEl) { if (!imageEl) return Promise.resolve(); var href = imageEl.getAttribute("href") || imageEl.getAttribute("xlink:href") || (imageEl.href && imageEl.href.baseVal); if (!href) return Promise.resolve(); var resolved = resolveResourceUrl(href); if (!resolved) { imageEl.setAttribute("href", TRANSPARENT_PIXEL); imageEl.setAttribute("xlink:href", TRANSPARENT_PIXEL); return Promise.resolve(); } if (/^data:/i.test(resolved)) { imageEl.setAttribute("href", resolved); imageEl.setAttribute("xlink:href", resolved); return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (!dataUrl) dataUrl = TRANSPARENT_PIXEL; imageEl.setAttribute("href", dataUrl); imageEl.setAttribute("xlink:href", dataUrl); }); } function extractBackgroundUrls(value) { var matches = []; if (!value) return matches; value.replace(/url\((['\"]?)(.*?)\1\)/g, function (match, _quote, url) { if (url) matches.push({ match: match, url: url }); return match; }); return matches; } function inlineBackgroundImages(element) { if (!element || !element.style) return Promise.resolve(); var backgroundImage = element.style.backgroundImage; var background = element.style.background; var targets = extractBackgroundUrls(backgroundImage); if (background && background.indexOf("url(") !== -1) { extractBackgroundUrls(background).forEach(function (entry) { targets.push(entry); }); } if (!targets.length) return Promise.resolve(); var unique = []; var seen = new Set(); targets.forEach(function (entry) { if (entry && entry.url && !seen.has(entry.match + "@" + entry.url)) { seen.add(entry.match + "@" + entry.url); unique.push(entry); } }); return Promise.all( unique.map(function (entry) { var resolved = resolveResourceUrl(entry.url); if (!resolved) { entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; return Promise.resolve(); } if (/^data:/i.test(resolved)) { entry.replacement = 'url("' + resolved + '")'; return Promise.resolve(); } if (/^blob:/i.test(resolved)) { entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; return Promise.resolve(); } return fetchResourceAsDataUrl(resolved).then(function (dataUrl) { if (!dataUrl) dataUrl = TRANSPARENT_PIXEL; entry.replacement = 'url("' + dataUrl + '")'; }); }) ).then(function () { var updatedBackgroundImage = backgroundImage; var updatedBackground = background; unique.forEach(function (entry) { if (!entry.replacement) entry.replacement = 'url("' + TRANSPARENT_PIXEL + '")'; if (updatedBackgroundImage && updatedBackgroundImage.indexOf(entry.match) !== -1) { updatedBackgroundImage = updatedBackgroundImage.replace(entry.match, entry.replacement); } if (updatedBackground && updatedBackground.indexOf(entry.match) !== -1) { updatedBackground = updatedBackground.replace(entry.match, entry.replacement); } }); if (updatedBackgroundImage !== undefined) { element.style.backgroundImage = updatedBackgroundImage; } if (updatedBackground !== undefined) { element.style.background = updatedBackground; } }); } function inlineNodeResources(root) { if (!root) return Promise.resolve(root); var elements = [root].concat(Array.from(root.querySelectorAll("*"))); var tasks = []; elements.forEach(function (element) { if (!element) return; var tagName = (element.tagName || "").toLowerCase(); if (tagName === "img") { tasks.push(inlineImageElement(element)); } else if (tagName === "image") { tasks.push(inlineSvgImageElement(element)); } if (element.style && element.style.background) { tasks.push(inlineBackgroundImages(element)); } else if (element.style && element.style.backgroundImage) { tasks.push(inlineBackgroundImages(element)); } }); return Promise.all( tasks.map(function (task) { return task.catch ? task.catch(function () {}) : Promise.resolve(); }) ).then(function () { return root; }); } function cloneNodeWithInlineStyles(source) { if (!source) return null; var clone = source.cloneNode(true); function applyInlineStyles(original, copied) { if (!original || !copied) return; if (original.nodeType === Node.ELEMENT_NODE && copied.nodeType === Node.ELEMENT_NODE) { var computed = window.getComputedStyle(original); if (computed && copied.style) { if (computed.cssText) copied.style.cssText = computed.cssText; else { Array.from(computed).forEach(function (prop) { copied.style.setProperty(prop, computed.getPropertyValue(prop), computed.getPropertyPriority(prop)); }); } } if (original instanceof HTMLInputElement && copied instanceof HTMLInputElement) { copied.value = original.value; if (original.type === "checkbox" || original.type === "radio") { if (original.checked) copied.setAttribute("checked", "checked"); else copied.removeAttribute("checked"); } } else if (original instanceof HTMLTextAreaElement && copied instanceof HTMLTextAreaElement) { copied.value = original.value; copied.textContent = original.value; } else if (original instanceof HTMLSelectElement && copied instanceof HTMLSelectElement) { copied.value = original.value; Array.from(copied.options).forEach(function (option, index) { if (option.value === original.value) option.setAttribute("selected", "selected"); else option.removeAttribute("selected"); if (original.options[index] && original.options[index].selected) option.setAttribute("selected", "selected"); }); } } var childNodes = original.childNodes || []; Array.prototype.forEach.call(childNodes, function (child, index) { applyInlineStyles(child, copied.childNodes[index]); }); } applyInlineStyles(source, clone); return clone; } function renderNodeToCanvas(node, width, height, scale) { return new Promise(function (resolve) { try { var svgNS = "http://www.w3.org/2000/svg"; var svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("xmlns", svgNS); svg.setAttribute("width", width); svg.setAttribute("height", height); svg.setAttribute("viewBox", "0 0 " + width + " " + height); var foreignObject = document.createElementNS(svgNS, "foreignObject"); foreignObject.setAttribute("width", "100%"); foreignObject.setAttribute("height", "100%"); var wrapper = document.createElement("div"); wrapper.setAttribute("xmlns", "http://www.w3.org/1999/xhtml"); wrapper.style.width = width + "px"; wrapper.style.height = height + "px"; wrapper.style.margin = "0"; wrapper.style.padding = "0"; wrapper.appendChild(node); foreignObject.appendChild(wrapper); svg.appendChild(foreignObject); var serializer = new XMLSerializer(); var svgString = serializer.serializeToString(svg); var blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" }); var url = URL.createObjectURL(blob); var image = new Image(); image.crossOrigin = "anonymous"; image.onload = function () { try { var canvas = document.createElement("canvas"); canvas.width = Math.max(1, Math.round(width * scale)); canvas.height = Math.max(1, Math.round(height * scale)); var context = canvas.getContext("2d"); if (context) { var background = window.getComputedStyle(document.body).backgroundColor || "#ffffff"; context.fillStyle = background; context.fillRect(0, 0, canvas.width, canvas.height); context.scale(scale, scale); context.drawImage(image, 0, 0); var dataUrl = canvas.toDataURL("image/png", 0.92); var parts = dataUrl.split(","); if (parts.length >= 2) { resolve({ base64: parts[1], mime: "image/png", dataUrl: dataUrl }); } else { resolve(null); } } else { resolve(null); } } catch (err) { console.error("Screenshot render failed", err); resolve(null); } finally { URL.revokeObjectURL(url); } }; image.onerror = function (error) { console.error("Screenshot render failed", error); URL.revokeObjectURL(url); resolve(null); }; image.src = url; } catch (error) { console.error("Screenshot render failed", error); resolve(null); } }); } function captureQuestionScreenshot(UI, settings) { try { var target = findQuestionCaptureTarget(); if (!target) return Promise.resolve(null); var rect = target.getBoundingClientRect(); var width = Math.max(1, Math.round(rect.width)); var height = Math.max(1, Math.round(rect.height)); if (width < 32 || height < 32) return Promise.resolve(null); var restoreHost = null; if ((target === document.body || target === document.documentElement) && UI && UI.host) { var previousVisibility = UI.host.style.visibility; UI.host.style.visibility = "hidden"; restoreHost = function () { UI.host.style.visibility = previousVisibility; }; } var clone = cloneNodeWithInlineStyles(target); if (!clone) { if (restoreHost) restoreHost(); return Promise.resolve(null); } clone.style.width = width + "px"; clone.style.height = height + "px"; var scale = Math.min(2, Math.max(1, window.devicePixelRatio || 1)); return inlineNodeResources(clone) .then(function (preparedClone) { var sanitizedClone = preparedClone || clone; sanitizeNodeForRendering(sanitizedClone); return renderNodeToCanvas(sanitizedClone, width, height, scale); }) .catch(function (error) { console.error("Screenshot capture failed", error); return null; }) .then(function (result) { if (restoreHost) restoreHost(); return result; }); } catch (error) { console.error("Screenshot capture failed", error); return Promise.resolve(null); } } function copyIXLContent(UI, settings, options) { options = options || {}; var manual = options.manual || false; if (manual) showToast(UI, "Scanning question...", "info"); var scope = locateQuestionScope(); if (!scope) { if (manual) showToast(UI, "Could not find question area.", "error"); return Promise.resolve(null); } function cleanText(node) { return node ? getTextWithSpacing(node).replace(/\n\s*\n/g, "\n").replace(/ +/g, " ").trim() : ""; } var clonedScope = scope.cloneNode(true); clonedScope.querySelectorAll('script, style, svg, button, .prompt-section-title, .solution-res, .hint-res, [aria-hidden="true"]').forEach(function (el) { el.remove(); }); var stimulus = clonedScope.querySelector(".stimulus-container, .q-stimulus, .stem, .q-prompt"); var questionText = cleanText(stimulus); var optionsText = ""; var optionsNodes = getVisibleElements('.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"], .choices a[data-nonce], .choices a, .choices li, .choice-container .choice-cell, .answer-option, .option, .option-answer, .multiple-answer-answers .option-answer', scope); if (optionsNodes.length > 0) optionsText = "\n**Options:**\n" + optionsNodes.map(function (opt, i) { return String.fromCharCode(65 + i) + ". " + cleanText(opt); }).join("\n"); if (!questionText.trim()) { questionText = cleanText(clonedScope); optionsText = ""; } if (!questionText.trim()) { if (manual) showToast(UI, "No text found to copy.", "error"); return Promise.resolve(null); } var fullFormattedText = "**Question:**\n" + questionText + optionsText; var finalOutput = (settings.prependMessage || "") + "\n\n" + fullFormattedText; if (settings.autoCopy && navigator.clipboard && navigator.clipboard.writeText) { return navigator.clipboard.writeText(finalOutput).then(function () { if (manual) showToast(UI, "Question copied & sent to AI!", "success"); return finalOutput; }).catch(function () { if (manual) showToast(UI, "Copied to internal buffer (clipboard failed).", "info"); return finalOutput; }); } return Promise.resolve(finalOutput); } function getAnswerChoice(responseText) { if (!responseText) return null; var text = String(responseText).trim(); var lines = text.split('\n').map(function(line) { return line.trim(); }).filter(Boolean); var sentences = text.split(/[.!?]+/).map(function(sentence) { return sentence.trim(); }).filter(Boolean); if (lines.length > 1 || sentences.length > 1) { var selectableTiles = getVisibleElements('.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"], input[type="radio"], input[type="checkbox"], .radio-button, .checkbox-button, .choiceCell input[type="radio"], .multipleChoiceTable input[type="radio"], .SelectableTile[role="checkbox"], .multiple-answer-answers input[type="checkbox"], .multiple-answer-answers input[type="radio"], .multiple-answer-answers .option-answer, .option-answer, a[data-nonce], .choices a[data-nonce], .choices a'); var matches = []; var usedTiles = new Set(); for (var i = 0; i < lines.length; i++) { var line = lines[i].toLowerCase(); for (var j = 0; j < selectableTiles.length; j++) { if (usedTiles.has(j)) continue; var tile = selectableTiles[j]; var tileText = getElementTextContent(tile).toLowerCase(); if (tileText && calculateSimilarity(line, tileText) > 0.4) { matches.push({ el: tile, letter: null }); usedTiles.add(j); break; } } } if (matches.length > 0) { return matches; } } var patterns = [/(?:^|\b)(?:option|choice|answer|correct(?:\s+option)?)\s*[:\-]?\s*([A-J])\b/i, /\b([A-J])[\)\.\:]/i, /^([A-J])\s*[\-\.]/i]; for (var i = 0; i < patterns.length; i++) { var match = text.match(patterns[i]); if (match && match[1]) { var answerLetter = match[1].toUpperCase(); var answerIndex = answerLetter.charCodeAt(0) - 65; var selectors = [ '.multiple-answer-answers input[type="radio"]', '.multiple-answer-answers input[type="checkbox"]', 'input[type="radio"]', 'input[type="checkbox"]', '.SelectableTile[role="radio"]', '.SelectableTile', '[data-testid="SelectableTile"]', '.choices li', '.choice-container .choice-cell', '[data-testid*="choice"]', '.answer-option', '.option', 'button[role="radio"]', 'label[for*="answerCheckbox"]', 'label[for*="choice"]', '.multiple-answer-answers .option-answer', 'a[data-nonce]', '.choices a[data-nonce]', '.choices a' ]; for (var j = 0; j < selectors.length; j++) { var options = getVisibleElements(selectors[j]); if (options.length > answerIndex) return { el: options[answerIndex], letter: answerLetter }; } } } var selectableTiles = getVisibleElements('.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"], input[type="radio"], input[type="checkbox"], .radio-button, .checkbox-button, .choiceCell input[type="radio"], .multipleChoiceTable input[type="radio"], .SelectableTile[role="checkbox"], .multiple-answer-answers input[type="checkbox"], .multiple-answer-answers input[type="radio"], .multiple-answer-answers .option-answer, .option-answer, a[data-nonce], .choices a[data-nonce], .choices a'); for (var k = 0; k < selectableTiles.length; k++) { var tile = selectableTiles[k]; var tileText = getElementTextContent(tile).toLowerCase(); if (tileText && text.toLowerCase().includes(tileText)) return { el: tile, letter: null }; } return null; } function calculateSimilarity(str1, str2) { var longer = str1.length > str2.length ? str1 : str2; var shorter = str1.length > str2.length ? str2 : str1; if (longer.length === 0) return 1.0; var distance = levenshteinDistance(longer, shorter); return (longer.length - distance) / longer.length; } function getAssociatedLabelElement(element) { if (!element || !(element instanceof Element)) return null; if (element.tagName === 'LABEL') return element; var closestLabel = element.closest('label'); if (closestLabel) return closestLabel; var elementId = element.getAttribute('id'); if (elementId) { var safeId = elementId.replace(/"/g, '\\"'); var directLabel = document.querySelector('label[for="' + safeId + '"]'); if (directLabel) return directLabel; } var labelledBy = element.getAttribute && element.getAttribute('aria-labelledby'); if (labelledBy) { var firstId = labelledBy.split(/\s+/)[0]; if (firstId) { var labelledElement = document.getElementById(firstId); if (labelledElement instanceof Element) return labelledElement; } } return null; } function getOptionTextSource(element) { if (!element) return null; var label = getAssociatedLabelElement(element); if (label) return label; if (element.matches && element.matches('.choices a, .choices li, .choices .choice')) { var anchor = element.closest('.choices a, .choices li, .choices .choice'); if (anchor) return anchor; } if (element.closest) { var wrapper = element.closest('.option-answer, .answer-option, .multiple-answer-option, .choiceCell, td, li, .choices a, .choices li, .choices .choice'); if (wrapper) return wrapper; } return element; } function getElementTextContent(element) { var source = getOptionTextSource(element); if (!source) return ''; var text = getTextWithSpacing(source).replace(/\s+/g, ' ').trim(); return text; } function resolveHighlightTarget(element) { if (!element || !(element instanceof Element)) return element; var label = getAssociatedLabelElement(element); if (label) { var labelWrapper = label.closest('.option-answer, .answer-option, .multiple-answer-option'); return labelWrapper || label; } if (element.matches && element.matches('.choices a, .choices li, .choices .choice')) { var anchor = element.closest('.choices a, .choices li, .choices .choice'); if (anchor) return anchor; } if (element.closest) { var wrapper = element.closest('.option-answer, .answer-option, .multiple-answer-option, .choiceCell, td, li, .choices a, .choices li, .choices .choice'); if (wrapper) return wrapper; } return element; } function levenshteinDistance(str1, str2) { var matrix = []; for (var i = 0; i <= str2.length; i++) { matrix[i] = [i]; } for (var j = 0; j <= str1.length; j++) { matrix[0][j] = j; } for (var i = 1; i <= str2.length; i++) { for (var j = 1; j <= str1.length; j++) { if (str2.charAt(i - 1) === str1.charAt(j - 1)) { matrix[i][j] = matrix[i - 1][j - 1]; } else { matrix[i][j] = Math.min( matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1 ); } } } return matrix[str2.length][str1.length]; } function fillInTheBlank(UI, responseText, settings) { if (!settings.fillInBlank) return false; var fillInputs = document.querySelectorAll('input.fillIn, .old-fi-holder input[type="text"]'); if (fillInputs.length === 0) return false; var patterns = [ /\b([A-J])\b/i, /(\d+(?:\.\d+)?)\s*(?:°|degrees?)?/i, /-?\d+(?:\.\d+)?/g, /"([^"]+)"/, /'([^']+)'/, /^([a-zA-Z\s]+)$/ ]; var values = []; for (var i = 0; i < patterns.length; i++) { var matches = responseText.match(patterns[i]); if (matches) { if (patterns[i].global) { values = values.concat(matches); } else { values.push(matches[1] || matches[0]); } break; } } if (values.length === 0) return false; var filledCount = 0; fillInputs.forEach(function (input, index) { if (index < values.length) { var value = values[index]; input.value = ""; input.focus(); input.value = value; ["input", "change", "blur"].forEach(function (evt) { input.dispatchEvent(new Event(evt, { bubbles: true })); }); filledCount++; } }); if (filledCount > 0) { showToast(UI, "Filled " + filledCount + " blanks!", "success"); return true; } return false; } function highlightAnswer(UI, responseText, settings) { var choice = getAnswerChoice(responseText); if (!choice) return false; document.querySelectorAll(".ixl-highlighted-answer, .ixl-rainbow-highlight").forEach(function (el) { el.classList.remove("ixl-highlighted-answer", "ixl-rainbow-highlight"); el.style.removeProperty('outline'); el.style.removeProperty('outline-offset'); el.style.removeProperty('border-radius'); el.style.removeProperty('background-color'); el.style.removeProperty('box-shadow'); el.style.removeProperty('border'); el.style.removeProperty('transform'); el.style.removeProperty('filter'); el.style.removeProperty('position'); el.style.removeProperty('z-index'); el.style.removeProperty('pointer-events'); el.style.removeProperty('animation'); el.style.removeProperty('display'); el.style.removeProperty('width'); if (el._rainbowInterval) { clearInterval(el._rainbowInterval); el._rainbowInterval = null; } }); var choices = Array.isArray(choice) ? choice : [choice]; var currentTheme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var accentColor = settings.highlightColor || currentTheme.accent; var highlightLevel = parseFloat(settings.highlightOpacity); if (isNaN(highlightLevel)) highlightLevel = defaultSettings.highlightOpacity; highlightLevel = Math.max(0, Math.min(1, highlightLevel)); choices.forEach(function(choiceItem) { if (!choiceItem || !choiceItem.el) return; var baseElement = choiceItem.el; var targetElement = resolveHighlightTarget(baseElement); if (!targetElement || !(targetElement instanceof Element)) { targetElement = baseElement; } if (targetElement.tagName === 'A') { targetElement.style.setProperty('display', 'block', 'important'); targetElement.style.setProperty('width', '100%', 'important'); } targetElement.classList.add("ixl-highlighted-answer"); if (settings.rainbowHighlight) { targetElement.classList.add("ixl-rainbow-highlight"); startRainbowHighlight(targetElement); } else { var backgroundColor = convertHexToRgba(accentColor, highlightLevel); var glowColor = convertHexToRgba(accentColor, Math.min(0.5, highlightLevel + 0.2)); var outerGlow = convertHexToRgba(accentColor, Math.min(0.65, highlightLevel + 0.35)); var innerGlow = convertHexToRgba(accentColor, Math.min(0.45, highlightLevel + 0.25)); targetElement.style.setProperty('outline', accentColor + ' solid 4px', 'important'); targetElement.style.setProperty('outline-offset', '4px', 'important'); targetElement.style.setProperty('border-radius', '12px', 'important'); targetElement.style.setProperty('position', 'relative', 'important'); targetElement.style.setProperty('z-index', '1000', 'important'); targetElement.style.setProperty('pointer-events', 'auto', 'important'); targetElement.style.setProperty('background-color', backgroundColor, 'important'); targetElement.style.setProperty('box-shadow', outerGlow + ' 0px 0px 18px, inset ' + innerGlow + ' 0px 0px 12px', 'important'); targetElement.style.setProperty('border', '2px solid ' + accentColor, 'important'); targetElement.style.setProperty('transform', 'scale(1.02)', 'important'); targetElement.style.setProperty('filter', 'drop-shadow(0 0 8px ' + glowColor + ')', 'important'); } }); return true; } function startRainbowHighlight(element) { if (element._rainbowInterval) return; var hue = 0; element._rainbowInterval = setInterval(function() { hue = (hue + 2) % 360; var color = 'hsl(' + hue + ', 70%, 50%)'; var backgroundColor = 'hsla(' + hue + ', 70%, 50%, 0.2)'; var glowColor = 'hsla(' + hue + ', 70%, 50%, 0.3)'; element.style.setProperty('outline', color + ' solid 4px', 'important'); element.style.setProperty('background-color', backgroundColor, 'important'); element.style.setProperty('box-shadow', color + ' 0px 0px 15px, inset ' + color + ' 0px 0px 15px', 'important'); element.style.setProperty('border', '2px solid ' + color, 'important'); element.style.setProperty('filter', 'drop-shadow(0 0 8px ' + glowColor + ')', 'important'); }, 50); } function selectAnswer(UI, responseText) { var choice = getAnswerChoice(responseText); if (!choice) return false; var choices = Array.isArray(choice) ? choice : [choice]; var success = false; choices.forEach(function(choiceItem) { if (!choiceItem || !choiceItem.el) return; var element = choiceItem.el; try { element.click(); success = true; } catch (e) { try { element.dispatchEvent(new MouseEvent('click', { bubbles: true })); success = true; } catch (e2) { var xpath = getXPath(element); if (xpath) { try { var result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null); if (result.singleNodeValue) { result.singleNodeValue.click(); success = true; } } catch (e3) {} } } } if (success) { setTimeout(function() { try { element.click(); } catch (e) {} }, 100); } }); return success; } function getXPath(element) { if (element.id) { return '//*[@id="' + element.id + '"]'; } if (element === document.body) { return '/html/body'; } var ix = 0; var siblings = element.parentNode.childNodes; for (var i = 0; i < siblings.length; i++) { var sibling = siblings[i]; if (sibling === element) { return getXPath(element.parentNode) + '/' + element.tagName.toLowerCase() + '[' + (ix + 1) + ']'; } if (sibling.nodeType === 1 && sibling.tagName === element.tagName) { ix++; } } } function submitAnswer(UI) { var submitButton = document.querySelector('button.crisp-button'); if (!submitButton) { var allButtons = document.querySelectorAll("button"); submitButton = Array.from(allButtons).find(function (btn) { return btn.textContent && btn.textContent.trim().toLowerCase() === "submit"; }); } if (submitButton) { try { submitButton.click(); } catch (e) { try { var xpath = "/html/body/main/div/article/section[2]/section/div/div[1]/section/div/section/div/button"; var result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null); if (result.singleNodeValue) { result.singleNodeValue.click(); } } catch (e2) { showToast(UI, "Could not submit answer.", "error"); } } } else { showToast(UI, "Could not find submit button.", "error"); } } function initQuestionObserver(UI, settings, sendMessage, site) { var debounceTimer; var lastQuestionFingerprint = null; function processNewQuestion() { if (!settings.autoDetect || !site.features.autoDetect) return; copyIXLContent(UI, settings, { manual: false }).then(function (questionText) { if (questionText) sendMessage(questionText, null, true); }); } var observer = new MutationObserver(function () { if (!settings.autoDetect || !site.features.autoDetect) return; var tiles = document.querySelectorAll('.SelectableTile[role="radio"], .SelectableTile, [data-testid="SelectableTile"]'); if (tiles.length > 0) { var currentFingerprint = Array.from(tiles).map(function (t) { return t.textContent; }).join("").slice(0, 200); if (currentFingerprint && currentFingerprint !== lastQuestionFingerprint) { lastQuestionFingerprint = currentFingerprint; clearTimeout(debounceTimer); debounceTimer = setTimeout(processNewQuestion, 1500); } } }); var targetNode = document.querySelector("main") || document.body; observer.observe(targetNode, { childList: true, subtree: true }); } function ensureGlobalHighlightStyles(settings) { var id = "ixl-helper-global-style"; var style = document.getElementById(id); if (!style) { style = document.createElement("style"); style.id = id; document.head.appendChild(style); } var currentTheme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var accentColor = settings.highlightColor || currentTheme.accent; var highlightLevel = parseFloat(settings.highlightOpacity); if (isNaN(highlightLevel)) highlightLevel = defaultSettings.highlightOpacity; highlightLevel = Math.max(0, Math.min(1, highlightLevel)); var backgroundColor = convertHexToRgba(accentColor, highlightLevel); var haloColor = convertHexToRgba(accentColor, Math.min(0.6, highlightLevel + 0.25)); var pulseColor = convertHexToRgba(accentColor, Math.min(0.75, highlightLevel + 0.35)); style.textContent = "@keyframes ixl-pulse{0%{box-shadow:0 0 0 0 " + pulseColor + "}70%{box-shadow:0 0 0 12px transparent}100%{box-shadow:0 0 0 0 transparent}}.ixl-highlighted-answer{outline:3px solid " + accentColor + " !important;outline-offset:4px !important;border-radius:12px !important;animation:ixl-pulse 1.5s infinite !important;background-color:" + backgroundColor + " !important;box-shadow:0 0 0 4px " + haloColor + " !important}.ixl-highlighted-answer a{text-decoration:none!important;color:inherit!important;display:block!important;width:100%!important}a.ixl-highlighted-answer{display:block!important;width:100%!important}"; } function appendMessage(UI, role, text, imageUrl) { var messageEl = document.createElement("div"); messageEl.className = "chat-message " + role; if (imageUrl) { var img = document.createElement("img"); img.src = imageUrl; img.alt = "Attached image"; img.loading = "lazy"; messageEl.appendChild(img); } if (text) { var p = document.createElement("p"); p.textContent = text; messageEl.appendChild(p); } UI.messages.appendChild(messageEl); scrollMessagesToBottom(UI); return messageEl; } function scrollMessagesToBottom(UI){ try { var el = UI.messages; el.scrollTop = el.scrollHeight; requestAnimationFrame(function(){ el.scrollTop = el.scrollHeight; if (el.lastElementChild && el.lastElementChild.scrollIntoView) { el.lastElementChild.scrollIntoView({ block: 'end' }); } }); setTimeout(function(){ el.scrollTop = el.scrollHeight; }, 50); } catch(e) {} } function applyTheme(UI, settings) { refreshComputedSettings(settings); var theme = settings.themes[settings.theme] || defaultSettings.themes.Midnight; var hostStyle = UI.host.style; if (theme) { for (var key in theme) { if (Object.prototype.hasOwnProperty.call(theme, key) && theme[key] !== undefined) { try { hostStyle.setProperty("--" + key, theme[key]); } catch (e) {} } } } var gradientFrom = theme.gradientFrom || theme.bg || "#0a0a0a"; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg || gradientFrom; var surfaces = computePanelSurfaces(theme, settings); settings.backgroundTransparency = surfaces.values.backgroundTransparency; settings.panelTransparency = surfaces.values.panelTransparency; hostStyle.setProperty("--gradient-from", gradientFrom); hostStyle.setProperty("--gradient-to", gradientTo); hostStyle.setProperty("--panel-bg", surfaces.panelBg); hostStyle.setProperty("--panel-header-bg", surfaces.headerBg); hostStyle.setProperty("--panel-footer-bg", surfaces.footerBg); hostStyle.setProperty("--panel-border", surfaces.border); hostStyle.setProperty("--solid-background", surfaces.solidBackground); hostStyle.setProperty("--gradient-background", surfaces.gradientBackground); var panelOpacity = surfaces.values.panelOpacity; var accentColor = theme.accent || "#00d4ff"; var accentHover = theme.accentHover || accentColor; var accentContrast = getContrastColor(accentColor); var accentSoft = convertHexToRgba(accentColor, 0.25); var accentSoftBorder = convertHexToRgba(accentColor, 0.55); var sideTransparency = clampTransparency(settings.sideButtonTransparency, defaultSettings.sideButtonTransparency); var sideOpacity = 1 - sideTransparency / 100; var safeSideOpacity = Math.max(0.2, Math.min(1, sideOpacity)); var floatingBg = convertHexToRgba(accentColor, safeSideOpacity); var floatingHoverBg = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.1)); var floatingBorder = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.3)); var quickBase = theme.surface || theme.bg || gradientFrom; var quickBg = convertHexToRgba(quickBase, safeSideOpacity); var quickHoverBg = convertHexToRgba(theme.elevated || quickBase, Math.min(1, safeSideOpacity + 0.15)); var quickBorder = convertHexToRgba(theme.border || quickBase, Math.min(1, safeSideOpacity + 0.35)); var sideShadow = "0 14px 24px rgba(0, 0, 0, " + (0.35 * safeSideOpacity).toFixed(3) + ")"; var sideShadowHover = "0 18px 28px rgba(0, 0, 0, " + (0.45 * safeSideOpacity).toFixed(3) + ")"; var sideBackdrop = "blur(" + (4 + safeSideOpacity * 6).toFixed(1) + "px) saturate(120%)"; hostStyle.setProperty("--accent-soft", accentSoft); hostStyle.setProperty("--accent-soft-border", accentSoftBorder); hostStyle.setProperty("--accent-contrast", accentContrast); hostStyle.setProperty("--floating-btn-bg", floatingBg); hostStyle.setProperty("--floating-btn-hover-bg", floatingHoverBg); hostStyle.setProperty("--floating-btn-border", floatingBorder); hostStyle.setProperty("--floating-btn-color", accentContrast); hostStyle.setProperty("--quick-copy-btn-bg", quickBg); hostStyle.setProperty("--quick-copy-btn-hover-bg", quickHoverBg); hostStyle.setProperty("--quick-copy-btn-border", quickBorder); hostStyle.setProperty("--quick-copy-btn-color", theme.text || "#ffffff"); hostStyle.setProperty("--side-button-shadow", sideShadow); hostStyle.setProperty("--side-button-shadow-hover", sideShadowHover); hostStyle.setProperty("--side-button-backdrop", sideBackdrop); var baseSurface = theme.surface || theme.bg || gradientFrom; var baseElevated = theme.elevated || baseSurface; var tintedSurface = convertHexToRgba(baseSurface, Math.min(1, panelOpacity + 0.02)); var tintedElevated = convertHexToRgba(baseElevated, Math.min(1, panelOpacity + 0.08)); var tintedInput = convertHexToRgba(baseElevated, Math.min(1, panelOpacity + 0.12)); var tintedChip = convertHexToRgba(baseSurface, Math.min(1, panelOpacity + 0.14)); if (settings.gradientEnabled) { UI.host.setAttribute("data-gradient", "on"); } else { UI.host.removeAttribute("data-gradient"); } if (typeof UI.updateTransparencyDisplays === "function") { UI.updateTransparencyDisplays(); } var scope = settings.themeScope === "background" ? "background" : "full"; UI.host.setAttribute("data-theme-scope", scope); if (scope === "full") { hostStyle.setProperty("--surface", tintedSurface); hostStyle.setProperty("--elevated", tintedElevated); hostStyle.setProperty("--input-bg", tintedInput); hostStyle.setProperty("--chip-bg", tintedChip); } else { hostStyle.setProperty("--surface", baseSurface); hostStyle.setProperty("--elevated", baseElevated); hostStyle.setProperty("--input-bg", baseElevated); hostStyle.setProperty("--chip-bg", "rgba(255, 255, 255, 0.08)"); } } var toastTimeout; function showToast(UI, message, type) { type = type || "info"; clearTimeout(toastTimeout); var toast = UI.shadow.querySelector(".toast"); if (!toast) { toast = document.createElement("div"); toast.className = "toast"; UI.shadow.appendChild(toast); } toast.textContent = message; toast.className = "toast show " + type; toastTimeout = setTimeout(function () { toast.classList.remove("show"); }, 5000); } function getPanelHTML(site) { return ` <div class="panel-header"> <div class="panel-title">${site.title}</div> <div class="panel-actions"> <button class="header-btn copy-btn" title="Copy Question Text">${ICONS.COPY}</button> <button class="header-btn settings-btn" title="Settings">${ICONS.SETTINGS}</button> <button class="header-btn close-btn" title="Close">${ICONS.CLOSE}</button> </div> </div> <div class="panel-body"> <div class="chat-view"> <div class="chat-messages"></div> </div> <div class="settings-view"> <details class="settings-section" data-category="themes" open> <summary> <div class="summary-text"> <span class="summary-title">Themes & Colors</span> <span class="summary-caption">Organize every visual option</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content theme-section"> <div class="field-group"> <div class="field-label"> <span>Theme Library</span> <small>Select, edit, or remove saved themes.</small> </div> <div class="theme-list" id="theme-list"></div> </div> <div class="control-row"> <div class="control-label"> <span>Gradient Background</span> <small>Blend theme colors across the interface.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="gradient-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="control-row"> <div class="control-label"> <span>Theme Coverage</span> <small>Apply colors to the full UI or just the background.</small> </div> <div class="segmented-control" id="theme-scope-control"> <input type="radio" id="theme-scope-full" name="theme-scope" value="full" /> <label for="theme-scope-full">Entire UI</label> <input type="radio" id="theme-scope-background" name="theme-scope" value="background" /> <label for="theme-scope-background">Background only</label> </div> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Background Transparency</span> <div class="range-with-value"> <input type="range" id="background-transparency" min="0" max="100" step="5" /> <span class="range-value" id="background-transparency-value"></span> </div> </label> <label class="field-group"> <span class="field-label">Panel Transparency</span> <div class="range-with-value"> <input type="range" id="panel-transparency" min="0" max="100" step="5" /> <span class="range-value" id="panel-transparency-value"></span> </div> </label> </div> </div> </details> <details class="settings-section" data-category="profiles" open> <summary> <div class="summary-text"> <span class="summary-title">Prepend Profiles</span> <span class="summary-caption">Save and reuse your favorite prepends.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content profile-section"> <label class="field-group"> <span class="field-label">Saved Profiles</span> <select id="prepend-preset-select"></select> </label> <label class="field-group full"> <span class="field-label">Prepend Message</span> <textarea id="prepend-message-input" rows="4"></textarea> </label> <div class="field-grid"> <label class="field-group"> <span class="field-label">Profile Name</span> <input type="text" id="prepend-name-input" placeholder="New profile name" /> </label> <div class="field-actions"> <button type="button" class="btn primary" id="prepend-save-btn">Save as new</button> <button type="button" class="btn secondary" id="prepend-update-btn">Update selected</button> <button type="button" class="btn danger" id="prepend-delete-btn">Delete selected</button> </div> </div> </div> </details> <details class="settings-section" data-category="highlight" open> <summary> <div class="summary-text"> <span class="summary-title">Highlighting</span> <span class="summary-caption">Control how answers are emphasized.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content highlight-section"> <div class="toggle-row"> <div class="control-label"> <span>Highlight Answer</span> <small>Automatically spotlight detected answers.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-highlight-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Highlight Color</span> <input type="color" id="highlight-color" class="settings-input-color" /> </label> <label class="field-group"> <span class="field-label">Highlight Opacity</span> <input type="range" id="highlight-opacity" class="settings-input-range" min="0" max="1" step="0.05" /> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Rainbow Highlight</span> <small>Cycle through accent colors while highlighting.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="rainbow-highlight-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> </div> </details> <details class="settings-section" data-category="automation" open> <summary> <div class="summary-text"> <span class="summary-title">Automation & Timing</span> <span class="summary-caption">Control how hands-free the helper becomes.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content automation-section"> <div class="toggle-grid"> <div class="toggle-row"> <div class="control-label"> <span>Auto-Select Answer</span> <small>Click the detected answer choice automatically.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-select-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Submit</span> <small>Submit answers after the delay timer.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-submit-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Detect Questions</span> <small>Watch the page and resend on new questions.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-detect-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Fill-in-the-Blank</span> <small>Try to type answers into blank inputs.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="fill-in-blank-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> <div class="toggle-row"> <div class="control-label"> <span>Auto-Copy</span> <small>Copy formatted prompts to your clipboard.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-copy-toggle" /> <span class="slider"><span class="dot"></span></span> </label> </div> </div> <div class="field-pair"> <label class="field-group"> <span class="field-label">Selection Delay (seconds)</span> <input type="number" id="selection-delay" class="settings-input-short" min="0" max="10" step="1" /> </label> <label class="field-group"> <span class="field-label">Submit Delay (seconds)</span> <input type="number" id="submit-delay" class="settings-input-short" min="0" max="15" step="1" /> </label> </div> </div> </details> <details class="settings-section" data-category="interface" open> <summary> <div class="summary-text"> <span class="summary-title">Interface Visibility</span> <span class="summary-caption">Auto-hide and soften the side buttons.</span> </div> <span class="summary-icon"></span> </summary> <div class="section-content interface-section"> <div class="toggle-row"> <div class="control-label"> <span>Auto-Hide Side Buttons</span> <small>Hide the launcher and quick copy button while the panel is open.</small> </div> <label class="toggle-switch"> <input type="checkbox" id="auto-hide-side-buttons" /> <span class="slider"><span class="dot"></span></span> </label> </div> <label class="field-group"> <span class="field-label">Side Button Transparency</span> <div class="range-with-value"> <input type="range" id="side-button-transparency" min="0" max="80" step="5" /> <span class="range-value" id="side-button-transparency-value"></span> </div> </label> </div> </details> <p class="autosave-hint">Changes save automatically</p> <footer class="copyright">© <span id="copyright-year"></span> aidenwrld</footer> </div> </div> <div class="panel-footer"> <div class="image-preview"></div> <div class="chat-input-wrapper"> <button class="attach-btn" title="Attach Image">${ICONS.ATTACH}</button> <button class="screenshot-btn" title="Screenshot"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect><path d="M8 5l2-2h4l2 2"></path></svg></button> <input type="text" class="chat-input" placeholder="Ask a question..." /> <button class="send-btn" title="Send">${ICONS.SEND}</button> </div> </div> `; } function getCSS(settings, theme) { var gradientFrom = theme.gradientFrom || theme.bg; var gradientTo = theme.gradientTo || theme.elevated || theme.surface || theme.bg; var surfaces = computePanelSurfaces(theme, settings); var accentColor = theme.accent || "#00d4ff"; var accentHover = theme.accentHover || accentColor; var accentSoft = convertHexToRgba(accentColor, 0.25); var accentSoftBorder = convertHexToRgba(accentColor, 0.55); var accentContrast = getContrastColor(accentColor); var sideTransparency = clampTransparency(settings.sideButtonTransparency, defaultSettings.sideButtonTransparency); var sideOpacity = 1 - sideTransparency / 100; var safeSideOpacity = Math.max(0.2, Math.min(1, sideOpacity)); var floatingBg = convertHexToRgba(accentColor, safeSideOpacity); var floatingHoverBg = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.1)); var floatingBorder = convertHexToRgba(accentHover, Math.min(1, safeSideOpacity + 0.3)); var quickBase = theme.surface || theme.bg || gradientFrom; var quickBg = convertHexToRgba(quickBase, safeSideOpacity); var quickHoverBg = convertHexToRgba(theme.elevated || quickBase, Math.min(1, safeSideOpacity + 0.15)); var quickBorder = convertHexToRgba(theme.border || quickBase, Math.min(1, safeSideOpacity + 0.35)); var sideShadow = "0 14px 24px rgba(0, 0, 0, " + (0.35 * safeSideOpacity).toFixed(3) + ")"; var sideShadowHover = "0 18px 28px rgba(0, 0, 0, " + (0.45 * safeSideOpacity).toFixed(3) + ")"; var sideBackdrop = "blur(" + (4 + safeSideOpacity * 6).toFixed(1) + "px) saturate(120%)"; return ` :host { --bg: ${theme.bg}; --surface: ${theme.surface}; --elevated: ${theme.elevated}; --text: ${theme.text}; --subtext: ${theme.subtext}; --border: ${theme.border}; --accent: ${theme.accent}; --accent-hover: ${theme.accentHover}; --success: ${theme.success}; --error: ${theme.error}; --gradient-from: ${gradientFrom}; --gradient-to: ${gradientTo}; --solid-background: ${surfaces.solidBackground}; --gradient-background: ${surfaces.gradientBackground}; --panel-bg: ${surfaces.panelBg}; --panel-header-bg: ${surfaces.headerBg}; --panel-footer-bg: ${surfaces.footerBg}; --panel-border: ${surfaces.border}; --accent-soft: ${accentSoft}; --accent-soft-border: ${accentSoftBorder}; --accent-contrast: ${accentContrast}; --floating-btn-bg: ${floatingBg}; --floating-btn-hover-bg: ${floatingHoverBg}; --floating-btn-border: ${floatingBorder}; --floating-btn-color: ${accentContrast}; --quick-copy-btn-bg: ${quickBg}; --quick-copy-btn-hover-bg: ${quickHoverBg}; --quick-copy-btn-border: ${quickBorder}; --quick-copy-btn-color: ${theme.text}; --side-button-shadow: ${sideShadow}; --side-button-shadow-hover: ${sideShadowHover}; --side-button-backdrop: ${sideBackdrop}; --chip-bg: rgba(255, 255, 255, 0.08); --input-bg: var(--elevated); --scrollbar-thumb: rgba(255, 255, 255, 0.2); --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); } :host, :host * { box-sizing: border-box; font-family: var(--font-sans); } *:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; } ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 6px; } .floating-btn, .quick-copy-btn { position: fixed; z-index: 2147483647; pointer-events: auto; display: grid; place-items: center; border: none; box-shadow: var(--side-button-shadow); backdrop-filter: var(--side-button-backdrop); -webkit-backdrop-filter: var(--side-button-backdrop); cursor: grab; border-radius: 50%; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; } .floating-btn { width: 52px; height: 52px; background: var(--floating-btn-bg); color: var(--floating-btn-color); border: 1px solid var(--floating-btn-border); } .quick-copy-btn { width: 44px; height: 44px; background: var(--quick-copy-btn-bg); color: var(--quick-copy-btn-color); border: 1px solid var(--quick-copy-btn-border); z-index: 2147483646; cursor: pointer; } .floating-btn svg { width: 24px; height: 24px; } .quick-copy-btn svg { width: 20px; height: 20px; } .floating-btn:hover { transform: scale(1.1); background: var(--floating-btn-hover-bg); box-shadow: var(--side-button-shadow-hover); } .quick-copy-btn:hover { transform: scale(1.1); background: var(--quick-copy-btn-hover-bg); box-shadow: var(--side-button-shadow-hover); } .panel { position: fixed; z-index: 2147483645; width: 380px; height: 540px; background: var(--panel-bg); color: var(--text); border-radius: 16px; border: 1px solid var(--panel-border); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: top left; overflow: hidden; } .panel.settings-mode { overflow: visible; } .panel.open { opacity: 1; visibility: visible; pointer-events: auto; } .panel-header { display: flex; align-items: center; padding: 12px 8px 12px 16px; background: var(--panel-header-bg); border-bottom: 1px solid var(--panel-border); cursor: grab; gap: 8px; } .panel-title { font-weight: 600; font-size: 16px; margin-right: auto; } .panel-actions { display: flex; align-items: center; gap: 4px; } .header-btn { background: none; border: none; color: var(--subtext); width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; } .header-btn svg { width: 18px; height: 18px; } .header-btn:hover { background: var(--elevated); color: var(--text); } .panel-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; } .panel.settings-mode .panel-body { overflow: visible; } .chat-view { flex: 1; display: flex; flex-direction: column; min-height: 0; } .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; -webkit-overflow-scrolling: touch; } .chat-message { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; } .chat-message.user { align-items: flex-end; } .chat-message p { margin: 0; padding: 10px 14px; border-radius: 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; background: var(--elevated); border: 1px solid var(--panel-border); color: var(--text); } .chat-message.user p { background: var(--accent); border-color: transparent; color: #ffffff; } .chat-message.bot p { background: var(--elevated); border: 1px solid var(--panel-border); color: var(--text); } .chat-message img { max-width: 100%; max-height: 240px; border-radius: 12px; margin-bottom: 4px; object-fit: contain; } .panel-footer { background: var(--panel-footer-bg); border-top: 1px solid var(--panel-border); padding: 8px 16px 12px; display: flex; flex-direction: column; gap: 10px; } .image-preview { display: none; align-items: center; gap: 12px; padding: 8px 10px; border-radius: 12px; border: 1px dashed var(--panel-border); background: var(--elevated); } .image-preview img { max-height: 64px; border-radius: 8px; } .image-preview button { background: transparent; border: none; color: var(--text); font-size: 20px; cursor: pointer; } .chat-input-wrapper { display: flex; align-items: center; gap: 8px; } .chat-input { flex: 1; background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 14px; height: 42px; transition: border 0.2s ease, box-shadow 0.2s ease; } .chat-input::placeholder { color: var(--subtext); } .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15); } .attach-btn, .screenshot-btn, .send-btn { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--panel-border); background: var(--elevated); color: var(--text); display: grid; place-items: center; cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease; } .attach-btn svg, .screenshot-btn svg, .send-btn svg { width: 20px; height: 20px; } .attach-btn:hover, .screenshot-btn:hover, .send-btn:hover { background: var(--accent); border-color: var(--accent); color: #041019; transform: translateY(-1px); } .settings-view { display: none; padding: 18px 18px 22px; overflow-y: auto; gap: 14px; background: transparent; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch; } .panel.settings-mode .chat-view { display: none; } .panel.settings-mode .settings-view { display: flex; flex-direction: column; min-height: 0; } .panel.settings-mode .panel-footer { display: none; } .settings-section { position: relative; margin-bottom: 12px; border: 1px solid var(--panel-border); border-radius: 12px; background: var(--surface); overflow: visible; transition: border 0.2s ease, box-shadow 0.2s ease; } .settings-section summary { list-style: none; display: flex; align-items: center; justify-content: space-between; gap: 14px; padding: 14px 18px; cursor: pointer; background: transparent; transition: background 0.2s ease; border-radius: 12px; } .settings-section[open] summary { border-radius: 12px 12px 0 0; border-bottom: 1px solid var(--panel-border); } .settings-section summary::-webkit-details-marker { display: none; } .settings-section summary:hover { background: var(--elevated); } .summary-text { display: flex; flex-direction: column; gap: 2px; } .summary-title { font-size: 15px; font-weight: 600; color: var(--text); } .summary-caption { font-size: 12px; color: var(--subtext); opacity: 0.85; } .summary-icon { width: 12px; height: 12px; border-right: 2px solid var(--subtext); border-bottom: 2px solid var(--subtext); transform: rotate(45deg); transition: transform 0.2s ease; } .settings-section[open] .summary-icon { transform: rotate(225deg); } .settings-section .section-content { padding: 14px 16px 18px; display: flex; flex-direction: column; gap: 14px; border-radius: 0 0 12px 12px; background: var(--surface); border-top: 1px solid var(--panel-border); } .settings-section .info-card { padding: 14px; border-radius: 12px; border: 1px dashed var(--panel-border); background: color-mix(in srgb, var(--panel-bg) 85%, transparent); color: var(--subtext); line-height: 1.5; font-size: 13px; } .settings-section .info-card ul { margin: 8px 0 0; padding-left: 18px; display: flex; flex-direction: column; gap: 6px; } .field-group { display: flex; flex-direction: column; gap: 6px; } .field-group.full textarea { min-height: 140px; } .field-label { font-size: 13px; font-weight: 600; color: var(--subtext); } .field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: start; } .field-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; } .field-pair { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; } .range-with-value { display: flex; align-items: center; gap: 10px; } .range-with-value input[type="range"] { flex: 1; } .range-with-value .range-value { min-width: 40px; text-align: right; font-size: 12px; color: var(--subtext); } .control-row, .toggle-row { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding: 4px 0; } .control-label { display: flex; flex-direction: column; gap: 4px; max-width: 70%; } .control-label span { font-size: 14px; font-weight: 600; color: var(--text); } .control-label small { font-size: 12px; color: var(--subtext); opacity: 0.85; } .toggle-grid { display: flex; flex-direction: column; gap: 14px; } .theme-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; } .theme-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--panel-border); background: var(--elevated); transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease; } .theme-card.active { border-color: var(--accent); box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25); } .theme-card-main { flex: 1; display: flex; align-items: center; gap: 10px; background: transparent; border: none; color: var(--text); cursor: pointer; padding: 0; text-align: left; } .theme-card-main:hover { color: var(--accent); } .theme-chip { width: 34px; height: 34px; border-radius: 10px; border: 2px solid rgba(0, 0, 0, 0.15); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06); flex-shrink: 0; } .theme-card-name { font-weight: 600; font-size: 14px; } .theme-card-actions { display: flex; gap: 6px; } .icon-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--panel-border); background: var(--surface); color: var(--text); display: grid; place-items: center; cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease, color 0.2s ease; } .icon-btn svg { width: 16px; height: 16px; } .icon-btn:hover { transform: translateY(-1px); border-color: var(--accent); color: var(--accent); } .icon-btn.danger:hover { border-color: #ff4d4f; color: #ff8588; } .theme-card.create { justify-content: center; border: 1px dashed var(--panel-border); background: transparent; color: var(--accent); font-weight: 600; cursor: pointer; } .theme-card.create:hover { border-color: var(--accent); background: var(--elevated); } .theme-card.create span { display: inline-flex; align-items: center; gap: 8px; } .theme-card.create svg { width: 18px; height: 18px; } .segmented-control { display: inline-flex; align-items: stretch; gap: 4px; background: linear-gradient(135deg, var(--accent-soft), rgba(255, 255, 255, 0.03)); border-radius: 999px; padding: 4px; border: 1px solid var(--accent-soft-border); } .segmented-control input { display: none; } .segmented-control label { flex: 1; min-width: 0; padding: 8px 14px; border-radius: 999px; cursor: pointer; font-size: 13px; color: var(--subtext); background: rgba(255, 255, 255, 0.06); text-align: center; white-space: nowrap; transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; line-height: 1; } .segmented-control label:hover { background: rgba(255, 255, 255, 0.16); } .segmented-control label:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35), 0 0 0 4px rgba(0, 0, 0, 0.25); } .segmented-control input:checked + label { background: var(--accent); color: var(--accent-contrast, #06121e); box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25); transform: translateY(-1px); } .row { display: flex; align-items: center; gap: 12px; } .row.full-width { flex-direction: column; align-items: flex-start; } .row label { font-size: 13px; color: var(--subtext); flex: 1; } .control-stack { display: flex; align-items: center; gap: 8px; width: 100%; } .control-stack select { flex: 1; } .inline-actions { display: flex; align-items: center; gap: 6px; } .toggle { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding: 4px 0; } .toggle span { font-size: 14px; color: var(--text); } .toggle-switch { position: relative; display: inline-flex; align-items: center; width: 48px; height: 26px; } .toggle-switch input { opacity: 0; width: 0; height: 0; } .toggle-switch .slider { position: relative; width: 100%; height: 100%; border-radius: 999px; background: var(--surface); border: 1px solid var(--panel-border); transition: background 0.2s ease, border 0.2s ease; display: flex; align-items: center; padding: 3px; } .toggle-switch .slider .dot { width: 20px; height: 20px; border-radius: 50%; background: var(--subtext); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25); transition: transform 0.2s ease, background 0.2s ease; } .toggle-switch input:checked + .slider { background: var(--accent); border-color: var(--accent); } .toggle-switch input:checked + .slider .dot { transform: translateX(20px); background: #06121e; box-shadow: none; } .toggle-switch input:focus-visible + .slider { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15); } select, textarea, input[type="text"], input[type="number"] { width: 100%; background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 12px; font-size: 14px; transition: border 0.2s ease, box-shadow 0.2s ease; } select:focus, textarea:focus, input[type="text"]:focus, input[type="number"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25); outline: none; } textarea { min-height: 110px; resize: vertical; } .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; } .btn { padding: 8px 14px; border-radius: 10px; border: 1px solid var(--panel-border); background: var(--surface); color: var(--text); font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease; } .btn:hover { transform: translateY(-1px); } .btn.primary { background: var(--accent); border-color: var(--accent); color: #06121e; } .btn.secondary, .btn.outline { background: var(--elevated); border-color: var(--panel-border); } .btn.danger { border-color: #ff4d4f; color: #ff8c8f; background: rgba(255, 77, 79, 0.1); } .btn.danger:hover { background: #ff4d4f; color: #1a0404; } .modal-host { position: fixed; inset: 0; pointer-events: none; } .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.55); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; pointer-events: auto; z-index: 2147483647; } .modal { position: relative; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 18px; padding: 22px 24px; width: min(460px, 92vw); max-height: 84vh; overflow: auto; box-shadow: 0 22px 44px rgba(0, 0, 0, 0.45); } .modal h2 { margin: 0; font-size: 20px; color: var(--text); } .modal-close { position: absolute; top: 12px; right: 14px; background: transparent; border: none; font-size: 26px; color: var(--subtext); cursor: pointer; line-height: 1; } .modal-content { margin-top: 16px; display: flex; flex-direction: column; gap: 18px; } .form-group { display: flex; flex-direction: column; gap: 8px; } .form-group label { font-size: 13px; color: var(--subtext); } .form-group input { background: var(--input-bg); color: var(--text); border: 1px solid var(--panel-border); border-radius: 10px; padding: 10px 12px; } .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 14px; } .theme-preview { display: flex; flex-direction: column; gap: 12px; padding: 16px; border: 1px solid var(--panel-border); border-radius: 14px; background: var(--surface); } .theme-preview .preview-shell { border-radius: 14px; overflow: hidden; border: 1px solid var(--panel-border); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25); transition: background 0.3s ease, border 0.3s ease; } .theme-preview .preview-topbar { padding: 10px 14px; font-weight: 600; font-size: 13px; } .theme-preview .preview-body { padding: 14px; display: flex; flex-direction: column; gap: 8px; min-height: 90px; } .theme-preview .bubble { border-radius: 10px; padding: 8px 12px; font-size: 12px; color: inherit; opacity: 0.9; } .theme-preview .bubble.user { align-self: flex-end; font-weight: 600; } .theme-preview .bubble.bot { align-self: flex-start; } .theme-preview[data-scope="background"] .preview-topbar { opacity: 0.85; } .modal-field { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--subtext); } .modal-field input[type="color"] { width: 100%; height: 44px; border-radius: 10px; border: 1px solid var(--panel-border); background: transparent; cursor: pointer; padding: 0; } .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 6px; } .autosave-hint { text-align: center; font-size: 12px; color: var(--subtext); margin-top: 4px; } .copyright { font-size: 12px; color: var(--subtext); margin-top: 6px; text-align: center; } :host([data-gradient="on"]) { --panel-bg: var(--gradient-background); } .toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 150%); background: var(--elevated); color: var(--text); padding: 14px 22px; border-radius: 12px; border: 1px solid var(--panel-border); box-shadow: var(--shadow-lg); opacity: 0; transition: all 0.4s cubic-bezier(0.2, 1, 0.2, 1); z-index: 2147483647; max-width: 80%; text-align: center; pointer-events: auto; } .toast.show { opacity: 1; transform: translate(-50%, 0); } .toast.success { background: var(--success); color: #ffffff; border-color: transparent; } .toast.error { background: var(--error); color: #ffffff; border-color: transparent; } .toast.info { background: var(--elevated); color: var(--text); } :host([data-theme-scope="background"]) { --panel-bg: var(--surface); --panel-header-bg: var(--surface); --panel-footer-bg: var(--surface); --panel-border: var(--border); } @media (max-width: 520px) { .panel { width: calc(100vw - 32px); height: min(560px, calc(100vh - 32px)); } } `; } try { main(); } catch (e) { console.error((ACTIVE_SITE && ACTIVE_SITE.title ? ACTIVE_SITE.title : 'IXL Helper') + ' failed to initialize:', e); } })();
